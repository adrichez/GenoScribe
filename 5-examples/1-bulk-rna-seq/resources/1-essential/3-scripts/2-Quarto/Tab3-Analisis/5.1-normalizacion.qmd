---
title: "RNA-Seq Report"

include-in-header:
  text: |
    <link rel="shortcut icon" href="../../../1-images/0-icono/favicon.svg"/>
    <link rel="icon" type="image/x-icon" href="../../../1-images/0-icono/favicon.ico">

params:
  ruta_proyecto: ""
  nombre_experimento: ""
---


<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->
<!--  TAB 3: ANLISIS | 5.1. NORMALIZACIN DE LOS DATOS DE EXPRESIN -->
<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->

```{r}
library(stringr)
library(glue)
library(fs)
library(dplyr)

# Definir rutas clave
ruta_qmd <- getwd()

ruta_rnaseq_pipeline <- sub("(.*?/1-bulk-rna-seq).*", "\\1", ruta_qmd)

nombre_proyecto <- basename(params$ruta_proyecto)

ruta_nextflow_results <- file.path("..", "..", "..", "..", "..", "resources", "2-nextflow-results")
ruta_proyecto_relativa <- file.path("..", "..", "..", "..", "..", "resources", "2-nextflow-results", "1-project-data", nombre_proyecto)


experimento_RPKM <- paste0(params$nombre_experimento, "_RPKM.xls")
ruta_experimento_RPKM <- file.path(params$ruta_proyecto, "Resultados", params$nombre_experimento, experimento_RPKM)
ruta_experimento_RPKM_relativa <- file.path(ruta_proyecto_relativa, "Resultados", params$nombre_experimento, experimento_RPKM)

# Definir ruta de salida para el archivo TXT
ruta_experimento_RPKM_txt <- file.path(ruta_nextflow_results, "3-analisis-estadistico", paste0(params$nombre_experimento, "_RPKM.txt"))
experimento_RPKM_txt <- basename(ruta_experimento_RPKM_txt)
```


<div class="informe-titulo-tab">
  <h1>Pesta帽a</h1>
  <h2>An谩lisis bioinform谩tico completo</h2>
</div>

<div class="informe-titulo-seccion">
  <h1>Secci贸n 5</h1>
  <h2>An谩lisis estad铆stico de la expresi贸n g茅nica</h2>
</div>

<div class="informe-titulo-subseccion">
  <h1>Subsecci贸n 5.1</h1>
  <h2>Normalizaci贸n de los datos de expresi贸n</h2>
</div>


<div class="informe-resumen">
  <h2>Resumen</h2>

  <p>
    En esta secci贸n se lleva a cabo la <strong>normalizaci贸n de los datos de expresi贸n g茅nica</strong>, un paso esencial para garantizar la <em>comparabilidad entre muestras</em> y minimizar sesgos t茅cnicos derivados del <em>tama帽o de las bibliotecas de secuenciaci贸n</em> o de la <em>longitud de los genes</em>. Se transforma la matriz de recuentos crudos en medidas normalizadas, como <strong>RPKM (Reads Per Kilobase per Million)</strong>, que permiten interpretar los niveles de expresi贸n de forma m谩s robusta y comparable entre genes y muestras.
  </p>

  <p>
    A lo largo del an谩lisis, se <strong>visualiza la matriz normalizada</strong> y se eval煤an m茅tricas clave como el <em>total de expresi贸n por muestra</em> o el <em>n煤mero de genes expresados</em>, permitiendo detectar posibles <strong>anomal铆as o desviaciones</strong> tras la transformaci贸n. Tambi茅n se identifican los genes con mayor expresi贸n global y se estudia la <em>distribuci贸n de expresi贸n</em> a trav茅s de diagramas de caja, compar谩ndola con los datos originales para valorar el efecto de la normalizaci贸n.
  </p>

  <p>
    Esta fase prepara el terreno para los an谩lisis posteriores, donde se requerir谩 que los datos est茅n correctamente ajustados para aplicar <strong>modelos estad铆sticos fiables</strong>. La normalizaci贸n, por tanto, constituye un paso fundamental previo a la <em>evaluaci贸n de la calidad post-normalizaci贸n</em> y a los an谩lisis de <strong>expresi贸n diferencial</strong> y <strong>enriquecimiento funcional</strong>, claves para extraer conocimiento biol贸gico relevante a partir del perfil transcript贸mico estudiado.
  </p>
</div>











<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo-toc">
  Tabla de contenidos de esta subsecci贸n
</div>

<div class="toc">
  <ul>
    <li>
      <a href="5-Analisis-estadistico.html#tab3-seccion5">
        5<span>.</span> An谩lisis estad铆stico de la expresi贸n g茅nica
      </a>
      <ul>
        <li>
          <a href="#tab3-seccion5.1">
            5.1. Normalizaci贸n de los datos de expresi贸n
          </a>
          <ul>
            <li>
              <a href="#tab3-seccion5.1.1">
                5.1.1. Visualizaci贸n de la matriz de expresi贸n normalizada
              </a>
            </li>
            <li>
              <a href="#tab3-seccion5.1.2">
                5.1.2. Total de expresi贸n por muestra (RPKM)
              </a>
            </li>
            <li>
              <a href="#tab3-seccion5.1.3">
                5.1.3. N煤mero de genes expresados por muestra (RPKM)
              </a>
            </li>
            <li>
              <a href="#tab3-seccion5.1.4">
                5.1.4. Genes con mayor expresi贸n total (RPKM)
              </a>
            </li>
            <li>
              <a href="#tab3-seccion5.1.5">
                5.1.5. Distribuci贸n de expresi贸n por muestra (boxplot log10 RPKM)
              </a>
            </li>
            <li>
              <a href="#tab3-seccion5.1.6">
                5.1.6. Comparaci贸n entre recuentos crudos y datos normalizados
              </a>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</div>










<!-- #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->
<!-- REDACCIN -->
<!-- #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->

<div style="height: 20px; background-color: transparent;"></div>

<div class="titulo2" id="tab3-seccion5.1">
  5.1. Normalizaci贸n de los datos de expresi贸n
</div>

<p>
  La cuantificaci贸n inicial de la expresi贸n g茅nica genera una matriz de recuentos crudos, en la que cada valor representa el n煤mero de lecturas que se alinean a un gen espec铆fico en una muestra determinada. No obstante, estos valores pueden estar influenciados por factores t茅cnicos no biol贸gicos, como la profundidad de secuenciaci贸n o la longitud de los genes, lo que dificulta la comparaci贸n directa entre muestras o genes.
</p>

<p>
  Para mitigar estas fuentes de sesgo y facilitar comparaciones significativas, se ha aplicado un proceso de normalizaci贸n. En este an谩lisis, se ha empleado el m茅todo <strong>RPKM</strong> (Reads Per Kilobase of transcript per Million mapped reads), el cual ajusta los recuentos teniendo en cuenta tanto la longitud del gen como el n煤mero total de lecturas mapeadas por muestra.
</p>

<p>
  El resultado de esta transformaci贸n es una matriz de expresi贸n normalizada que permite comparar niveles de expresi贸n relativos de manera m谩s robusta entre genes y entre condiciones experimentales.
</p>

```{r, echo=FALSE, results="asis"}
cat(glue::glue('
<p>
  La matriz RPKM utilizada en este proyecto viene dada por el nombre <code>{experimento_RPKM}</code> y en el momento de la generaci贸n de este informe se encuentra en el siguiente directorio:
</p>

<code>{ruta_experimento_RPKM}</code>
\n\n'))
```

<p> 
  A continuaci贸n, se muestra esta matriz junto con un conjunto de visualizaciones que permiten explorar las caracter铆sticas globales de los datos normalizados y compararlas con los patrones observados en los recuentos crudos presentados en la secci贸n anterior.
</p> 






<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo3" id="tab3-seccion5.1.1">
  5.1.1. Visualizaci贸n de la matriz de expresi贸n normalizada
</div>

<p>
  A continuaci贸n, se presenta una vista interactiva de la matriz de expresi贸n g茅nica normalizada, obtenida a partir del archivo <code>exp3_RPKM.xls</code>. 
  Esta matriz contiene valores transformados seg煤n el m茅todo RPKM, lo que permite una comparaci贸n m谩s equitativa de los niveles de expresi贸n g茅nica entre 
  diferentes muestras y genes, corrigiendo posibles sesgos t茅cnicos asociados al tama帽o de los genes o a la profundidad de secuenciaci贸n.
</p>

<p>
  La tabla interactiva mostrada a continuaci贸n permite explorar en detalle los valores de expresi贸n normalizada. Se puede <strong>buscar un gen espec铆fico</strong> 
  utilizando el cuadro de b煤squeda, as铆 como <strong>ordenar las columnas</strong> para identificar r谩pidamente genes con altos o bajos niveles de expresi贸n 
  en cada muestra.
</p>

```{r}
# Leer el archivo y mostrar tabla interactiva
if (file.exists(ruta_experimento_RPKM)) {
  # Leer la matriz de RPKM
  matriz_RPKM <- read.table(ruta_experimento_RPKM, header = TRUE, fill = TRUE, stringsAsFactors = FALSE)
  rownames(matriz_RPKM) <- matriz_RPKM[[1]]
  matriz_RPKM <- matriz_RPKM[, -1]
  
  # Tabla interactiva de metadatos
  library(DT)
  htmltools::div(
    class = "scroll-y-max-500",
    DT::datatable(
      matriz_RPKM,
      options = list(
        scrollX = TRUE,
        paging = FALSE,
        lengthChange = FALSE,
        language = list(
          url = '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
        )
      ),
      class = 'stripe hover compact'
    )
  )
  
} else {
  cat(glue::glue('
  cat("Archivo "{experimento_RPKM}" no encontrado. Verifica la ruta.")
  \n\n'))
}
```

<div style="height: 15px; background-color: transparent;"></div>

<p>
  Esta visualizaci贸n resulta especialmente 煤til para detectar posibles patrones globales de expresi贸n, validar muestras at铆picas o verificar la correcta distribuci贸n de los valores normalizados antes de proceder al an谩lisis estad铆stico de expresi贸n diferencial.
</p>

<p>
  Si desea consultar el archivo completo, puede hacerlo directamente desde el visor incrustado justo debajo o abrirlo en una nueva pesta帽a.
</p>

```{r, results='asis'}
cat(glue::glue('
<iframe src="{ruta_experimento_RPKM_txt}" width="100%" height="500px" style="border: 1px solid #ccc; border-radius: 6px;"></iframe>

<p style="text-align:center;">
  <a href="{ruta_experimento_RPKM_txt}" target="_blank" class="boton-iframe">
     Ver matriz normalizada en una nueva p谩gina
  </a>
</p>

<div style="height: 15px; background-color: transparent;"></div>
\n\n'))
```






<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo3" id="tab3-seccion5.1.2">
  5.1.2. Total de expresi贸n por muestra (RPKM)
</div>

<p>
  Para continuar con la exploraci贸n de los datos normalizados, se calcula el total de expresi贸n por muestra sumando los valores de RPKM correspondientes a todos los genes. Este valor refleja la cantidad global de expresi贸n g茅nica detectada en cada muestra tras la correcci贸n por longitud g茅nica y profundidad de secuenciaci贸n.
</p>

<p>
  A continuaci贸n, se presenta una tabla con los totales de expresi贸n normalizada por muestra, seguida de una representaci贸n gr谩fica interactiva en forma de barras. Esta visualizaci贸n facilita la comparaci贸n del nivel global de expresi贸n entre las distintas condiciones y r茅plicas del experimento.
</p>

```{r}
library(DT)
library(ggplot2)
library(plotly)
library(dplyr)
library(stringr)
library(scales)
library(tidyverse)
library(tidyr)
library(tibble)

# Calcular n煤mero total de lecturas asignadas por muestra
total_recuentos_por_muestra <- colSums(matriz_RPKM)

total_recuentos_por_muestra_df <- data.frame(
  Muestra = names(total_recuentos_por_muestra),
  TotalRecuentos = as.integer(total_recuentos_por_muestra)
)


# Convertir a data frame para ggplot2
df_total <- data.frame(
  muestra = names(total_recuentos_por_muestra),
  total_lecturas = as.integer(total_recuentos_por_muestra)
)

# Asegurarnos que 'targets' est谩 cargado previamente
targets_experimento <- paste0("targets_", params$nombre_experimento, ".txt")
ruta_targets_experimento <- file.path(params$ruta_proyecto, "Resultados", targets_experimento)
targets <- read.table(ruta_targets_experimento, header = TRUE, fill = TRUE, stringsAsFactors = FALSE)

# Limpiar y unir condici贸n
df_total$muestra <- str_remove(df_total$muestra, "_nat$")
df_total <- df_total %>%
  left_join(targets %>% select(Filename, Type), by = c("muestra" = "Filename")) %>%
  rename(condicion = Type) %>%
  select(muestra, condicion, total_lecturas) %>%
  arrange(desc(total_lecturas))


# Mostrar tabla interactiva con DT
htmltools::div(
  class = "scroll-y-max-500",
  DT::datatable(
    df_total,
    options = list(
      scrollX = TRUE,
      paging = FALSE,
      lengthChange = FALSE,
      language = list(
        url = '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
      )
    ),
    class = 'stripe hover compact',
  )
)
```

<div style="height: 20px; background-color: transparent;"></div>

<div class="plot-center">

```{r}
# Gr谩fico de n煤mero total de lecturas por muestra con plotly
plot_ly(
  data = df_total,
  x = ~muestra,
  y = ~total_lecturas,
  type = "bar",
  color = ~condicion,
  colors = "Set2",
  text = ~comma(total_lecturas),
  textposition = "outside",
  hoverinfo = "text",
  hovertext = ~paste0("Muestra: ", muestra, "<br>Lecturas: ", comma(total_lecturas))
) %>%
  layout(
    title = "Total de lecturas por muestra",
    xaxis = list(title = "Muestra", tickangle = -45, tickfont = list(size = 10)),
    yaxis = list(
      title = "N煤mero de lecturas",
      range = c(0, max(df_total$total_lecturas) * 1.15)
    ),
    legend = list(
      orientation = "h",
      x = 0.5,
      y = -0.5,
      xanchor = "center"
    ),
    margin = list(t = 100, b = 170),
    autosize = TRUE
  )
```

</div>






<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo3" id="tab3-seccion5.1.3">
  5.1.3. N煤mero de genes expresados por muestra (RPKM)
</div>

<p>
  Una vez evaluado el total de expresi贸n global por muestra, el siguiente paso consiste en determinar cu谩ntos genes se consideran expresados en cada una de ellas tras la normalizaci贸n mediante RPKM. Para este an谩lisis, se considera que un gen est谩 expresado en una muestra si su valor de RPKM es mayor que cero.
</p>

<p>
  Esta m茅trica resulta 煤til para detectar muestras con baja complejidad transcript贸mica o posibles fallos t茅cnicos, ya que un n煤mero reducido de genes expresados podr铆a ser indicativo de una extracci贸n deficiente de RNA, contaminaci贸n o errores durante la secuenciaci贸n o cuantificaci贸n.
</p>

<p>
  A continuaci贸n se muestra una tabla con el n煤mero de genes expresados por muestra seg煤n el criterio anterior, seguida de una visualizaci贸n en forma de gr谩fico que permite comparar f谩cilmente este indicador entre condiciones biol贸gicas y r茅plicas.
</p>

```{r}
# Calcular n煤mero de genes expresados por muestra (genes con recuentos > 0)
genes_expresados_por_muestra <- colSums(matriz_RPKM > 0)

genes_expresados_por_muestra_df <- data.frame(
  Muestra = names(genes_expresados_por_muestra),
  GenesExpresados = as.integer(genes_expresados_por_muestra)
)


# Crear data frame
df_genes_exp <- data.frame(
  muestra = names(genes_expresados_por_muestra),
  genes_expresados = as.integer(genes_expresados_por_muestra)
)

# A帽adir la columna 'condicion' uniendo por el nombre de muestra
df_genes_exp$muestra <- str_remove(df_genes_exp$muestra, "_nat$")
df_genes_exp <- df_genes_exp %>%
  left_join(targets %>% select(Filename, Type), by = c("muestra" = "Filename")) %>%
  rename(condicion = Type) %>%
  select(muestra, condicion, genes_expresados) %>%
  arrange(desc(genes_expresados))


# Crear la tabla interactiva
htmltools::div(
  class = "scroll-y-max-500",
  DT::datatable(
    df_genes_exp,
    options = list(
      scrollX = TRUE,
      paging = FALSE,
      lengthChange = FALSE,
      language = list(
        url = '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
      )
    ),
    class = 'stripe hover compact',
  )
)
```

<div style="height: 20px; background-color: transparent;"></div>

<div class="plot-center">

```{r}
# Gr谩fico: genes expresados por muestra (>0) con plotly
plot_ly(
  data = df_genes_exp,
  x = ~muestra,
  y = ~genes_expresados,
  type = "bar",
  color = ~condicion,
  colors = "Set2",  # mismo estilo que ggplot (Set1)
  text = ~comma(genes_expresados),
  textposition = "outside",
  hoverinfo = "text",
  hovertext = ~paste0("Muestra: ", muestra, "<br>Genes expresados: ", comma(genes_expresados))
) %>%
  layout(
    title = "N煤mero de genes expresados por muestra",
    xaxis = list(
      title = "Muestra",
      tickangle = -45,
      tickfont = list(size = 10)
    ),
    yaxis = list(
      title = "Genes con recuentos > 0",
      range = c(0, max(df_genes_exp$genes_expresados) * 1.15),
      separatethousands = TRUE
    ),
    legend = list(
      orientation = "h",
      x = 0.5,
      y = -0.52,
      xanchor = "center"
    ),
    margin = list(t = 100, b = 170),
    autosize = TRUE
  )
```

</div>






<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo3" id="tab3-seccion5.1.4">
  5.1.4. Genes con mayor expresi贸n total (RPKM)
</div>

<p>
  Para identificar los genes con mayor nivel de expresi贸n dentro del conjunto de datos normalizados, se calcula la suma total de valores RPKM por gen a lo largo de todas las muestras. Esta m茅trica permite detectar aquellos genes cuya actividad transcripcional es m谩s elevada de forma global tras corregir por longitud g茅nica y profundidad de secuenciaci贸n.
</p>

<p>
  Este an谩lisis resulta 煤til para destacar genes altamente expresados que podr铆an desempe帽ar funciones clave en el contexto experimental, o bien reflejar la expresi贸n constitutiva de genes de mantenimiento (housekeeping).
</p>

<p>
  A continuaci贸n se presentan los genes ordenados de forma descendente seg煤n su expresi贸n acumulada en RPKM. La tabla est谩 acompa帽ada por una visualizaci贸n interactiva que muestra los 20 genes con mayor expresi贸n, permitiendo valorar su contribuci贸n relativa dentro del conjunto de datos.
</p>

```{r}
# Obtener los genes con mayor nivel de expresi贸n total (suma por fila)
top_genes<- rowSums(matriz_RPKM) |>
  sort(decreasing = TRUE)

top_genes_df <- data.frame(
  Gen = names(top_genes),
  TotalRecuentos = as.integer(top_genes)
)

top_genes_20 <- rowSums(matriz_RPKM) |>
  sort(decreasing = TRUE) |>
  head(20)

top_genes_20_df <- data.frame(
  Gen = names(top_genes_20),
  TotalRecuentos = as.integer(top_genes_20)
)


# Crear la tabla interactiva
htmltools::div(
  class = "scroll-y-max-500",
  DT::datatable(
    top_genes_df,
    options = list(
      scrollX = TRUE,
      paging = FALSE,
      lengthChange = FALSE,
      language = list(
        url = '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
      )
    ),
    class = 'stripe hover compact',
  )
)
```

<div style="height: 15px; background-color: transparent;"></div>

<div class="plot-center">

```{r}
# Ordenar los genes de forma descendente para el gr谩fico
top_genes_20_df$Gen <- factor(top_genes_20_df$Gen, levels = rev(top_genes_20_df$Gen))

# Gr谩fico: top 20 genes m谩s expresados con plotly (horizontal)
plot_ly(
  data = top_genes_20_df,
  x = ~TotalRecuentos,
  y = ~Gen,
  type = "bar",
  orientation = "h",
  marker = list(
    color = "#098",
    line = list(color = "black", width = 1)
  ),
  text = ~comma(TotalRecuentos),
  textposition = "outside",
  hoverinfo = "text",
  hovertext = ~paste0("Gen: ", Gen, "<br>Recuentos: ", comma(TotalRecuentos))
) %>%
  layout(
    title = "Top 20 genes m谩s expresados",
    xaxis = list(
      title = "Recuentos totales",
      range = c(0, max(top_genes_20_df$TotalRecuentos) * 1.2),
      separatethousands = TRUE
    ),
    yaxis = list(
      title = "Gen",
      automargin = TRUE,
      tickfont = list(size = 10)
    ),
    margin = list(l = 100, t = 80, r = 40),
    autosize = TRUE
  )
```

</div>






<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo3" id="tab3-seccion5.1.5">
  5.1.5. Distribuci贸n de expresi贸n por muestra (boxplot log10 RPKM)
</div>

<p>
  Para evaluar la variabilidad de los niveles de expresi贸n normalizados entre muestras, se genera un gr谩fico de cajas (<em>boxplot</em>) 
  basado en la transformaci贸n logar铆tmica (log<sub>10</sub>) de los valores RPKM. Esta transformaci贸n permite representar la distribuci贸n de los datos 
  de manera m谩s adecuada, suavizando el efecto de valores extremadamente altos y resaltando diferencias sutiles entre condiciones.
</p>

<p>
  Los valores RPKM iguales a cero se excluyen previamente para evitar problemas con la escala logar铆tmica. 
  Esta visualizaci贸n resulta especialmente 煤til para verificar la homogeneidad entre r茅plicas, detectar valores at铆picos 
  y evaluar si las muestras presentan perfiles de expresi贸n comparables tras la normalizaci贸n.
</p>

<p>
  A continuaci贸n, se presenta el boxplot interactivo correspondiente a todas las muestras del experimento.
</p>

<div style="height: 8px; background-color: transparent;"></div>

```{r}
# Convertir a formato largo
matriz_RPKM_long <- matriz_RPKM |>
  rownames_to_column("gene") |>
  pivot_longer(-gene, names_to = "muestra", values_to = "recuento")

# Filtrar recuentos mayores que cero antes de graficar
matriz_RPKM_long_filtrado <- matriz_RPKM_long |>
  filter(recuento > 0)


# Hacer el left join con targets para a帽adir la columna 'Type' como 'condicion'
matriz_RPKM_long_filtrado <- matriz_RPKM_long_filtrado %>%
  mutate(muestra_clean = str_remove(muestra, "_nat$")) %>%
  select(-muestra) %>%
  rename(muestra = muestra_clean) %>%
  left_join(targets %>% select(Filename, Type), by = c("muestra" = "Filename")) %>%
  rename(condicion = Type)
```

<div class="plot-center">

```{r}
# Gr谩fico: distribuci贸n logar铆tmica de recuentos por muestra (boxplot)
plot_ly(
  data = matriz_RPKM_long_filtrado,
  x = ~muestra,
  y = ~recuento,
  color = ~condicion,
  colors = "Set2",
  type = "box",
  boxpoints = "outliers",
  marker = list(size = 3, opacity = 0.5, line = list(width = 0)),
  line = list(color = "black"),
  opacity = 0.8
) %>%
  layout(
    title = list(
      text = "Distribuci贸n logar铆tmica de recuentos por muestra<br><sub>Cada boxplot representa los niveles de expresi贸n g茅nica (log10) por muestra</sub>",
      y = 0.95
    ),
    xaxis = list(
      title = "Muestra",
      tickangle = -45,
      tickfont = list(size = 10)
    ),
    yaxis = list(
      title = "Recuento (log10)",
      type = "log",
      separatethousands = TRUE
    ),
    legend = list(
      orientation = "h",
      x = 0.5,
      y = -0.52,
      xanchor = "center"
    ),
    margin = list(t = 100, b = 170),
    autosize = TRUE
  )
```

</div>






<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo3" id="tab3-seccion5.1.6">
  5.1.6. Comparaci贸n entre recuentos crudos y datos normalizados
</div>

<p>
  En el an谩lisis de datos de expresi贸n g茅nica, la normalizaci贸n es un paso cr铆tico que busca corregir sesgos t茅cnicos derivados de variaciones en la profundidad de secuenciaci贸n, tama帽o de los genes y otros factores experimentales. 
  Aunque la normalizaci贸n tiene como objetivo hacer que los datos sean comparables entre muestras, es fundamental evaluar c贸mo este proceso afecta a la distribuci贸n y la relaci贸n entre los valores originales (recuentos crudos) y los ajustados (normalizados).
</p>

<p>
  Esta comparaci贸n nos permite verificar dos aspectos importantes: primero, que la normalizaci贸n efectivamente reduzca las diferencias t茅cnicas no biol贸gicas que podr铆an sesgar los resultados; y segundo, que preserve la estructura biol贸gica y las diferencias genuinas en la expresi贸n g茅nica.
</p>

<p>
  Es importante destacar que la matriz normalizada puede contener un n煤mero menor o igual de genes que la matriz inicial de conteos, debido a que durante el proceso de normalizaci贸n o preprocesamiento se suelen filtrar genes con baja expresi贸n o sin anotaci贸n adecuada para asegurar la calidad del an谩lisis.
</p>

<p>
  Para explorar y evaluar esta comparaci贸n, se presentan a continuaci贸n tres tipos de visualizaciones complementarias que nos permiten entender mejor c贸mo var铆an los datos antes y despu茅s de la normalizaci贸n:
</p>

<ul>
  <li><strong>Boxplots comparativos:</strong> muestran la distribuci贸n logar铆tmica (log<sub>10</sub>) de los valores crudos y normalizados, agrupados por muestra, para visualizar la homogeneizaci贸n y reducci贸n de la dispersi贸n tras la normalizaci贸n.</li>
  <li><strong>Scatterplots por muestra:</strong> comparan, en escala logar铆tmica, los valores crudos frente a los normalizados por gen en muestras seleccionadas, revelando la relaci贸n directa y la consistencia entre ambas mediciones.</li>
  <li><strong>Gr谩fico de barras de correlaci贸n:</strong> presenta la correlaci贸n de Pearson entre los recuentos crudos y los valores normalizados para cada muestra, proporcionando una m茅trica cuantitativa de concordancia entre ambos conjuntos de datos.</li>
</ul>

<p>
  A continuaci贸n se detallan cada una de estas visualizaciones, explicando su interpretaci贸n y utilidad para el an谩lisis de expresi贸n g茅nica.
</p>

<div style="height: 8px; background-color: transparent;"></div>

<div class="plot-center">

```{r, results='asis'}
# Asegurarse de que las matrices de recuentos crudos y RPKM est谩n disponibles
his_ReadCount_ruta <- file.path(params$ruta_proyecto, "Analisis", params$nombre_experimento, "Readcount_results", "his-ReadCount.tab")
counts_raw <- read.delim(his_ReadCount_ruta, row.names = 1)

ruta_experimento_RPKM <- file.path(params$ruta_proyecto, "Resultados", params$nombre_experimento, experimento_RPKM)
counts_rpkm <- read.table(ruta_experimento_RPKM, header = TRUE, fill = TRUE, stringsAsFactors = FALSE)
rownames(counts_rpkm) <- counts_rpkm[[1]]
counts_rpkm <- counts_rpkm[, -1]


# Asegurarse de que las columnas de recuentos crudos y RPKM coinciden
colnames(counts_raw) <- gsub("_nat$", "", colnames(counts_raw))
  
  
# Prepara data en formato largo y limpia el nombre de muestra
df_raw <- counts_raw %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  pivot_longer(-gene, names_to = "sample", values_to = "value") %>%
  mutate(type = "Crudo")

df_rpkm <- counts_rpkm %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  pivot_longer(-gene, names_to = "sample", values_to = "value") %>%
  mutate(type = "RPKM")


# Combina y filtra ceros para log10
df_combined <- bind_rows(df_raw, df_rpkm) %>%
  filter(value > 0) %>%
  mutate(log_value = log10(value))


# Convertir el factor para asegurar orden y color consistente
df_combined <- df_combined %>%
  mutate(
    sample = factor(sample, levels = unique(sample)),
    type = factor(type)
  )

plot_ly(df_combined, x = ~sample, y = ~log_value, color = ~type, colors = "Set2", type = "box") %>%
  layout(
    title = "Distribuci贸n log10(Expresi贸n) por muestra y tipo de dato",
    xaxis = list(title = "Muestra", tickangle = -45),
    yaxis = list(title = "log10(Expresi贸n)"),
    legend = list(title = list(text = "<b>Tipo de dato</b>")),
    boxmode = "group"
  )
```

</div>

<div style="height: 5px; background-color: transparent;"></div>

<p>
  <strong>Distribuci贸n de los valores por muestra (boxplot log<sub>10</sub>):</strong>  
  El gr谩fico de cajas muestra la distribuci贸n de los recuentos de expresi贸n para cada muestra, aplicando una transformaci贸n logar铆tmica (log<sub>10</sub>) para mejorar la visualizaci贸n y homogeneizar la escala.
  Se presentan lado a lado los datos crudos y normalizados, lo que permite comparar la variabilidad y dispersi贸n entre ambos conjuntos.
  En general, se observa que la normalizaci贸n reduce la variabilidad extrema y alinea mejor las distribuciones entre muestras, facilitando comparaciones posteriores y minimizando el sesgo t茅cnico derivado de diferencias en profundidad de secuenciaci贸n o longitud g茅nica.
</p>

<div style="height: 8px; background-color: transparent;"></div>

<div class="plot-center">

```{r, results='asis'}
# Obtener genes comunes entre ambas matrices
genes_comunes <- intersect(rownames(counts_raw), rownames(counts_rpkm))

# Subconjuntos alineados por gene
raw_mat <- counts_raw[genes_comunes, ]
rpkm_mat <- counts_rpkm[genes_comunes, ]

# Seleccionar una muestra
sample_to_plot <- colnames(raw_mat)[1]

# Crear el data frame para el scatter plot incluyendo el nombre del gen
df_scatter <- tibble(
  gene = genes_comunes,
  log_raw = log10(raw_mat[[sample_to_plot]] + 1),
  log_rpkm = log10(rpkm_mat[[sample_to_plot]] + 1)
)


# Rango para la l铆nea de identidad (y = x)
rango <- range(c(df_scatter$log_raw, df_scatter$log_rpkm))

# Visualizaci贸n interactiva con plotly
plot_ly() %>%
  add_trace(
    data = df_scatter,
    x = ~log_raw,
    y = ~log_rpkm,
    type = 'scatter',
    mode = 'markers',
    text = ~paste("Gen:", gene),
    marker = list(
      size = 5,
      opacity = 0.8,
      color = 'rgba(100, 149, 237, 0.6)'
    ),
    name = "Genes"
  ) %>%
  add_lines(
    x = rango,
    y = rango,
    line = list(color = "red", dash = "dash"),
    showlegend = FALSE,
    inherit = FALSE  # Muy importante para evitar heredar el `df_scatter`
  ) %>%
  layout(
    title = list(
      text = glue("Recuentos crudos vs RPKM ({sample_to_plot})"),
      x = 0.5
    ),
    xaxis = list(title = "log10(Conteo crudo + 1)"),
    yaxis = list(title = "log10(RPKM + 1)"),
    plot_bgcolor = "#ffffff",
    paper_bgcolor = "#ffffff"
  )
```

</div>

<div style="height: 5px; background-color: transparent;"></div>

<p>
  <strong>Relaci贸n directa entre recuentos crudos y normalizados (scatterplot por muestra):</strong>
  Para ejemplificar la relaci贸n entre los dos tipos de datos, se selecciona una muestra representativa y se grafica la expresi贸n g茅nica por cada gen en escala logar铆tmica, comparando valores crudos frente a valores normalizados.
  La l铆nea diagonal punteada indica la igualdad entre ambos valores; los puntos por debajo muestran genes que han sido ajustados a niveles inferiores tras la normalizaci贸n.
  Este gr谩fico ayuda a visualizar c贸mo la normalizaci贸n corrige sistem谩ticamente los recuentos, especialmente aquellos genes con valores extremos, sin alterar la tendencia general entre genes altamente y poco expresados.
</p>

<div style="height: 8px; background-color: transparent;"></div>

<div class="plot-center">

```{r, results='asis'}
# Asegurarse de que ambos objetos tienen los mismos genes en el mismo orden
common_genes <- intersect(rownames(counts_raw), rownames(counts_rpkm))
counts_raw_filt <- counts_raw[common_genes, ]
counts_rpkm_filt <- counts_rpkm[common_genes, ]

# Calcular la correlaci贸n de Pearson por muestra
library(purrr)
library(tibble)
library(ggplot2)

df_cor <- tibble(
  sample = colnames(counts_raw_filt),
  correlation = map_dbl(colnames(counts_raw_filt), ~ cor(counts_raw_filt[[.x]], counts_rpkm_filt[[.x]], method = "pearson"))
)


plot_ly(
  data = df_cor,
  x = ~sample,
  y = ~correlation,
  type = "bar",
  marker = list(color = "#3E8E7E")
) %>%
  layout(
    title = list(text = "Correlaci贸n entre conteos crudos y RPKM por muestra", x = 0.5),
    yaxis = list(title = "Correlaci贸n de Pearson", range = c(0, 1)),
    xaxis = list(title = "", tickangle = -45),
    plot_bgcolor = "#ffffff",
    paper_bgcolor = "#ffffff"
  )
```

</div>

<div style="height: 5px; background-color: transparent;"></div>

<p>
  <strong>Correlaci贸n de Pearson entre recuentos crudos y normalizados por muestra:</strong>
  Para cuantificar la relaci贸n entre los dos conjuntos de datos, se calcula el coeficiente de correlaci贸n de Pearson para cada muestra, reflejando la conservaci贸n relativa de los patrones de expresi贸n g茅nica.
  Altos valores de correlaci贸n indican que la normalizaci贸n mantiene la estructura biol贸gica entre genes dentro de cada muestra, a la vez que corrige variaciones t茅cnicas.
  Este an谩lisis cuantitativo complementa las visualizaciones previas y aporta una medida objetiva de la calidad del proceso de normalizaci贸n.
</p>
