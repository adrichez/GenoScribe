---
title: "Metagenomic Report"

include-in-header:
  text: |
    <link rel="shortcut icon" href="../../../../1-images/icono/favicon.svg"/>
    <link rel="icon" type="image/x-icon" href="../../../../1-images/icono/favicon.ico">

params:
  ruta_proyecto: ""
  tipo_analisis: ""
---


<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->
<!--  CHATBOT
<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->

```{=html}
<!-- Contenedor del chat -->
<div id="chat-container">
  <button id="chat-toggle"></button>
  <div id="chat-box">
    <div id="chat-info" class="chat-info">
      <h1>
        Mini Chat RAG (beta)
      </h1>

      <p>
        Este chat permite consultar de manera interactiva la informaci√≥n contenida en un informe espec√≠fico. 
        Para ello, se ha alimentado el sistema con el contenido del propio informe, junto con documentos externos en formato PDF y HTML, as√≠ como sesiones de preguntas y respuestas (QA). 
        Al formular una pregunta, el chat busca los fragmentos m√°s relevantes de todos estos documentos mediante t√©cnicas de procesamiento de lenguaje natural ligero y comparaciones basadas en similitud de vectores (medida de coseno). 
        A partir de los fragmentos seleccionados, se genera un resumen que intenta ofrecer una respuesta coherente y compacta a la consulta realizada.
      </p>

      <p>
        Se debe tener en cuenta que este entorno es de prueba. No se utilizan grandes modelos de lenguaje, por lo que las respuestas pueden ser aproximadas y no siempre completamente precisas. 
        El objetivo principal es proporcionar una visualizaci√≥n r√°pida y √∫til de la informaci√≥n contenida en los documentos, facilitando la exploraci√≥n del contenido del informe de manera interactiva.
      </p>
      
      <p>
        Actualmente, los resultados no son muy precisos debido al uso de modelos muy b√°sicos, seleccionados para que la aplicaci√≥n sea r√°pida y ejecutable en todo tipo de dispositivos sin necesidad de servidores externos. 
        Sin embargo, la base del sistema permite mejorar notablemente los resultados en el futuro mediante el uso de modelos m√°s potentes o la integraci√≥n con APIs externas, ofreciendo as√≠ un rendimiento y precisi√≥n significativamente superiores.
        Para iniciar, basta con escribir su pregunta en el campo de texto inferior.
      </p>
    </div>
    <div id="chat-log"></div>
    <input id="chat-input" type="text" placeholder="Escribe tu pregunta..."/>
    <button id="chat-send" title="Enviar">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>
      </svg>
    </button>
  </div>
</div>
```










<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->
<!--  TAB 3: AN√ÅLISIS 16S | 2. CONTROL DE CALIDAD Y PREPROCESAMIENTO -->
<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->

```{r}
# Cargar librer√≠as
library(glue)
library(fs)
library(stringr)
library(dplyr)


# Rutas clave
ruta_qmd <- getwd()
ruta_metagenomic_pipeline <- file.path("..", "..", "..", "..", "..", "..")
nombre_proyecto <- basename(params$ruta_proyecto)


# Rutas de resultados Nextflow
ruta_nextflow_results <- file.path("..", "..", "..", "..", "..", "..", "resources", "2-nextflow-results")
ruta_proyecto_relativa <- file.path("..", "..", "..", "..", "..", "..", "resources", "2-nextflow-results", "1-project-data", nombre_proyecto)


# Rutas de la carpeta Def
ruta_Def <- file.path(params$ruta_proyecto, "Resultados", "Def")
ruta_Def_relativa <- file.path(ruta_proyecto_relativa, "Resultados", "Def")

ruta_Def_sample_metadata <- file.path(ruta_Def, "sample-metadata.tsv")
ruta_Def_sample_metadata_relativa <- file.path(ruta_Def_relativa, "sample-metadata.tsv")

# Leer el archivo TSV de metadatos
Def_sample_metadata_relativa <- read.delim(
  ruta_Def_sample_metadata_relativa,
  header = TRUE,
  stringsAsFactors = FALSE,
  fill = TRUE
)


# Ruta de la carpeta reads
ruta_reads_16S <- file.path(params$ruta_proyecto, "Analisis", "reads", "16S")


# Ruta resultados fastqc
ruta_Pre_fastqc_results <- file.path(params$ruta_proyecto, "Analisis", "miARma_16S", "Pre_fastqc_results")
ruta_Pre_fastqc_results_relativa <- file.path(ruta_proyecto_relativa, "Analisis", "miARma_16S", "Pre_fastqc_results")


# Obtener archivos .html de FastQC
archivos_html <- dir_ls(ruta_Pre_fastqc_results_relativa, regexp = "\\.html$")

# Extraer IDs de muestra (quitando el sufijo que empieza por _R1 o _R2 hasta el final)
ids_muestras <- archivos_html |>
  path_file() |>
  str_replace("_(R1|R2).*_fastqc\\.html$", "") |>
  unique()


# Listar archivos fastqc y fastq
archivos_fastqc <- list.files(
  ruta_Pre_fastqc_results, 
  pattern = "_fastqc\\.html$", 
  full.names = FALSE
)

archivos_fastq <- list.files(
  ruta_reads_16S, 
  pattern = "\\.fastq\\.gz$", 
  full.names = FALSE
)

# Extraer identificadores base (quitando sufijo R1/R2 + lo que siga hasta el final)
ids_fastqc <- unique(gsub("_(R1|R2).*_fastqc\\.html$", "", archivos_fastqc))
ids_fastq  <- unique(gsub("_(R1|R2).*\\.fastq\\.gz$", "", archivos_fastq))
ids_targets <- Def_sample_metadata_relativa[, 1]

# Identificar diferencias
fastqc_no_targets  <- setdiff(ids_fastqc, ids_targets)
targets_no_fastqc  <- setdiff(ids_targets, ids_fastqc)
targets_no_reads   <- setdiff(ids_targets, ids_fastq)


# Ruta absoluta al informe MULTIQC
ruta_multiqc_report <- file.path(ruta_nextflow_results, "2-fastqc-report", "results-multiqc-16S", "multiqc_report.html")
```


<div class="informe-titulo-tab">
  <h1>Pesta√±a</h1>
  <h2>An√°lisis 16S bioinform√°tico completo</h2>
</div>

<div class="informe-titulo-seccion">
  <h1>Secci√≥n 2</h1>
  <h2>Control de calidad y preprocesamiento</h2>
</div>

<div class="informe-resumen">
  <h2>Resumen</h2>

  <p>
    En esta secci√≥n se presentan los resultados del control de calidad y preprocesamiento aplicados a los archivos <code>.fastq.gz</code> generados tras la secuenciaci√≥n 16S. La evaluaci√≥n se ha realizado de manera integral, considerando tanto el conjunto completo de muestras como el detalle de cada una, mediante las herramientas <strong>FastQC</strong> y <strong>MultiQC</strong>, integradas en el pipeline automatizado desarrollado con <strong>Nextflow</strong>.
  </p>

  <p>
    Se comenz√≥ con un <strong>resumen global</strong> de calidad a trav√©s de <strong>MultiQC</strong>, que proporciona m√©tricas agregadas para todas las muestras, permitiendo identificar patrones generales, diferencias sistem√°ticas o posibles anomal√≠as globales. Este informe interactivo facilita la visualizaci√≥n r√°pida de la calidad general del dataset.
  </p>

  <p>
    A continuaci√≥n, se generaron los informes individuales de <strong>FastQC</strong> para cada muestra y direcci√≥n de lectura (<em>Forward</em> y <em>Reverse</em>). Cada informe incluye m√©tricas clave como calidad por base, contenido GC, niveles de duplicaci√≥n y presencia de adaptadores, y se presenta embebido mediante <code>iframe</code> para una visualizaci√≥n interactiva. Esto permite una revisi√≥n detallada y espec√≠fica de la calidad de cada muestra.
  </p>

  <p>
    Posteriormente, se realiz√≥ la <strong>demultiplexaci√≥n</strong> mediante QIIME2. Este informe proporciona informaci√≥n esencial sobre la separaci√≥n de lecturas por muestra, incluyendo la tabla de recuentos por muestra (<code>per-sample-fastq-counts.tsv</code>) y un visor interactivo (<code>index.html</code>) que permite inspeccionar la calidad por posici√≥n, distribuciones de longitud y posibles problemas en la asignaci√≥n de √≠ndices. La revisi√≥n de esta secci√≥n permite identificar muestras con recuentos insuficientes, desequilibrios entre grupos o errores de indexaci√≥n, y define los par√°metros iniciales para el truncado y filtrado.
  </p>

  <p>
    Tras la revisi√≥n de la demultiplexaci√≥n y los informes de calidad, se contempl√≥ la posible aplicaci√≥n de <em>trimming</em> para eliminar adaptadores residuales, primers o bases de baja calidad. La informaci√≥n de las secciones previas gu√≠a la selecci√≥n de par√°metros de truncado (<code>trunc_len_f</code> y <code>trunc_len_r</code>) asegurando que se mantenga un solapamiento suficiente entre lecturas forward y reverse para los pasos posteriores.
  </p>

  <p>
    La etapa de <strong>filtrado y depuraci√≥n de lecturas</strong> se realiza mediante <strong>DADA2</strong> o <strong>Deblur</strong>, generando secuencias representativas √∫nicas, conocidas como ASVs, corrigiendo errores de secuenciaci√≥n y eliminando quimeras. Esta fase asegura que los datos sean fiables y comparables entre muestras, y se documenta en la <code>stats-dada2.qzv</code>, que resume cu√°ntas lecturas iniciales pasaron por cada paso del proceso.
  </p>

  <p>
    La tabla de abundancia de ASVs (<code>table.qza / table.qzv</code>) y las secuencias representativas (<code>rep-seqs.qza / rep-seqs.qzv</code>) se analizar√°n en la siguiente secci√≥n que detallaremos m√°s adelante: <a href="3-asvs-abundancia.html#tab3-seccion3" class="normalink">3. Generaci√≥n de ASVs y tabla de abundancia</a>.
  </p>

  <p>
    En conjunto, esta secci√≥n proporciona una visi√≥n completa del control de calidad, demultiplexaci√≥n, preprocesamiento y depuraci√≥n de errores aplicada a las lecturas 16S. La integraci√≥n de todos estos apartados garantiza que el informe sea <strong>automatizado, reproducible</strong> y adaptable a cualquier conjunto de muestras, manteniendo siempre la trazabilidad de los datos procesados.
  </p>
</div>










<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo-toc">
  Tabla de contenidos de esta secci√≥n
</div>

```{=html}
```{r, results="asis"}
cat('
<div class="toc">
  <ul>
    <li>
      <a href="#tab3-seccion2">
        2<span>.</span> Control de calidad y preprocesamiento
      </a>
      <ul>
        <li>
          <a href="#tab3-seccion2.1">
            2.1. Informes de calidad externos (FastQC / MultiQC)
          </a>
          <ul>
            <li>
              <a href="#tab3-seccion2.1.1">
                2.1.1. Resumen global (MultiQC)
              </a>
            </li>
            <li>
              <a href="#tab3-seccion2.1.2">
                2.1.2. Calidad individual (FastQC)
              </a>
              <ul>
                <li>
                  <a href="#tab3-seccion2.1.2.1">
                    2.1.2.1. Evaluaci√≥n de calidad de lecturas Forward
                  </a>
                  <ul>
')

i <- 1
for (id in ids_muestras) {
  cat(glue::glue('<li><a href="#tab3-seccion2.1.2.1.{i}">2.1.2.1.{i}. Muestra: {id}</a></li>\n'))
  i <- i + 1
}

cat('
                  </ul>
                </li>
                <li>
                  <a href="#tab3-seccion2.1.2.2">
                    2.1.2.2. Evaluaci√≥n de calidad de lecturas Backward
                  </a>
                  <ul>
')

i <- 1
for (id in ids_muestras) {
  cat(glue::glue('<li><a href="#tab3-seccion2.1.2.2.{i}">2.1.2.2.{i}. Muestra: {id}</a></li>\n'))
  i <- i + 1
}

cat('
                  </ul>
                </li>
              </ul>
            </li>
            <li>
              <a href="#tab3-seccion2.2">
                2.2. Informe de demultiplexaci√≥n en QIIME2
              </a>
            </li>
            <li>
              <a href="#tab3-seccion2.3">
                2.3. Reflexiones sobre la calidad observada
              </a>
            </li>
            <li>
              <a href="#tab3-seccion2.4">
                2.4. Trimming y filtrado inicial
              </a>
            </li>
            <li>
              <a href="#tab3-seccion2.5">
                2.5. Denoising y depuraci√≥n con DADA2 / Deblur
              </a>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</div>
')
```
```

```{=html}
```










<!-- #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->
<!-- REDACCI√ìN -->
<!-- #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->

<div style="height: 25px; background-color: transparent;"></div>

<div class="titulo1" id="tab3-seccion2">
  2<span>.</span> Control de calidad y preprocesamiento
</div>

<p>
  En esta secci√≥n se aborda el <strong>control de calidad y preprocesamiento</strong> de los datos de secuenciaci√≥n 16S, un paso fundamental para garantizar la fiabilidad de los an√°lisis posteriores. Se comienza evaluando la calidad de las lecturas mediante <strong>FastQC</strong> y <strong>MultiQC</strong>, proporcionando una visi√≥n tanto global de todas las muestras como detallada de cada una de ellas por direcci√≥n de lectura (<em>Forward</em> y <em>Backward</em>).
</p>

<p>
  Tras la revisi√≥n de calidad, se proceder√° a la etapa de <strong>filtrado y depuraci√≥n de lecturas</strong> utilizando <strong>DADA2</strong> o <strong>Deblur</strong>. Este paso asegura la eliminaci√≥n de secuencias de baja calidad, quimeras y otras lecturas problem√°ticas, generando un conjunto de ASVs confiables que servir√°n como base para los an√°lisis de diversidad y composici√≥n taxon√≥mica. 
</p>

<p>
  A continuaci√≥n, se presenta la primera subsecci√≥n que describe detalladamente los <strong>informes de calidad generados por FastQC y MultiQC</strong>, incluyendo tanto el resumen global como la evaluaci√≥n individual de cada muestra.
</p>










<div style="height: 20px; background-color: transparent;"></div>

<div class="titulo2" id="tab3-seccion2.1">
  2.1. Informes de calidad externos (FastQC / MultiQC)
</div>

<p>
  La calidad de las lecturas en un experimento de metagen√≥mica 16S es un factor determinante para la fiabilidad de los an√°lisis posteriores, como la asignaci√≥n taxon√≥mica, la estimaci√≥n de abundancias relativas y la identificaci√≥n de posibles contaminantes. Por ello, uno de los primeros pasos fundamentales en cualquier pipeline de procesamiento es la evaluaci√≥n de la calidad de los archivos <code>.fastq.gz</code> generados tras la secuenciaci√≥n.
</p>

<p>
  En este estudio, el control de calidad se aplic√≥ a <strong>todas las muestras disponibles inicialmente</strong>, independientemente de si fueron seleccionadas o no para el an√°lisis principal. Este enfoque garantiza una evaluaci√≥n exhaustiva del conjunto completo de datos, permitiendo detectar posibles problemas antes de la selecci√≥n definitiva de las muestras a analizar.
</p>

<p>
  El control de calidad se llev√≥ a cabo utilizando la herramienta <strong>FastQC</strong>, la cual genera informes detallados por muestra sobre diversos aspectos de la calidad de las secuencias. Posteriormente, todos estos informes individuales fueron integrados mediante <strong>MultiQC</strong>, generando un √∫nico informe resumen interactivo. Este informe consolidado permite inspeccionar de forma global y comparativa el estado de las lecturas en todas las muestras procesadas.
</p>

<p>
  Las m√©tricas clave incluidas en el informe de MultiQC son, entre otras:
</p>

<ul>
  <li>Calidad de las bases a lo largo de las lecturas (per base sequence quality).</li>
  <li>Contenido de GC.</li>
  <li>Presencia de adaptadores o secuencias no deseadas.</li>
  <li>Nivel de duplicaci√≥n de las secuencias.</li>
  <li>Distribuci√≥n de la longitud de las lecturas.</li>
</ul>

<p>
  Estas m√©tricas permiten identificar posibles problemas t√©cnicos, como errores en la amplificaci√≥n por PCR, contaminaci√≥n cruzada, presencia de adaptadores o sesgos sistem√°ticos de la secuenciaci√≥n. Esta informaci√≥n es esencial para tomar decisiones informadas sobre la necesidad de aplicar pasos de filtrado o recorte antes de proceder con la inferencia taxon√≥mica y el an√°lisis de diversidad.
</p>

<p>
  Es importante se√±alar que <strong>no todas las muestras presentes en el informe de MultiQC est√°n incluidas en el an√°lisis principal</strong>. La tabla de metadatos presentada anteriormente recoge √∫nicamente las muestras seleccionadas para las etapas posteriores de an√°lisis taxon√≥mico y de diversidad, por lo que puede haber discrepancias entre ambas.
</p>








<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo3" id="tab3-seccion2.1.1">
  2.1.1. Resumen global (MultiQC)
</div>

<p>
  El an√°lisis conjunto de calidad se ha llevado a cabo mediante la herramienta <strong>MultiQC</strong>, la cual agrega y resume de forma interactiva los informes individuales generados previamente por <strong>FastQC</strong> para cada una de las muestras procesadas. Este enfoque permite visualizar en un √∫nico informe consolidado todas las m√©tricas relevantes, facilitando la comparaci√≥n entre muestras y la identificaci√≥n de posibles anomal√≠as sistem√°ticas, errores t√©cnicos o patrones comunes.
</p>

<p>
  El informe MultiQC incluye gr√°ficos y tablas que resumen aspectos clave como la calidad por base, el contenido GC, la longitud de las lecturas, la presencia de adaptadores o contaminantes y otros indicadores de calidad. Esta visi√≥n global resulta especialmente √∫til para tomar decisiones sobre la limpieza y filtrado de las lecturas antes del alineamiento.
</p>

<p>
  A continuaci√≥n, se muestra el informe interactivo integrado directamente en este documento. Tambi√©n se proporciona un bot√≥n para abrirlo en una nueva pesta√±a, lo cual permite una visualizaci√≥n m√°s c√≥moda y detallada si se desea explorar el informe en mayor profundidad.
</p>

```{r, results='asis'}
cat(glue::glue('
<iframe src={ruta_multiqc_report} width="100%" height="700px" loading="lazy" style="border:none;"></iframe>

<p style="text-align:center;">
  <a href={ruta_multiqc_report} target="_blank" class="boton-iframe">
    üîç Ver informe interactivo de MultiQC en una nueva p√°gina
  </a>
</p>
\n\n'))
```

<p>
  En la siguiente secci√≥n se detallar√° el an√°lisis individual de la calidad de cada muestra, diferenciando entre lecturas <em>forward</em> y <em>backward</em>, mediante la incorporaci√≥n directa de los informes <strong>FastQC</strong> individuales generados autom√°ticamente por la herramienta <strong>miARma‚ÄëSeq</strong>.
</p>








<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo3" id="tab3-seccion2.1.2">
  2.1.2. Calidad individual (FastQC)
</div>

<p>
  Tras la evaluaci√≥n conjunta mediante <strong>MultiQC</strong>, esta subsecci√≥n se centra en el an√°lisis individualizado de cada una de las muestras a trav√©s de los informes generados por <strong>FastQC</strong>. Este enfoque permite inspeccionar con mayor nivel de detalle los distintos par√°metros de calidad, identificando posibles incidencias espec√≠ficas que podr√≠an no ser evidentes en el an√°lisis global.
</p>

<p>
  En el contexto de un an√°lisis <strong>metagen√≥mico 16S</strong>, la fase de control de calidad es especialmente relevante, dado que el posterior procesamiento con herramientas como <strong>QIIME2</strong> o <strong>DADA2</strong> se basa en la precisi√≥n de las lecturas de amplicones. <strong>FastQC</strong> proporciona una evaluaci√≥n visual e interactiva de aspectos fundamentales como la calidad por base a lo largo de las lecturas, el contenido de GC, la presencia de adaptadores o primers, la sobre-representaci√≥n de secuencias y la longitud de las lecturas, par√°metros que pueden influir directamente en la correcta inferencia de variantes de secuencia (ASVs/OTUs).
</p>

<p>
  En este informe, cada muestra dispone de una secci√≥n dedicada organizada por tipo de lectura <em>(forward y reverse)</em>, donde se presenta su correspondiente informe <code>.html</code> de FastQC. Los informes han sido generados autom√°ticamente por el pipeline <strong>miARma-Seq</strong> y se integran en este documento mediante una ventana interactiva para facilitar su visualizaci√≥n directa, junto con un bot√≥n de acceso para abrirlos en una pesta√±a nueva y explorar los resultados en mayor detalle.
</p>

<p>
  Todos los informes individuales utilizados para generar el resumen de MultiQC se encontraban almacenados en el siguiente directorio en el momento de la generaci√≥n de este informe:
</p>

```{r, results='asis'}
cat(glue::glue('
<code>{ruta_Pre_fastqc_results}</code>
\n\n'))
```

<p>
  A continuaci√≥n, se muestra el listado completo de los archivos de salida generados por <code>FastQC</code> para cada una de las muestras procesadas. Para cada muestra se generan dos archivos principales: un informe en formato <code>.html</code>, que ofrece una visualizaci√≥n interactiva de los resultados del control de calidad, y un archivo comprimido <code>.zip</code>, que contiene los archivos fuente utilizados para construir dicho informe, incluyendo datos tabulados, gr√°ficos en formato <code>.png</code> y un resumen en texto plano.
</p>

<p>
  Aunque es posible acceder a estos archivos directamente desde el visor interactivo que se presenta a continuaci√≥n, se recomienda utilizar las secciones espec√≠ficas por muestra situadas m√°s abajo. En dichas secciones, los informes <code>.html</code> se integran directamente en el documento mediante <code>iframe</code>, junto con un bot√≥n de acceso para su visualizaci√≥n ampliada. Adem√°s, se proporciona contexto adicional para facilitar la interpretaci√≥n de los resultados individuales.
</p>

<div class="box-files">

```{r, results="asis"}
if (!dir.exists(ruta_Pre_fastqc_results)) {
  cat(sprintf('<p><em>La ruta "%s" no existe o no es accesible.</em></p>\n', ruta_Pre_fastqc_results_relativa))
} else {
  # Listar archivos con extensiones de inter√©s
  files <- list.files(ruta_Pre_fastqc_results_relativa, pattern = "\\.(html|zip|fastq\\.gz)$", full.names = FALSE)
  
  if (length(files) == 0) {
    cat('<p><em>No se encontraron archivos con las extensiones esperadas en la carpeta especificada.</em></p>\n')
  } else {
    enlace <- paste0("file://", ruta_Pre_fastqc_results_relativa)
    
    cat("<ul>\n")
    for (f in files) {
      # Asignar clase seg√∫n la extensi√≥n
      clase <- if (grepl("\\.html$", f)) {
        "file-html"
      } else if (grepl("\\.zip$", f)) {
        "file-zip"
      } else if (grepl("\\.fastq\\.gz$", f)) {
        "file-fastqgz"
      } else {
        "file-default"
      }
      
      cat(sprintf('<li class="%s"><a href="%s/%s" target="_blank">%s</a></li>\n',
                  clase, enlace, f, f))
    }
    cat("</ul>\n")
  }
}
```

</div>

```{r, echo=FALSE, results="asis"}
# Para que funcione con rutas absolutas
enlace <- paste0("file://", ruta_Pre_fastqc_results_relativa)

# Imprimir el enlace
cat(glue::glue('

<p style="text-align:center;">
  <a href="{enlace}" target="_blank" class="boton-files">
    üìÇ Explora los archivos de la carpeta "Pre_fastqc_results" aqu√≠
  </a>
</p>
\n\n'))
```

<p>
  As√≠, estos informes individuales generados por <strong>FastQC</strong> ofrecen una evaluaci√≥n visual e interactiva de diversos aspectos clave de la calidad de las lecturas de secuenciaci√≥n. Cada informe est√° estructurado en m√≥dulos que resumen m√©tricas espec√≠ficas, facilitando as√≠ la identificaci√≥n de posibles problemas t√©cnicos o artefactos introducidos durante la preparaci√≥n de las librer√≠as o el proceso de secuenciaci√≥n.
</p>

<div style="height: 5px; background-color: transparent;"></div>

---

<p>
  A continuaci√≥n se describe brevemente la informaci√≥n incluida en estos informes, accesibles, como ya hemos comentado, desde el visor interactivo anterior o m√°s adelante desde cada apartado espec√≠fico.
</p>

<ul>
  <li><strong>Basic Statistics [<span style="color: green;">PASS</span> | <span style="color: orange;">WARNING</span> | <span style="color: red;">FAIL</span>]</strong>: Informaci√≥n general sobre las secuencias, incluyendo el n√∫mero total de lecturas, su longitud media y el contenido GC. Estos par√°metros permiten confirmar que los datos cumplen con los criterios b√°sicos de calidad esperados por la plataforma de secuenciaci√≥n.</li>

  <li><strong>Per base sequence quality [<span style="color: green;">PASS</span> | <span style="color: orange;">WARNING</span> | <span style="color: red;">FAIL</span>]</strong>: Eval√∫a la calidad de las bases en cada posici√≥n de las lecturas. Una baja calidad al principio o final de las lecturas puede requerir recorte (trimming) para evitar errores en etapas posteriores.</li>

  <li><strong>Per tile sequence quality [<span style="color: green;">PASS</span> | <span style="color: orange;">WARNING</span> | <span style="color: red;">FAIL</span>]</strong>: Detecta anomal√≠as en regiones espec√≠ficas del flujo √≥ptico del secuenciador. Problemas en este m√≥dulo pueden indicar fallos mec√°nicos o de iluminaci√≥n que afectan localmente la calidad.</li>

  <li><strong>Per sequence quality scores [<span style="color: green;">PASS</span> | <span style="color: orange;">WARNING</span> | <span style="color: red;">FAIL</span>]</strong>: Muestra la distribuci√≥n de puntuaciones de calidad para todas las lecturas. Una alta proporci√≥n de lecturas con baja calidad puede comprometer el an√°lisis.</li>

  <li><strong>Per base sequence content [<span style="color: green;">PASS</span> | <span style="color: orange;">WARNING</span> | <span style="color: red;">FAIL</span>]</strong>: Analiza la proporci√≥n de nucle√≥tidos (A, T, G, C) en cada posici√≥n. Desequilibrios importantes pueden reflejar sesgos de la librer√≠a o contaminaci√≥n.</li>

  <li><strong>Per sequence GC content [<span style="color: green;">PASS</span> | <span style="color: orange;">WARNING</span> | <span style="color: red;">FAIL</span>]</strong>: Eval√∫a el contenido GC promedio por lectura. Desviaciones respecto al esperado para el organismo estudiado pueden indicar presencia de contaminantes o problemas en la preparaci√≥n de la librer√≠a.</li>

  <li><strong>Sequence Length Distribution [<span style="color: green;">PASS</span> | <span style="color: orange;">WARNING</span> | <span style="color: red;">FAIL</span>]</strong>: Muestra la distribuci√≥n de longitudes de las lecturas. Una distribuci√≥n uniforme o acorde con el protocolo indica buena calidad, mientras que distribuciones an√≥malas pueden sugerir errores en el proceso de fragmentaci√≥n o secuenciaci√≥n.</li>

  <li><strong>Sequence Duplication Levels [<span style="color: green;">PASS</span> | <span style="color: orange;">WARNING</span> | <span style="color: red;">FAIL</span>]</strong>: Informa sobre la proporci√≥n de lecturas duplicadas. Un alto nivel puede deberse a sobre-secuenciaci√≥n, baja complejidad de la muestra o problemas en la PCR.</li>

  <li><strong>Overrepresented sequences [<span style="color: green;">PASS</span> | <span style="color: orange;">WARNING</span> | <span style="color: red;">FAIL</span>]</strong>: Identifica secuencias que aparecen con frecuencia anormalmente alta, como adaptadores no eliminados, contaminantes o secuencias ribosomales.</li>

  <li><strong>Adapter Content [<span style="color: green;">PASS</span> | <span style="color: orange;">WARNING</span> | <span style="color: red;">FAIL</span>]</strong>: Detecta la presencia de secuencias adaptadoras dentro de las lecturas. Si se detectan, es necesario aplicar un paso de recorte (trimming) antes de continuar con el an√°lisis.</li>
</ul>

<p>
  Cada m√≥dulo es evaluado individualmente y clasificado como <span style="color: green;"><strong>PASS</strong></span>, <span style="color: orange;"><strong>WARNING</strong></span> o <span style="color: red;"><strong>FAIL</strong></span>. Un resultado <strong>PASS</strong> indica que el m√≥dulo cumple con los criterios de calidad recomendados. <strong>WARNING</strong> se√±ala que se ha detectado una desviaci√≥n leve o moderada que podr√≠a afectar algunos an√°lisis dependiendo de la sensibilidad del downstream. <strong>FAIL</strong>, en cambio, indica problemas importantes que deber√≠an ser corregidos o, al menos, tenidos en cuenta antes de continuar con el procesamiento de los datos.
</p>

<p>
  Dicho esto, en las siguientes subsecciones se analizar√°n en detalle los resultados de calidad, distinguiendo entre lecturas <em>forward</em> y <em>backward</em>. Dentro de cada una, se presentar√° el informe individual correspondiente a cada muestra, integrado directamente en el documento para facilitar su consulta. Esta estructura permite una revisi√≥n ordenada y completa del estado de las lecturas, asegurando que cada muestra sea evaluada con el nivel de detalle necesario antes de proceder con las etapas posteriores del an√°lisis.
</p>






<div style="height: 13px; background-color: transparent;"></div>

<div class="titulo4" id="tab3-seccion2.1.2.1">
  2.1.2.1. Evaluaci√≥n de calidad de lecturas Forward
</div>

<p>
  En este apartado se muestran los resultados del an√°lisis de calidad correspondientes a las lecturas <strong>forward</strong> <em>(read 1)</em> de cada una de las muestras. Estas lecturas representan el primer extremo de los fragmentos secuenciados en protocolos <em>paired-end</em>, y su calidad es especialmente relevante para asegurar una alineaci√≥n precisa y una cuantificaci√≥n fiable en los pasos posteriores del an√°lisis transcript√≥mico.
</p>

<p>
  A continuaci√≥n, se incluyen las evaluaciones individuales para cada muestra, organizadas de forma estructurada para facilitar su revisi√≥n. Esta presentaci√≥n permite detectar con claridad posibles incidencias espec√≠ficas en las lecturas <em>read 1</em>, como ca√≠das de calidad en posiciones terminales, contaminaci√≥n por adaptadores, sesgos en la composici√≥n de bases o niveles an√≥malos de duplicaci√≥n. Identificar estos problemas a tiempo es crucial para garantizar la robustez y validez de los resultados obtenidos en las siguientes etapas del pipeline.
</p>

```{r, results='asis'}
library(glue)
library(stringr)
library(fs)

i <- 1

for (id in ids_muestras) {
  
  # Buscar archivo R1 correspondiente al ID (sin asumir que hay _001 o no)
  ruta_fasqc_R1 <- archivos_html[
    str_detect(path_file(archivos_html), paste0("^", id, "_R1.*_fastqc\\.html$"))
  ]
  
  if (length(ruta_fasqc_R1) == 0) {
    warning(glue("‚ö†Ô∏è No se encontr√≥ archivo R1 para la muestra {id}"))
    next
  }
  
  cat(glue('
  <div style="height: 10px; background-color: transparent;"></div>

  <div class="titulo5" id="tab3-seccion2.1.2.1.{i}">
    2.1.2.1.{i}. Muestra: {id}
  </div>

  <p>
    A continuaci√≥n se muestra el informe de control de calidad correspondiente a la lectura <strong>forward</strong> <em>(read 1)</em> de la muestra <strong>{id}</strong>. Este informe permite revisar visualmente diversos aspectos relacionados con la calidad de las secuencias obtenidas en el segundo extremo de los fragmentos, facilitando la detecci√≥n de posibles incidencias que puedan comprometer el an√°lisis posterior.
  </p>

  <iframe src="{ruta_fasqc_R1}" width="100%" height="700px" loading="lazy" style="border:none;"></iframe>

  <p style="text-align:center;">
    <a href="{ruta_fasqc_R1}" target="_blank" class="boton-iframe">
      üîç Ver informe interactivo de FASTQC en una nueva p√°gina
    </a>
  </p>
  \n\n'))
  
  i <- i + 1
}
```






<div style="height: 13px; background-color: transparent;"></div>

<div class="titulo4" id="tab3-seccion2.1.2.2">
  2.1.2.2. Evaluaci√≥n de calidad de lecturas Backward
</div>

<p>
  En esta secci√≥n se presentan los resultados del an√°lisis de calidad correspondientes a las lecturas <strong>backward</strong> <em>(read 2)</em> de cada muestra. Estas lecturas representan el segundo extremo de los fragmentos secuenciados en protocolos <em>paired-end</em>, y complementan la informaci√≥n proporcionada por las lecturas <em>forward</em> para una reconstrucci√≥n m√°s completa de las transcripciones.
</p>

<p>
  A continuaci√≥n, se muestran las evaluaciones individuales de calidad para las lecturas <em>read 2</em> por muestra, siguiendo el mismo formato estructurado que en el apartado anterior. Revisar cuidadosamente estos informes permite identificar posibles deficiencias espec√≠ficas en las lecturas <em>backward</em>, como una menor calidad en las regiones finales, errores de secuenciaci√≥n acumulativos o patrones inusuales en la distribuci√≥n de bases. Estos aspectos son fundamentales para garantizar que ambas lecturas de cada fragmento contribuyan de forma fiable al an√°lisis global.
</p>

```{r, results='asis'}
library(glue)
library(stringr)
library(fs)

i <- 1

for (id in ids_muestras) {
  
  # Buscar archivo R2 correspondiente al ID (robusto a _001 u otros sufijos)
  ruta_fasqc_R2 <- archivos_html[
    str_detect(path_file(archivos_html), paste0("^", id, "_R2.*_fastqc\\.html$"))
  ]
  
  if (length(ruta_fasqc_R2) == 0) {
    warning(glue("‚ö†Ô∏è No se encontr√≥ archivo R2 para la muestra {id}"))
    next
  }
  
  cat(glue('
  <div style="height: 10px; background-color: transparent;"></div>

  <div class="titulo5" id="tab3-seccion2.1.2.2.{i}">
    2.1.2.2.{i}. Muestra: {id}
  </div>

  <p>
    A continuaci√≥n se muestra el informe de control de calidad correspondiente a la lectura <strong>backward</strong> <em>(read 2)</em> de la muestra <strong>{id}</strong>. Este informe permite revisar visualmente diversos aspectos relacionados con la calidad de las secuencias obtenidas en el segundo extremo de los fragmentos, facilitando la detecci√≥n de posibles incidencias que puedan comprometer el an√°lisis posterior.
  </p>

  <iframe src="{ruta_fasqc_R2}" width="100%" height="700px" loading="lazy" style="border:none;"></iframe>

  <p style="text-align:center;">
    <a href="{ruta_fasqc_R2}" target="_blank" class="boton-iframe">
      üîç Ver informe interactivo de FASTQC en una nueva p√°gina
    </a>
  </p>
  \n\n'))
  
  i <- i + 1
}
```










<div class="titulo2" id="tab3-seccion2.2">
  2.2. Informe de demultiplexaci√≥n en QIIME2
</div>

```{r}
# Definir ruta del archivo .qzv
ruta_demux_qzv_relativa <- file.path(ruta_Def_relativa, "demux.qzv")
ruta_demux_qzv <- file.path(ruta_Def, "demux.qzv")

# Definir ruta de salida para el unzip
ruta_Def_unzip <- file.path(ruta_Def_relativa, "unzip")
ruta_unzip_demux <- file.path(ruta_Def_unzip, "demux")

# Crear carpeta de salida si no existe
if (!dir.exists(ruta_Def_unzip)) dir.create(ruta_Def_unzip, recursive = TRUE)

# Solo hacer unzip si el archivo existe
if (file.exists(ruta_demux_qzv_relativa)) {
  # Usando system2 para llamar a unzip desde R
  system2("unzip", args = c("-o", shQuote(ruta_demux_qzv_relativa),
                            "-d", shQuote(ruta_unzip_demux)))
} else {
  message("‚ö†Ô∏è El archivo stats-dada2.qzv no existe. Se omite el unzip.")
}
```

```{r}
# Comprobar que el unzip se ha realizado
if (dir.exists(ruta_unzip_demux)) {
  
  # Listar subcarpetas dentro de la carpeta unzip (solo 1er nivel)
  subcarpetas <- list.dirs(ruta_unzip_demux, recursive = FALSE, full.names = TRUE)
  
  if (length(subcarpetas) == 0) {
    stop("No se encontr√≥ ninguna subcarpeta dentro de ", ruta_unzip_demux)
  }
  
  # Tomamos la primera subcarpeta (la aleatoria)
  carpeta_random <- subcarpetas[1]
  
  # Ruta a 'data'
  ruta_data <- file.path(carpeta_random, "data")
  
  # Archivos dentro de 'data'
  ruta_per_sample_fastq_counts_tsv <- file.path(ruta_data, "per-sample-fastq-counts.tsv")
  ruta_index_html <- file.path(ruta_data, "index.html")
  
  # Comprobar que existen
  if (!file.exists(ruta_per_sample_fastq_counts_tsv)) message("‚ö†Ô∏è per-sample-fastq-counts.tsv no encontrado")
  if (!file.exists(ruta_index_html)) message("‚ö†Ô∏è index.html no encontrado")
  
} else {
  message("‚ö†Ô∏è Carpeta de unzip no encontrada. No se puede acceder a los archivos.")
}
```

<p>
  Tras la evaluaci√≥n inicial de calidad con <strong>FastQC / MultiQC</strong>, el siguiente paso del an√°lisis consiste en revisar el informe de <em>demultiplexaci√≥n</em> generado por QIIME2 (<code>demux.qzv</code>). Este archivo contiene informaci√≥n esencial sobre c√≥mo se han separado las lecturas en funci√≥n de los √≠ndices asignados a cada muestra y permite una primera inspecci√≥n detallada del n√∫mero de lecturas y de su calidad antes de aplicar procesos de filtrado o depuraci√≥n. El archivo correspondiente se encuentra en el siguiente directorio:
</p>

```{r, results="asis"}
if (file.exists(ruta_demux_qzv)) {
  cat(glue::glue('
<code>{ruta_demux_qzv}</code>
\n\n'))
} else {
  cat(glue::glue('
‚ö†Ô∏è El archivo <code>demux.qzv</code> no existe en la ruta especificada: 
<code>{ruta_demux_qzv}</code>
\n\n'))
}
```

<p>
  Al descomprimir <code>demux.qzv</code> se obtienen varios resultados intermedios. Entre ellos destaca el archivo <code>per-sample-fastq-counts.tsv</code>, que resume el n√∫mero de lecturas forward y reverse asignadas a cada muestra tras la separaci√≥n. La estructura de esta tabla es sencilla: en la primera columna aparecen los identificadores de las muestras y, en las dos siguientes, el n√∫mero de secuencias detectadas para las lecturas forward y reverse, respectivamente. Por ejemplo:
</p>

<div style="text-align: center;">
  <table style="border-collapse: collapse; margin: 0 auto; width: 60%;">
    <thead>
      <tr style="background-color: #055379; color: white;">
        <th style="border: 1px solid #ccc; padding: 6px;">Sample ID</th>
        <th style="border: 1px solid #ccc; padding: 6px;">Forward sequence count</th>
        <th style="border: 1px solid #ccc; padding: 6px;">Backward sequence count</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td style="border: 1px solid #ccc; padding: 6px;">NGS069-24-16S-1</td>
        <td style="border: 1px solid #ccc; padding: 6px;">146241</td>
        <td style="border: 1px solid #ccc; padding: 6px;">146241</td>
      </tr>
      <tr>
        <td style="border: 1px solid #ccc; padding: 6px;">NGS069-24-16S-8</td>
        <td style="border: 1px solid #ccc; padding: 6px;">129633</td>
        <td style="border: 1px solid #ccc; padding: 6px;">129633</td>
      </tr>
      <tr>
        <td style="border: 1px solid #ccc; padding: 6px;">NGS069-24-16S-9</td>
        <td style="border: 1px solid #ccc; padding: 6px;">128854</td>
        <td style="border: 1px solid #ccc; padding: 6px;">128854</td>
      </tr>
    </tbody>
  </table>
</div>

<div style="height: 15px; background-color: transparent;"></div>

<p>
  Este tipo de informaci√≥n resulta cr√≠tica porque permite identificar r√°pidamente si todas las muestras cuentan con un n√∫mero suficiente de lecturas para los an√°lisis posteriores. Muestras con un n√∫mero muy bajo de secuencias pueden carecer de potencia estad√≠stica y comprometer la calidad de los resultados. Adem√°s, la tabla ayuda a comprobar la coherencia entre las lecturas forward y reverse: en condiciones normales los recuentos deben coincidir o diferir m√≠nimamente, como se observa en el ejemplo, lo que confirma que la demultiplexaci√≥n se realiz√≥ correctamente y que cada muestra dispone de sus pares de secuencias completos.
</p>

```{r}
# Leer el archivo y mostrar tabla interactiva
if (file.exists(ruta_per_sample_fastq_counts_tsv)) {
  # Leer el archivo generado al descomprimir
  library(readr)
  per_sample_fastq_counts <- read_tsv(ruta_per_sample_fastq_counts_tsv, comment = "#", show_col_types = FALSE)
  
  # Tabla interactiva de metadatos
  library(DT)
  library(htmltools)
  htmltools::div(
    class = "scroll-y-max-500",
    DT::datatable(
      per_sample_fastq_counts,
      options = list(
        scrollX = TRUE,
        paging = FALSE,
        lengthChange = FALSE,
        language = list(
          url = '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
        )
      ),
      class = 'stripe hover compact'
    )
  )
  
} else {
  cat(glue::glue('
  cat("Archivo "per-sample-fastq-counts.tsv" no encontrado. Verifica la ruta.")
  \n\n'))
}
```

```{r, results='asis'}
if (file.exists(ruta_per_sample_fastq_counts_tsv)) {

  cat(glue::glue('
  <p style="text-align:center;">
    <a href="{ruta_per_sample_fastq_counts_tsv}" target="_blank" class="boton-file">
      üíæ¬†Descargar archivo "per-sample-fastq-counts.tsv" original
    </a>
  </p>
  \n\n'))
}
```

<p>
  Junto con esta tabla, el informe genera tambi√©n un archivo <code>index.html</code> que contiene una representaci√≥n interactiva de la informaci√≥n. Este visor es especialmente √∫til porque ofrece gr√°ficas de calidad de las lecturas a lo largo de cada posici√≥n, tanto para forward como para reverse. Dichas gr√°ficas permiten localizar con claridad los puntos en los que la calidad media y la mediana comienzan a descender, lo que constituye la referencia principal para establecer los par√°metros de truncamiento (<code>trunc_len_f</code> y <code>trunc_len_r</code>) en los pasos posteriores de filtrado y depuraci√≥n con DADA2 o Deblur. Adem√°s, incluye res√∫menes de las longitudes de las secuencias y distribuciones estad√≠sticas que permiten comprobar si la mayor√≠a de las lecturas se ajustan a la regi√≥n de amplic√≥n esperada. En definitiva, el <code>index.html</code> act√∫a como una gu√≠a visual que facilita la toma de decisiones informadas sobre recortes, exclusi√≥n de muestras problem√°ticas y verificaci√≥n del solapamiento m√≠nimo necesario para el ensamblaje de pares de lectura.
</p>

<p>
  Dicho esto, incluimos dicho informe a continuaci√≥n mediante un <code>iframe</code> para poder visualizarlo de forma interactiva as√≠ como mediante un bot√≥n para poder abrirlo en pantalla completa en una nueva pesta√±a para explorarlo con m√°s detalle:
</p>

```{r, results='asis'}
# Generar iframe para Quarto si existe index.html
if (file.exists(ruta_index_html)) {

  cat(glue::glue('
  <iframe src="{ruta_index_html}" width="100%" height="700px" style="border: 1px solid #ccc; border-radius: 6px;"></iframe>

  <p style="text-align:center;">
    <a href="{ruta_index_html}" target="_blank" class="boton-iframe">
      üìä Abrir informe en nueva pesta√±a
    </a>
  </p>
  \n\n'))
}
```

<p>
  A partir de este informe, el analista puede decidir si es necesario descartar muestras con una cobertura insuficiente, revisar posibles errores de indexaci√≥n en aquellas que no presentan lecturas, o bien establecer de forma justificada los valores de truncado que maximicen la calidad de los datos sin perder la capacidad de ensamblar las lecturas forward y reverse. Todas estas decisiones deben documentarse cuidadosamente en el informe junto con las rutas a los archivos generados (<code>demux.qzv</code>, <code>per-sample-fastq-counts.tsv</code> e <code>index.html</code>), lo que asegura la trazabilidad del an√°lisis y refuerza su reproducibilidad.
</p>

<p>
  En resumen, el informe de demultiplexaci√≥n constituye el puente entre el control de calidad inicial y los pasos de trimming y depuraci√≥n. Gracias a la combinaci√≥n de tablas cuantitativas y visualizaciones interactivas, ofrece una visi√≥n clara de la calidad y cantidad de las lecturas disponibles y orienta las decisiones cr√≠ticas que determinar√°n la robustez de las etapas posteriores del pipeline.
</p>










<div class="titulo2" id="tab3-seccion2.3">
  2.3. Reflexiones finales sobre el control de calidad
</div>

<p>
  <strong>¬øPor qu√© es fundamental realizar un control de calidad en metagen√≥mica 16S?</strong><br>
</p>

<p>
  En estudios de <strong>secuenciaci√≥n de amplicones 16S</strong>, la fiabilidad de los an√°lisis posteriores depende cr√≠ticamente de la calidad de las lecturas. Detectar tempranamente problemas como baja calidad en posiciones espec√≠ficas, sesgos nucleot√≠dicos, presencia de adaptadores residuales, primers no eliminados o contaminaci√≥n cruzada es esencial para asegurar resultados precisos en etapas posteriores como el filtrado, la inferencia de variantes de secuencia (ASVs), la construcci√≥n de tablas de abundancia y los an√°lisis taxon√≥micos o funcionales.
</p>

<p>
  Una extensi√≥n clave de este control de calidad es el an√°lisis de <strong>demultiplexaci√≥n</strong> descrito en la <a href="#tab3-seccion2.2" class="normalink">secci√≥n 2.2. Informe de demultiplexaci√≥n en QIIME2</a>. All√≠ se revisa la separaci√≥n de lecturas por muestra, se comprueba que cada muestra dispone de un n√∫mero adecuado de lecturas forward y reverse y se inspeccionan las gr√°ficas de calidad y las distribuciones de longitud. Este paso permite identificar muestras con cobertura insuficiente, errores en los √≠ndices o solapamientos problem√°ticos antes de iniciar los procesos de trimming y depuraci√≥n, asegurando que los datos que ingresan al pipeline son consistentes y fiables.
</p>

<p>
  La presencia de lecturas de baja calidad o secuencias duplicadas puede introducir sesgos que afectan la estimaci√≥n de diversidad microbiana y la identificaci√≥n de OTUs o ASVs, generando posibles falsos positivos o negativos en la composici√≥n del microbioma. Por ello, un control de calidad riguroso ‚Äîque ahora incluye tanto la inspecci√≥n inicial con FastQC/MultiQC como la revisi√≥n del informe de demultiplexaci√≥n‚Äî permite definir filtros adecuados para la limpieza de datos y garantiza la reproducibilidad de los an√°lisis.
</p>

<div style="height: 5px; background-color: transparent;"></div>

<p>
  <strong>Conceptos clave a recordar:</strong>
</p>

<ul>
  <li><strong>Lecturas forward (read 1) y reverse (read 2)</strong>: fragmentos secuenciados desde ambos extremos en la t√©cnica paired-end, que aportan informaci√≥n complementaria para mejorar la resoluci√≥n de variantes de secuencia y la detecci√≥n de errores de secuenciaci√≥n.</li>
  <li><strong>M√≥dulos de FastQC</strong>: m√©tricas que eval√∫an calidad por base, contenido de GC, secuencias sobre-representadas, duplicaciones y adaptadores, permitiendo identificar problemas t√©cnicos o biol√≥gicos espec√≠ficos de cada muestra.</li>
  <li><strong>MultiQC</strong>: herramienta que integra los informes individuales de FastQC, proporcionando una visi√≥n global que facilita la identificaci√≥n de anomal√≠as consistentes entre m√∫ltiples muestras y lotes de secuenciaci√≥n.</li>
  <li><strong>Informe de demultiplexaci√≥n (2.2)</strong>: asegura que cada muestra posee un n√∫mero suficiente de lecturas, verifica la coherencia entre forward y reverse y permite identificar problemas de indexaci√≥n o de solapamiento que puedan afectar la depuraci√≥n y ensamblaje posterior.</li>
  <li><strong>Importancia para 16S</strong>: un control de calidad adecuado garantiza que la inferencia de ASVs/OTUs sea confiable, evitando errores en la taxonom√≠a y en los an√°lisis de diversidad alfa y beta.</li>
</ul>

<p>
  En conjunto, este control de calidad integral constituye un pilar indispensable en cualquier pipeline de an√°lisis de metagen√≥mica 16S. La combinaci√≥n de FastQC, MultiQC y la revisi√≥n de demultiplexaci√≥n maximiza la confianza en los datos, reduce la introducci√≥n de artefactos y asegura que los resultados biol√≥gicos reflejen de manera precisa la composici√≥n y estructura real de las comunidades microbianas estudiadas.
</p>

<p>
  Tras haber completado estas inspecciones y validaciones, se est√° preparado para proceder con la siguiente fase del flujo de trabajo, que consiste en el <a href="#tab3-seccion2.4" class="normalink">trimming y filtrado inicial</a>, donde se aplicar√°n los recortes de longitud y los filtros de calidad definidos a partir de la informaci√≥n obtenida en los pasos previos.
</p>










<div style="height: 20px; background-color: transparent;"></div>

<div class="titulo2" id="tab3-seccion2.4">
  2.4. Trimming y filtrado inicial
</div>

<p>
  Tras la evaluaci√≥n de la calidad de las lecturas, tanto a nivel global con <a href="#tab3-seccion2.1.1" class="normalink">MultiQC</a> como individual para cada muestra y direcci√≥n de lectura con <a href="#tab3-seccion2.1.2" class="normalink">FastQC</a>, y considerando la informaci√≥n detallada en el <a href="#tab3-seccion2.2" class="normalink">Informe de demultiplexaci√≥n en QIIME2</a> y las <a href="#tab3-seccion2.3" class="normalink">reflexiones finales sobre el control de calidad</a>, se plantea la fase de <em>trimming</em> y filtrado inicial de las secuencias.
</p>

<p>
  Este paso consiste en recortar regiones potencialmente problem√°ticas de las lecturas, tales como adaptadores residuales, <em>primers</em> no deseados o bases de baja calidad en los extremos. La informaci√≥n obtenida del informe de demultiplexaci√≥n ‚Äîcomo la distribuci√≥n de lecturas por muestra, la calidad por posici√≥n y la longitud de las lecturas‚Äî permite definir de forma justificada los par√°metros de truncado (<code>trunc_len_f</code> y <code>trunc_len_r</code>) y asegurar que se mantiene un solapamiento adecuado entre lecturas forward y reverse.
</p>

<p>
  Para orientar la decisi√≥n sobre qu√© recortes realizar, es fundamental observar patrones concretos en los informes de calidad y en el an√°lisis de demultiplexaci√≥n: ca√≠das de calidad en posiciones espec√≠ficas, picos an√≥malos de composici√≥n de nucle√≥tidos, duplicaciones excesivas, muestras con recuentos muy bajos o indicios de errores de indexaci√≥n o contaminaci√≥n. Estos indicadores gu√≠an la selecci√≥n de par√°metros de trimming y permiten equilibrar la limpieza de las lecturas con la preservaci√≥n de suficiente informaci√≥n para el an√°lisis.
</p>

<p>
  En conjunto, el <em>trimming</em> y filtrado inicial constituyen una preparaci√≥n cr√≠tica para la siguiente fase, en la que se aplicar√° un filtrado m√°s exhaustivo y la depuraci√≥n de errores mediante <strong>DADA2</strong>. Gracias a la integraci√≥n de la revisi√≥n de demultiplexaci√≥n, FastQC y MultiQC, se asegura que las secuencias utilizadas para generar las ASVs sean de alta calidad, representativas y consistentes, lo que garantiza la fiabilidad de los an√°lisis de abundancia y diversidad microbiana que se desarrollar√°n en las secciones posteriores.
</p>










<div style="height: 20px; background-color: transparent;"></div>

<div class="titulo2" id="tab3-seccion2.5">
  2.5. Denoising y depuraci√≥n con DADA2 / Deblur
</div>

```{r}
# Definir ruta del archivo .qzv
ruta_stats_dada2_qzv_relativa <- file.path(ruta_Def_relativa, "stats-dada2.qzv")
ruta_stats_dada2_qzv <- file.path(ruta_Def, "stats-dada2.qzv")

# Definir ruta de salida para el unzip
ruta_Def_unzip <- file.path(ruta_Def_relativa, "unzip")
ruta_unzip_stats_dada2 <- file.path(ruta_Def_unzip, "stats-dada2")

# Crear carpeta de salida si no existe
if (!dir.exists(ruta_Def_unzip)) dir.create(ruta_Def_unzip, recursive = TRUE)

# Solo hacer unzip si el archivo existe
if (file.exists(ruta_stats_dada2_qzv_relativa)) {
  # Usando system2 para llamar a unzip desde R
  system2("unzip", args = c("-o", shQuote(ruta_stats_dada2_qzv_relativa),
                            "-d", shQuote(ruta_unzip_stats_dada2)))
} else {
  message("‚ö†Ô∏è El archivo stats-dada2.qzv no existe. Se omite el unzip.")
}
```

```{r}
# Comprobar que el unzip se ha realizado
if (dir.exists(ruta_unzip_stats_dada2)) {
  
  # Listar subcarpetas dentro de la carpeta unzip (solo 1er nivel)
  subcarpetas <- list.dirs(ruta_unzip_stats_dada2, recursive = FALSE, full.names = TRUE)
  
  if (length(subcarpetas) == 0) {
    stop("No se encontr√≥ ninguna subcarpeta dentro de ", ruta_unzip_stats_dada2)
  }
  
  # Tomamos la primera subcarpeta (la aleatoria)
  carpeta_random <- subcarpetas[1]
  
  # Ruta a 'data'
  ruta_data <- file.path(carpeta_random, "data")
  
  # Archivos dentro de 'data'
  ruta_metadata_tsv <- file.path(ruta_data, "metadata.tsv")
  ruta_index_html <- file.path(ruta_data, "index.html")
  
  # Comprobar que existen
  if (!file.exists(ruta_metadata_tsv)) message("‚ö†Ô∏è metadata.tsv no encontrado")
  if (!file.exists(ruta_index_html)) message("‚ö†Ô∏è index.html no encontrado")
  
} else {
  message("‚ö†Ô∏è Carpeta de unzip no encontrada. No se puede acceder a los archivos.")
}
```


<p>
  Tras la evaluaci√≥n de la calidad de las lecturas y la posible aplicaci√≥n de <em>trimming</em> para eliminar adaptadores, primers o bases de baja calidad, se procede a la depuraci√≥n de errores mediante <strong>DADA2</strong> (o <strong>Deblur</strong>). 
  El objetivo de este paso es generar secuencias representativas √∫nicas, conocidas como ASVs (Amplicon Sequence Variants), corrigiendo errores de secuenciaci√≥n y eliminando quimeras. 
  Esta depuraci√≥n asegura que los datos que se utilicen en los an√°lisis posteriores sean fiables y comparables entre muestras.
</p>

<p>
  DADA2/Deblur toma como entrada las lecturas filtradas y produce varios outputs fundamentales. Entre ellos se incluyen:
</p>

<ul>
  <li>
    <strong>Tabla de estad√≠sticas de filtrado y depuraci√≥n</strong> (<code>stats-dada2.qzv</code>): este archivo contiene informaci√≥n detallada por muestra sobre cada paso del procesamiento de las lecturas. Incluye el n√∫mero de lecturas iniciales, las que pasaron los filtros de calidad, las que fueron <em>denoised</em>, las que se <em>merged</em> correctamente y las libres de quimeras. 
    En esta secci√≥n nos centraremos en <em>analizar estas m√©tricas</em>, ya que permiten evaluar cuantitativamente la eficiencia del filtrado y depuraci√≥n, detectar posibles p√©rdidas de datos excesivas y asegurar que las lecturas que pasan a la etapa de generaci√≥n de ASVs son fiables y representativas.
  </li>
  <li>
    <strong>Tabla de abundancia de ASVs</strong> (<code>table.qza / table.qzv</code>): esta tabla resume la frecuencia con la que cada ASV aparece en cada muestra, constituyendo la base cuantitativa para todos los an√°lisis de diversidad y composici√≥n taxon√≥mica. Cada fila representa un ASV y cada columna una muestra, con valores que reflejan el n√∫mero de lecturas asignadas a esa variante. 
    Aunque en esta secci√≥n solo se menciona su existencia, su an√°lisis detallado se realiza en la secci√≥n siguiente: 
    <a href="3-asvs-abundancia.html#tab3-seccion3" class="normalink">3. Generaci√≥n de ASVs y tabla de abundancia</a>. 
    Entender esta tabla es clave para interpretar la abundancia relativa de cada variante y la comparabilidad entre muestras.
  </li>
  <li>
    <strong>Secuencias representativas de cada ASV</strong> (<code>rep-seqs.qza / rep-seqs.qzv</code>): estas secuencias contienen la informaci√≥n exacta de cada variante encontrada tras el proceso de depuraci√≥n y son fundamentales para la identificaci√≥n taxon√≥mica y la construcci√≥n de filogenias. 
    Cada ASV se representa por una secuencia √∫nica que, junto con la tabla de abundancia, permite analizar la diversidad y composici√≥n microbiana. Su estudio tambi√©n se realiza en la secci√≥n siguiente, ya que complementa la informaci√≥n cuantitativa con la informaci√≥n de secuencia precisa de cada variante.
  </li>
</ul>

<p>
  El archivo <code>stats-dada2.qzv</code> es fundamental para documentar y comprender el proceso de depuraci√≥n de lecturas. Proporciona informaci√≥n cuantitativa por muestra sobre cada etapa del procesamiento, incluyendo:
</p>

<ul>
  <li>N√∫mero total de lecturas iniciales.</li>
  <li>Lecturas que pasaron los filtros de calidad.</li>
  <li>Lecturas <em>denoised</em> y correctamente <em>merged</em>.</li>
  <li>Lecturas libres de quimeras.</li>
</ul>

<p>
  Analizar estos datos permite responder preguntas clave, como: ¬øQu√© porcentaje de lecturas iniciales pas√≥ por todas las etapas de filtrado y depuraci√≥n? ¬øCu√°ntas se descartaron por baja calidad o por ser quimeras? ¬øCu√°ntas lecturas quedan disponibles para la construcci√≥n de ASVs? Esta evaluaci√≥n es esencial para garantizar la fiabilidad de los an√°lisis de abundancia y diversidad que se presentan posteriormente.
</p>

<p>
  Dicho archivo <code>stats-dada2.qzv</code> a partir del cu√°l se extraer√°n los datos mencionados anteriormente, se puede encontrar en el siguiente directorio que se muestra a continuaci√≥n:
</p>

```{r, results="asis"}
if (file.exists(ruta_stats_dada2_qzv)) {
  cat(glue::glue('
<code>{ruta_stats_dada2_qzv}</code>
\n\n'))
} else {
  cat(glue::glue('
‚ö†Ô∏è El archivo <code>stats-dada2.qzv</code> no existe en la ruta especificada: 
<code>{ruta_stats_dada2_qzv}</code>
\n\n'))
}
```

<p>
  Una vez evaluados estos datos, se puede proceder a la generaci√≥n de la tabla de abundancia de ASVs y al an√°lisis de diversidad microbiana, que se describen en la secci√≥n siguiente. 
</p>

<p>
  A modo de resumen, la siguiente tabla (extra√≠da de <code>stats-dada2.qzv</code>) sintetiza, por muestra, el n√∫mero de lecturas procesadas en cada paso y el porcentaje correspondiente respecto al total de lecturas de entrada, proporcionando una visi√≥n clara de la eficiencia del filtrado y depuraci√≥n.
</p>

```{r}
# Leer el archivo y mostrar tabla interactiva
if (file.exists(ruta_metadata_tsv)) {
  # Leer el archivo de metadatos generado al descomprimir
  library(readr)
  metadata <- read_tsv(ruta_metadata_tsv, comment = "#", show_col_types = FALSE)
  
  # Tabla interactiva de metadatos
  library(DT)
  htmltools::div(
    class = "scroll-y-max-500",
    DT::datatable(
      metadata,
      options = list(
        scrollX = TRUE,
        paging = FALSE,
        lengthChange = FALSE,
        language = list(
          url = '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
        )
      ),
      class = 'stripe hover compact'
    )
  )
  
} else {
  cat(glue::glue('
  cat("Archivo "metadata.tsv" no encontrado. Verifica la ruta.")
  \n\n'))
}
```

```{r, results='asis'}
if (file.exists(ruta_metadata_tsv)) {

  cat(glue::glue('
  <p style="text-align:center;">
    <a href="{ruta_metadata_tsv}" target="_blank" class="boton-file">
      üíæ¬†Descargar archivo "metadata.tsv" original
    </a>
  </p>
  \n\n'))
}
```

<p>
  De forma an√°loga, si se desea obtener m√°s detalle, el archivo <code>index.html</code> generado dentro del <code>stats-dada2.qzv</code> proporciona una visualizaci√≥n interactiva de los datos, permitiendo explorar cada paso del filtrado y depuraci√≥n.
</p>

<p>
  Mediante el siguiente visor interactivo se puede explorar dicha informaci√≥n o para una mejor visualizaci√≥n se puede hacer uso del bot√≥n que se encuentra justo debajo para abrir el informe en una p√°gina nueva en tama√±o completo:
</p>

```{r, results='asis'}
# Generar iframe para Quarto si existe index.html
if (file.exists(ruta_index_html)) {

  cat(glue::glue('
  <iframe src="{ruta_index_html}" width="100%" height="700px" style="border: 1px solid #ccc; border-radius: 6px;"></iframe>

  <p style="text-align:center;">
    <a href="{ruta_index_html}" target="_blank" class="boton-iframe">
      üìä Abrir informe en nueva pesta√±a
    </a>
  </p>
  \n\n'))
}
```

<p>
  Con la depuraci√≥n completada y las ASVs definidas, los datos quedan listos para construir la tabla de abundancia (<code>table.qza / table.qzv</code>) y para realizar los an√°lisis de diversidad microbiana, que se detallan en la siguiente secci√≥n. Esta etapa garantiza que las secuencias utilizadas sean de alta fidelidad y comparables entre todas las muestras del experimento.
</p>










<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->
<!--  CARGAR JAVASCRIPT PARA CHATBOT
<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->

<!-- Script exclusivo del chat -->
<script type="module" src="../../../../3-scripts/4-JS/chatbot.js></script>
