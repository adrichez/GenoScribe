---
title: "RNA-Seq Report"

include-in-header:
  text: |
    <link rel="shortcut icon" href="../../../1-images/0-icono/favicon.svg"/>
    <link rel="icon" type="image/x-icon" href="../../../1-images/0-icono/favicon.ico">

params:
  ruta_proyecto: ""
  nombre_experimento: ""
---


<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->
<!--  TAB 3: AN츼LISIS | 5.4. AN츼LISIS FUNCIONAL Y ENRIQUECIMIENTO -->
<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->

```{r}
library(stringr)
library(glue)
library(fs)
library(dplyr)

# Definir rutas clave
ruta_qmd <- getwd()

ruta_rnaseq_pipeline <- sub("(.*?/1-bulk-rna-seq).*", "\\1", ruta_qmd)

nombre_proyecto <- basename(params$ruta_proyecto)

ruta_nextflow_results <- file.path("..", "..", "..", "..", "..", "resources", "2-nextflow-results")
ruta_proyecto_relativa <- file.path("..", "..", "..", "..", "..", "resources", "2-nextflow-results", "1-project-data", nombre_proyecto)


# Ruta donde est치n los resultados de enriquecimiento
ruta_enrichment <- file.path(params$ruta_proyecto, "Resultados", params$nombre_experimento, "Enrichment")
ruta_enrichment_relativa <- file.path(ruta_proyecto_relativa, "Resultados", params$nombre_experimento, "Enrichment")


# Archivos
archivos_enrichment <- list.files(ruta_enrichment, pattern = "^Enrichment_.*\\.(pdf|xls)$", full.names = TRUE)
archivos_enrichment_relativa <- list.files(ruta_enrichment_relativa, pattern = "^Enrichment_.*\\.(pdf|xls)$", full.names = TRUE)


# Extraer categor칤a funcional y comparaci칩n
info_archivos <- str_match(
  basename(archivos_enrichment_relativa),
  "^Enrichment_((?:GO_(?:BP|CC|MF)|KEGG))_([^_]+_vs_[^_]+)_"
)


# Crear un data.frame con columnas 칰tiles
df_info <- data.frame(
  ruta_archivo = archivos_enrichment_relativa,
  categoria_funcional = info_archivos[,2],
  comparacion = info_archivos[,3],
  tipo = tools::file_ext(archivos_enrichment_relativa),
  stringsAsFactors = FALSE
)


# Reemplazar "_" por ":" en la columna 'categoria_funcional'
df_info$categoria_funcional <- str_replace_all(df_info$categoria_funcional, "_", ":")

# Reemplazar "_" por " " en la columna 'comparacion'
df_info$comparacion <- str_replace_all(df_info$comparacion, "_", " ")
```


<div class="informe-titulo-tab">
  <h1>Pesta침a</h1>
  <h2>An치lisis bioinform치tico completo</h2>
</div>

<div class="informe-titulo-seccion">
  <h1>Secci칩n 5</h1>
  <h2>An치lisis estad칤stico de la expresi칩n g칠nica</h2>
</div>

<div class="informe-titulo-subseccion">
  <h1>Subsecci칩n 5.4</h1>
  <h2>An치lisis funcional y enriquecimiento</h2>
</div>


<div class="informe-resumen">
  <h2>Resumen</h2>

  <p>
    Este apartado tiene como objetivo interpretar los resultados del an치lisis de expresi칩n diferencial desde una perspectiva <strong>biol칩gica funcional</strong>, utilizando herramientas de <strong>an치lisis de enriquecimiento</strong>. Una vez identificados los <strong>genes diferencialmente expresados (DEGs)</strong> entre condiciones experimentales, se eval칰a si determinadas <em>funciones biol칩gicas</em>, <em>procesos celulares</em> o <em>rutas metab칩licas</em> est치n sobrerrepresentadas entre estos genes.
  </p>

  <p>
    Para ello, se emplean bases de datos ampliamente reconocidas como <strong>Gene Ontology</strong> (categor칤as <em>Biological Process</em>, <em>Molecular Function</em> y <em>Cellular Component</em>) y <strong>KEGG</strong>, que permiten relacionar los genes con funciones conocidas en organismos modelo. El an치lisis se realiza de forma individual para cada <em>comparaci칩n por pares</em> entre condiciones, lo que permite contextualizar los efectos de cada contraste experimental dentro de marcos funcionales espec칤ficos.
  </p>

  <p>
    Cada conjunto de resultados incluye una tabla interactiva con los <strong>t칠rminos enriquecidos</strong> y sus estad칤sticas asociadas (como valores <em>p</em> ajustados y n칰mero de genes implicados), as칤 como <strong>representaciones gr치ficas</strong> (barplots o dotplots) que resumen visualmente los hallazgos m치s relevantes. Esta informaci칩n facilita la priorizaci칩n de rutas y procesos que podr칤an estar involucrados en las diferencias observadas, ofreciendo hip칩tesis biol칩gicas interpretables.
  </p>

  <p>
    En conjunto, este an치lisis constituye una pieza clave para vincular los cambios transcripcionales con mecanismos funcionales subyacentes, aportando <strong>valor biol칩gico</strong> y <strong>contexto mecan칤stico</strong> a los datos obtenidos en las etapas anteriores del pipeline de expresi칩n g칠nica.
  </p>
</div>










<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo-toc">
  Tabla de contenidos de esta subsecci칩n
</div>


```{=html}
```{r, results="asis"}
cat('
<div class="toc">
  <ul>
    <li>
      <a href="5-Analisis-estadistico.html#tab3-seccion5">
        5<span>.</span> An치lisis estad칤stico de la expresi칩n g칠nica
      </a>
      <ul>
        <li>
          <a href="#tab3-seccion5.4">
            5.4. An치lisis funcional y enriquecimiento
          </a>
          <ul>
')

comparaciones <- unique(df_info$comparacion)
for (i in seq_along(comparaciones)) {
  comp <- comparaciones[i]
  cat(glue::glue('
            <li>
              <a href="#tab3-seccion5.4.{i}">
                5.4.{i}. Comparaci칩n: {comp}
              </a>
              <ul>
  '))

  subset_comp <- df_info[df_info$comparacion == comp, ]
  categorias <- unique(subset_comp$categoria_funcional)

  for (j in seq_along(categorias)) {
    categ <- categorias[j]
    cat(glue::glue('
                <li>
                  <a href="#tab3-seccion5.4.{i}.{j}">
                    5.4.{i}.{j}. Categor칤a funcional: {categ}
                  </a>
                </li>
    '))
  }

  cat('
              </ul>
            </li>
  ')
}

cat('
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</div>
')
```
```

```{=html}
```










<!-- #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->
<!-- REDACCI칍N -->
<!-- #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->

<div style="height: 20px; background-color: transparent;"></div>

<div class="titulo2" id="tab3-seccion5.4">
  5.4. An치lisis funcional y enriquecimiento
</div>

<p>
  Una vez identificados los genes diferencialmente expresados (DEG) entre condiciones experimentales, resulta fundamental interpretar estos cambios en un contexto biol칩gico m치s amplio. 
  Para ello, se lleva a cabo un <strong>an치lisis funcional y de enriquecimiento</strong>, que permite detectar si ciertas funciones, procesos biol칩gicos o rutas metab칩licas est치n representadas de forma significativa entre los genes alterados.
</p>

<p>
  Este tipo de an치lisis se basa en comparar la lista de genes identificados como diferencialmente expresados frente a bases de datos funcionales ampliamente validadas, con el fin de identificar categor칤as que aparecen m치s frecuentemente de lo esperado por azar.
</p>

<p>
  En este proyecto, el an치lisis de enriquecimiento se ha realizado para cada una de las comparaciones entre condiciones, utilizando las siguientes bases de datos:
</p>

<ul>
  <li><strong>Gene Ontology - Biological Process (GO:BP):</strong> Procesos biol칩gicos en los que participan los genes, como "respuesta al estr칠s" o "regulaci칩n del ciclo celular".</li>
  <li><strong>Gene Ontology - Molecular Function (GO:MF):</strong> Funciones moleculares de los productos g칠nicos, como "actividad transcriptasa inversa" o "uni칩n a ATP".</li>
  <li><strong>Gene Ontology - Cellular Component (GO:CC):</strong> Localizaci칩n o complejos celulares donde act칰an los productos g칠nicos, como "membrana plasm치tica" o "nucleoplasma".</li>
  <li><strong>KEGG:</strong> Rutas metab칩licas y de se침alizaci칩n conocidas, como "v칤a MAPK", "bios칤ntesis de flavonoides" o "respuesta a pat칩genos".</li>
</ul>

<p>
  Para cada categor칤a y comparaci칩n, se presentan dos tipos de resultados:
</p>

<ul>
  <li>Un archivo <strong>PDF</strong> con una representaci칩n visual de los t칠rminos m치s enriquecidos (normalmente barplots o dotplots).</li>
  <li>Un archivo <strong>Excel (.xls)</strong> con el listado detallado de todos los t칠rminos significativos, ordenados por valor de <em>p</em> o FDR, junto con el n칰mero de genes implicados.</li>
</ul>

<p>
  A continuaci칩n, se listan los resultados de enriquecimiento funcional para cada comparaci칩n analizada en este experimento, organizados por categor칤as GO (BP, CC y MF) y KEGG.
</p>

<div class="box-files-nested">

```{r, results='asis'}
# Funci칩n para asignar clase por extensi칩n
asignar_clase <- function(nombre_archivo) {
  if (grepl("\\.html$", nombre_archivo)) {
    "file-html"
  } else if (grepl("\\.zip$", nombre_archivo)) {
    "file-zip"
  } else if (grepl("\\.fastq(\\..+)?\\.gz$", nombre_archivo)) {
    "file-fastqgz"
  } else if (grepl("\\.bam$", nombre_archivo)) {
    "file-bam"
  } else if (grepl("\\.bai$", nombre_archivo)) {
    "file-bai"
  } else if (grepl("\\.sam$", nombre_archivo)) {
    "file-sam"
  } else if (grepl("\\.metrics$", nombre_archivo)) {
    "file-metrics"
  } else if (grepl("\\.ht2$", nombre_archivo)) {
    "file-ht2"
  } else if (grepl("\\.xlsx$", nombre_archivo)) {
    "file-xlsx"
  } else if (grepl("\\.xls$", nombre_archivo)) {
    "file-xls"
  } else if (grepl("\\.pdf$", nombre_archivo)) {
    "file-pdf"
  } else {
    "file-default"
  }
}

# Verificar si hay archivos
if (nrow(df_info) == 0) {
  cat('<p><em>No se encontraron archivos de enriquecimiento funcional en la ruta especificada.</em></p>\n')
} else {
  cat("<ol>\n")  # Lista numerada de comparaciones
  
  for (comp in unique(df_info$comparacion)) {
    cat(glue::glue('<li><strong>{comp}</strong>\n<ul style="margin-top: 4px; margin-bottom: 4px;">\n'))
    
    # Filtrar archivos de esta comparaci칩n
    subset_comp <- df_info[df_info$comparacion == comp, ]
    
    for (cat in unique(subset_comp$categoria_funcional)) {
      subset_cat <- subset_comp[subset_comp$categoria_funcional == cat, ]
      
      # Obtener rutas
      ruta_archivo_xls <- subset_cat$ruta_archivo[subset_cat$tipo == "xls"]
      ruta_archivo_pdf <- subset_cat$ruta_archivo[subset_cat$tipo == "pdf"]
      
      # Asignar clases
      clase_xls <- if (length(ruta_archivo_xls)) asignar_clase(ruta_archivo_xls) else NULL
      clase_pdf <- if (length(ruta_archivo_pdf)) asignar_clase(ruta_archivo_pdf) else NULL
      
      # Mostrar si existen
      cat(glue::glue('<li style="margin: 0;"><strong>{cat}</strong>\n<ul style="margin: 0 0 4px 12px;">\n'))
      
      if (length(ruta_archivo_xls)) {
        cat(glue::glue('<li class="{clase_xls}" style="margin: 0;"><a href="{ruta_archivo_xls}" target="_blank">Tabla de resultados (.xls)</a></li>\n'))
      }
      
      if (length(ruta_archivo_pdf)) {
        cat(glue::glue('<li class="{clase_pdf}" style="margin: 0;"><a href="{ruta_archivo_pdf}" target="_blank">Gr치fico resumen (.pdf)</a></li>\n'))
      }
      
      cat('</ul></li>\n')
    }
    
    cat("</ul></li>\n\n")
  }
  
  cat("</ol>\n")
}
```

</div>

```{r, results="asis"}
# Para que funcione con rutas absolutas
enlace <- ruta_enrichment_relativa

# Imprimir el enlace
cat(glue::glue('

<p style="text-align:center;">
  <a href="{enlace}" target="_blank" class="boton-files">
    游늭 Explora los archivos de la carpeta "Enrichment" aqu칤
  </a>
</p>

<div style="height: 15px; background-color: transparent;"></div>
\n\n'))
```

<p>
  Seguidamente, se presenta un resumen estructurado de los an치lisis de enriquecimiento funcional realizados para cada comparaci칩n entre condiciones experimentales. 
  Para cada una de ellas se han considerado cuatro categor칤as funcionales principales: <strong>GO:BP</strong> (procesos biol칩gicos), <strong>GO:MF</strong> (funciones moleculares), <strong>GO:CC</strong> (componentes celulares) y <strong>KEGG</strong> (rutas metab칩licas y de se침alizaci칩n). 
</p>

<p style="margin-bottom: 0.3em;">
  En los siguientes apartados se profundiza en los resultados obtenidos por comparaci칩n. Cada secci칩n incluye:
</p>

<ul style="margin-top: 0; margin-bottom: 0.3em;">
  <li>Una visualizaci칩n <strong>interactiva</strong> de las tablas de t칠rminos enriquecidos, con informaci칩n como valores de p ajustados (FDR), n칰mero de genes implicados y descripci칩n funcional.</li>
  <li>Un enlace al <strong>documento PDF</strong> correspondiente, que resume gr치ficamente los t칠rminos m치s significativos (normalmente mediante barplots o dotplots).</li>
</ul>

<p style="margin-top: 0.8em;">
  Este an치lisis permite identificar las funciones biol칩gicas y rutas m치s relevantes en cada contexto experimental, facilitando as칤 la interpretaci칩n biol칩gica de los genes diferencialmente expresados.
</p>

```{r}
library(readxl)
library(DT)
library(htmltools)
library(glue)
library(ggplot2)
library(plotly)
library(dplyr)

secciones <- tagList()  # Contenedor general

comparaciones <- unique(df_info$comparacion)

for (comp in comparaciones) {
  # Contador para el t칤tulo de la comparaci칩n
  i <- 1

  # T칤tulo general de la comparaci칩n
  seccion_comp <- tagList(
    HTML(glue('
      <div style="height: 15px; background-color: transparent;"></div>

      <div class="titulo3" id="tab3-seccion5.4.{i}" style="padding-bottom: 10px;">
        5.4.{i}. Comparaci칩n: {comp}
      </div>

      <div style="height: 15px; background-color: transparent;"></div>

      <p>
        La comparaci칩n <strong>{comp}</strong> corresponde al an치lisis diferencial de expresi칩n entre dos condiciones biol칩gicas o experimentales espec칤ficas dentro del dise침o del estudio. Este an치lisis tiene como objetivo identificar los genes cuya actividad transcripcional var칤a significativamente entre ambos grupos, lo que puede reflejar procesos fisiol칩gicos, respuestas celulares o mecanismos moleculares relevantes.
      </p>

      <p>
        A partir de los genes diferencialmente expresados (DEGs) detectados, se han llevado a cabo an치lisis de enriquecimiento funcional que permiten asociar dichos genes con funciones biol칩gicas, procesos celulares o rutas metab칩licas. De este modo, se busca interpretar los cambios observados en un contexto funcional m치s amplio, facilitando la comprensi칩n de las posibles implicaciones biol칩gicas derivadas de la comparaci칩n <strong>{comp}</strong>.
      </p>
    '))
  )
  
  # Subset para esta comparaci칩n
  subset_comp <- df_info[df_info$comparacion == comp, ]

  categorias <- unique(subset_comp$categoria_funcional)
  
  for (categ in categorias) {
    # Contador para el t칤tulo de la comparaci칩n
    j <- 1

    # Escoger la categor칤a actual
    subset_categ <- subset_comp[subset_comp$categoria_funcional == categ, ]
    
    # Rutas relevantes
    ruta_archivo_xls <- subset_categ$ruta_archivo[subset_categ$tipo == "xls"]
    ruta_archivo_pdf <- subset_categ$ruta_archivo[subset_categ$tipo == "pdf"]
    
    if (length(ruta_archivo_xls) > 0) {
      tmp <- read.csv(ruta_archivo_xls, sep = "\t", row.names = 1, check.names = FALSE)
      if (any(duplicated(rownames(tmp)))) {
        rownames(tmp) <- make.unique(rownames(tmp))
      }
      
      seccion_categ <- tagList(
        HTML(glue('
          <div style="height: 10px; background-color: transparent;"></div>

          <div class="titulo4" id="tab3-seccion5.4.{i}.{j}" style="padding-bottom: 10px;">
            5.4.{i}.{j}. Categor칤a funcional: {categ}
          </div>

          <div style="height: 10px; background-color: transparent;"></div>
        ')),
        
        HTML(glue('
          <p>
            La presente secci칩n se centra en la categor칤a funcional <strong>{categ}</strong>, la cual agrupa un conjunto de genes asociados a funciones biol칩gicas espec칤ficas que podr칤an estar involucradas en los cambios observados entre las condiciones comparadas en <strong>{comp}</strong>. El an치lisis de enriquecimiento permite identificar si esta categor칤a est치 sobrerrepresentada entre los genes diferencialmente expresados, lo que puede se침alar una implicaci칩n funcional relevante en el contexto experimental.
          </p>

          <p>
            A continuaci칩n se presenta la tabla con los t칠rminos enriquecidos dentro de esta categor칤a, junto con los par치metros estad칤sticos asociados. Estos resultados permiten priorizar funciones o procesos celulares que podr칤an estar siendo modulados como respuesta al tratamiento o condici칩n evaluada.
          </p>
        ')),
        
        htmltools::div(
          class = "scroll-y-max-500",
          DT::datatable(
            tmp,
            options = list(
              scrollX = TRUE,
              paging = FALSE,
              lengthChange = FALSE,
              language = list(url = '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json')
            ),
            class = 'stripe hover compact'
          ),
          tags$hr()
        ),
        
        HTML(glue('
          <div style="height: 40px; background-color: transparent;"></div>

          <p>
            Acto seguido, se presentan las visualizaciones generadas a partir del an치lisis de enriquecimiento funcional para la categor칤a <strong>{categ}</strong>. Estas gr치ficas permiten explorar de forma intuitiva los t칠rminos o rutas biol칩gicas sobrerrepresentadas, as칤 como su relevancia estad칤stica y su relaci칩n con los genes detectados en la comparaci칩n <strong>{comp}</strong>.
          </p>

          <p>
            Dependiendo del tipo de an치lisis realizado, los resultados pueden incluir gr치ficos de barras con los t칠rminos GO m치s significativos, mapas de rutas metab칩licas (como los proporcionados por KEGG), o representaciones tipo grafo que reflejan las conexiones funcionales entre los t칠rminos enriquecidos. Estas visualizaciones complementan la tabla de resultados y ayudan a interpretar los datos desde una perspectiva biol칩gica m치s integrada.
          </p>
        ')),
        
        if (length(ruta_archivo_pdf) > 0) HTML(glue('
          <iframe src="{ruta_archivo_pdf}" width="100%" height="600px" style="border: 1px solid #ccc; border-radius: 6px;"></iframe>

          <div style="height: 10px; background-color: transparent;"></div>

          <p style="text-align:center;">
            <a href="{ruta_archivo_pdf}" target="_blank" class="boton-iframe">
              游댌 Ver el documento PDF en una nueva pesta침a
            </a>
          </p>

          <div style="height: 15px; background-color: transparent;"></div>
        ')) else HTML('<p><em>No se encontr칩 el documento PDF con los gr치ficos para esta categor칤a.</em></p>')
      )
      
      # Agregar la subsecci칩n de categor칤a a la secci칩n de la comparaci칩n
      seccion_comp <- tagAppendChild(seccion_comp, seccion_categ)
    }

    # Incrementar el contador del t칤tulo de la categor칤a
    j <- i + 1
  }
  
  # Agregar la secci칩n completa de esta comparaci칩n al contenedor principal
  secciones <- tagAppendChild(secciones, seccion_comp)

  # Incrementar el contador del t칤tulo de la comparaci칩n
  i <- i + 1
}

# Mostrar el contenido final en el documento
browsable(secciones)
```

<div style="height: 5px; background-color: transparent;"></div>

---

<p>
  Con este an치lisis funcional y de enriquecimiento se culmina el flujo de trabajo completo de an치lisis de expresi칩n g칠nica, desde la evaluaci칩n inicial de la calidad de las lecturas hasta la interpretaci칩n biol칩gica de los genes diferencialmente expresados. 
  A lo largo de este proceso, hemos transformado datos brutos de secuenciaci칩n en informaci칩n biol칩gicamente significativa, permitiendo no solo identificar genes con patrones de expresi칩n relevantes, sino tambi칠n contextualizarlos dentro de rutas y procesos celulares clave. 
  Este enfoque sistem치tico no solo proporciona una comprensi칩n m치s profunda de los mecanismos moleculares implicados en las condiciones estudiadas, sino que tambi칠n sienta las bases para futuras hip칩tesis experimentales, validaciones funcionales o estrategias terap칠uticas.
</p>