---
title: "Metagenomic Report"

include-in-header:
  text: |
    <link rel="shortcut icon" href="../../../../1-images/icono/favicon.svg"/>
    <link rel="icon" type="image/x-icon" href="../../../../1-images/icono/favicon.ico">

params:
  ruta_proyecto: ""
  tipo_analisis: ""
---


<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->
<!--  CHATBOT
<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->

<div id="chat-container">
  <button id="chat-toggle"></button>
  <div id="chat-box">
    <div id="chat-log"></div>
    <input id="chat-input" type="text" placeholder="Escribe tu pregunta..."/>
  </div>
</div>










<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->
<!--  TAB 3: AN√ÅLISIS | 3. GENERACI√ìN DE ASVs Y TABLA DE ABUNDANCIA -->
<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->

```{r}
# Cargar librer√≠as
library(glue)
library(fs)
library(stringr)
library(dplyr)


# Rutas clave
ruta_qmd <- getwd()
ruta_metagenomic_pipeline <- file.path("..", "..", "..", "..", "..", "..")
nombre_proyecto <- basename(params$ruta_proyecto)


# Rutas de resultados Nextflow
ruta_nextflow_results <- file.path("..", "..", "..", "..", "..", "..", "resources", "2-nextflow-results")
ruta_proyecto_relativa <- file.path("..", "..", "..", "..", "..", "..", "resources", "2-nextflow-results", "1-project-data", nombre_proyecto)


# Rutas de la carpeta Def
ruta_Def <- file.path(params$ruta_proyecto, "Resultados", "Def")
ruta_Def_relativa <- file.path(ruta_proyecto_relativa, "Resultados", "Def")


# Rutas del archivo de metadatos
ruta_Def_sample_metadata <- file.path(ruta_Def, "sample-metadata.tsv")
ruta_Def_sample_metadata_relativa <- file.path(ruta_Def_relativa, "sample-metadata.tsv")
```


<div class="informe-titulo-tab">
  <h1>Pesta√±a</h1>
  <h2>An√°lisis 16S bioinform√°tico completo</h2>
</div>

<div class="informe-titulo-seccion">
  <h1>Secci√≥n 3</h1>
  <h2>Generaci√≥n de ASVs y tabla de abundancia</h2>
</div>

<div class="flecha-abajo">
  ‚ñº
</div>


<div class="informe-resumen">
  <h2>Resumen</h2>

  <p>
    En esta tercera secci√≥n se describe el proceso de <strong>generaci√≥n de ASVs (Amplicon Sequence Variants)</strong> y la construcci√≥n de la correspondiente <strong>tabla de abundancia</strong>, pasos fundamentales que constituyen el n√∫cleo de cualquier an√°lisis metagen√≥mico basado en amplicones. A partir de los datos depurados en fases previas (control de calidad, demultiplexaci√≥n y correcci√≥n de errores mediante DADA2), se obtienen las secuencias finales que servir√°n de base para caracterizar la composici√≥n microbiana de las muestras.
  </p>

  <p>
    Este bloque se organiza en tres apartados que permiten comprender con detalle la l√≥gica del flujo de trabajo y el papel de cada resultado:
  </p>

  <ul>
    <li>
      <strong>3.1 Concepto y obtenci√≥n de ASVs:</strong> se introduce qu√© son las ASVs, c√≥mo difieren de los OTUs cl√°sicos y por qu√© aportan mayor resoluci√≥n taxon√≥mica. Se explica el procedimiento mediante el cual QIIME2 (a trav√©s de DADA2) genera estas secuencias √∫nicas corrigiendo errores de secuenciaci√≥n y eliminando quimeras.
    </li>

    <li>
      <strong>3.2 Secuencias representativas:</strong> se presentan las secuencias contenidas en <code>rep-seqs.qza</code> (o <code>rep-seqs.qzv</code>), examinando su distribuci√≥n de longitudes y la diversidad de variantes detectadas. Estas secuencias servir√°n de referencia para la posterior asignaci√≥n taxon√≥mica y para relacionarlas con la abundancia en cada muestra.
    </li>

    <li>
      <strong>3.3 Tabla de abundancia de ASVs:</strong> se detalla la extracci√≥n de la matriz de abundancia desde <code>table.qza</code> (subsecci√≥n 3.3.1), que contiene la frecuencia de cada ASV en las muestras, y la exploraci√≥n de los archivos de resumen y visualizaci√≥n contenidos en <code>table.qzv</code> (subsecci√≥n 3.3.2). Se explica c√≥mo estos recursos permiten verificar la cobertura de secuenciaci√≥n, explorar la frecuencia global de ASVs y acceder a visualizaciones interactivas mediante <code>index.html</code>.
    </li>
  </ul>

  <p>
    Los resultados de esta secci√≥n incluyen tanto <code>artefactos .qza</code> como sus visualizaciones en <code>.qzv</code>. Para facilitar la interpretaci√≥n, se muestran tablas interactivas en R con m√©tricas resumidas (como n√∫mero total de lecturas por muestra y frecuencia de cada ASV) y se integran <code>iframe</code> con los archivos <code>index.html</code> para acceder a la visualizaci√≥n din√°mica de la matriz de abundancia.
  </p>

  <p>
    En conjunto, esta secci√≥n proporciona una visi√≥n clara y estructurada de las variantes de secuencia y de su distribuci√≥n entre muestras, preparando el terreno para los an√°lisis de <a href="4-diversidad.html#tab3-seccion4" class="normalink">diversidad microbiana</a> que se abordar√°n en la siguiente secci√≥n, incluyendo diversidad alfa y beta y su interpretaci√≥n biol√≥gica.
  </p>
</div>











<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo-toc">
  Tabla de contenidos de esta secci√≥n
</div>

<div class="toc">
  <ul>
    <li>
      <a href="#tab3-seccion3">
        3<span>.</span> Generaci√≥n de ASVs y tabla de abundancia
      </a>
      <ul>
        <li>
          <a href="#tab3-seccion3.1">
            3.1. Concepto y obtenci√≥n de ASVs
          </a>
        </li>
        <li>
          <a href="#tab3-seccion3.2">
            3.2. Secuencias representativas
          </a>
        </li>
        <li>
          <a href="#tab3-seccion3.3">
            3.3. Tabla de abundancia de ASVs
          </a>
          <ul>
            <li>
              <a href="#tab3-seccion3.3.1">
                3.3.1. Extracci√≥n de la matriz de abundancia desde table.qza
              </a>
            </li>
            <li>
              <a href="#tab3-seccion3.3.2.">
                3.3.2. Exploraci√≥n de los resultados en table.qzv
              </a>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</div>










<!-- #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->
<!-- REDACCI√ìN -->
<!-- #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->

<div style="height: 25px; background-color: transparent;"></div>

<div class="titulo1" id="tab3-seccion3">
  3<span>.</span> Alineamiento de las lecturas contra el genoma de referencia
</div>

<p>
  Tras completar el proceso de control de calidad y la depuraci√≥n de las lecturas mediante QIIME2, el siguiente paso clave en el an√°lisis consiste en la <strong>generaci√≥n de variantes de secuencia de amplic√≥n (ASVs)</strong> y la construcci√≥n de una <strong>tabla de abundancia</strong>. Este procedimiento es esencial porque traduce los datos de secuenciaci√≥n en entidades biol√≥gicas interpretables, permitiendo cuantificar con precisi√≥n qu√© variantes de secuencia est√°n presentes en cada muestra y con qu√© frecuencia.
</p>

<p>
  En este bloque, se aborda c√≥mo se obtienen estas unidades representativas a trav√©s del proceso de <em>denoising</em> y eliminaci√≥n de errores, se presentan las <strong>secuencias representativas</strong> que servir√°n como base para la asignaci√≥n taxon√≥mica y se organiza la informaci√≥n en una matriz de abundancia que resume la presencia de cada ASV en las distintas muestras. 
</p>

<p>
  De esta forma, los resultados aqu√≠ expuestos constituyen el <strong>n√∫cleo central</strong> sobre el que se sustentan las fases posteriores del an√°lisis, como el estudio de la diversidad alfa y beta o la caracterizaci√≥n taxon√≥mica de la comunidad microbiana. 
  A continuaci√≥n, en el siguiente apartado, se profundizar√° en el <strong>concepto y obtenci√≥n de ASVs</strong>, explicando con detalle qu√© representan y c√≥mo se generan en el contexto de este an√°lisis.
</p>










<div style="height: 20px; background-color: transparent;"></div>

<div class="titulo2" id="tab3-seccion3.1">
  3.1. Concepto y obtenci√≥n de ASVs
</div>

<p>
  En el an√°lisis metagen√≥mico basado en amplicones, las <strong>Amplicon Sequence Variants (ASVs)</strong> representan la unidad fundamental de informaci√≥n. Cada ASV corresponde a una secuencia √∫nica inferida tras corregir los errores de secuenciaci√≥n, lo que permite una resoluci√≥n mucho mayor que la ofrecida por los <strong>OTUs</strong> tradicionales, que agrupan lecturas seg√∫n un umbral de similitud arbitrario, t√≠picamente del 97%. Mientras que los OTUs dependen de la elecci√≥n del umbral y del m√©todo de clustering, las ASVs son reproducibles entre experimentos y plataformas siempre que se emplee el mismo flujo de trabajo, lo que posibilita comparaciones precisas y consistentes.
</p>

<p>
  La obtenci√≥n de ASVs se basa en un proceso de correcci√≥n de errores y eliminaci√≥n de artefactos que transforma las lecturas depuradas (ya filtradas tras el control de calidad y la eliminaci√≥n de primers/adaptadores) en un conjunto de secuencias exactas. Usando herramientas como <strong>DADA2</strong> dentro de QIIME2, el flujo de trabajo general incluye la modelizaci√≥n del error de la plataforma, la dereplicaci√≥n de lecturas id√©nticas, la inferencia de variantes biol√≥gicas reales, la fusi√≥n de lecturas emparejadas y la eliminaci√≥n de quimeras generadas durante la PCR. El resultado final de este proceso es un conjunto de ASVs y la correspondiente tabla de abundancia, que reflejan la frecuencia de cada variante en cada muestra.
</p>

<p>
  La construcci√≥n de estas tablas es fundamental, ya que constituyen la base para el c√°lculo de m√©tricas de diversidad alfa y beta, comparaciones estad√≠sticas entre condiciones experimentales y posteriores asignaciones taxon√≥micas. Las ASVs permiten identificar variantes que difieren incluso en un solo nucle√≥tido, posibilitando un an√°lisis m√°s fino y preciso de la composici√≥n microbiana, as√≠ como la detecci√≥n de biomarcadores y la realizaci√≥n de an√°lisis filogen√©ticos.
</p>

<p>
  En t√©rminos pr√°cticos, nos hemos centrado en los archivos <code>.qzv</code> generados por QIIME2 para extraer la informaci√≥n relevante sobre las ASVs. Estos archivos permiten explorar de forma interactiva la distribuci√≥n de lecturas, la longitud de las secuencias y su prevalencia entre muestras. Para obtener los datos y visualizaciones, se ha realizado un descompresionado controlado de los <code>.qzv</code>, accediendo a archivos como <code>sequences.fasta</code>, <code>sample-frequency-detail.csv</code>, <code>feature-frequency-detail.csv</code> y los respectivos <code>index.html</code> contenidos en su interior.
</p>

<p>
  Este enfoque permite reportar de manera clara y concisa indicadores clave como el n√∫mero total de ASVs detectadas, la retenci√≥n de lecturas tras cada paso del denoising, la distribuci√≥n de longitudes de las secuencias, la abundancia relativa y la prevalencia de cada ASV. Adem√°s, facilita la inspecci√≥n detallada de las secuencias y la verificaci√≥n de los resultados obtenidos, garantizando la reproducibilidad y la trazabilidad del an√°lisis.
</p>

<p>
  En conjunto, centrarse en los archivos <code>.qzv</code> proporciona una visi√≥n completa y precisa de las variantes de secuencia presentes en las muestras, combinando tablas resumidas con visualizaci√≥n interactiva. Esta base es s√≥lida para los an√°lisis posteriores de <a href="4-diversidad.html#tab3-seccion4" class="normalink">diversidad microbiana</a> y la interpretaci√≥n biol√≥gica de los resultados. Los detalles concretos de los resultados se presentan en los siguientes apartados.
</p>









<div style="height: 20px; background-color: transparent;"></div>

<div class="titulo2" id="tab3-seccion3.2">
  3.2. Secuencias representativas
</div>

```{r}
# Definir ruta del archivo .qzv
ruta_rep_seqs_qzv_relativa <- file.path(ruta_Def_relativa, "rep-seqs.qzv")
ruta_rep_seqs_qzv <- file.path(ruta_Def, "rep-seqs.qzv")

# Definir ruta del archivo .qza
ruta_rep_seqs_qza_relativa <- file.path(ruta_Def_relativa, "rep-seqs.qza")
ruta_rep_seqs_qza <- file.path(ruta_Def, "rep-seqs.qza")

# Definir ruta de salida para el unzip
ruta_Def_unzip <- file.path(ruta_Def_relativa, "unzip")
ruta_unzip_rep_seqs <- file.path(ruta_Def_unzip, "rep-seqs")

# Crear carpeta de salida si no existe
if (!dir.exists(ruta_Def_unzip)) dir.create(ruta_Def_unzip, recursive = TRUE)

# Solo hacer unzip si el archivo existe
if (file.exists(ruta_rep_seqs_qzv_relativa)) {
  # Usando system2 para llamar a unzip desde R
  system2("unzip", args = c("-o", shQuote(ruta_rep_seqs_qzv_relativa),
                            "-d", shQuote(ruta_unzip_rep_seqs)))
} else {
  message("‚ö†Ô∏è El archivo rep-seqs.qzv no existe. Se omite el unzip.")
}
```

```{r}
# Comprobar que el unzip se ha realizado
if (dir.exists(ruta_unzip_rep_seqs)) {
  
  # Listar subcarpetas dentro de la carpeta unzip (solo 1er nivel)
  subcarpetas <- list.dirs(ruta_unzip_rep_seqs, recursive = FALSE, full.names = TRUE)
  
  if (length(subcarpetas) == 0) {
    stop("No se encontr√≥ ninguna subcarpeta dentro de ", ruta_unzip_rep_seqs)
  }
  
  # Tomamos la primera subcarpeta (la aleatoria generada por QIIME2)
  carpeta_random <- subcarpetas[1]
  
  # Ruta a 'data'
  ruta_data <- file.path(carpeta_random, "data")
  
  # Archivos dentro de 'data'
  ruta_sequences_fasta <- file.path(ruta_data, "sequences.fasta")
  ruta_index_html <- file.path(ruta_data, "index.html")
  
  # Comprobar que existen
  if (!file.exists(ruta_sequences_fasta)) message("‚ö†Ô∏è sequences.fasta no encontrado")
  if (!file.exists(ruta_index_html)) message("‚ö†Ô∏è index.html no encontrado")
  
} else {
  message("‚ö†Ô∏è Carpeta de unzip no encontrada. No se puede acceder a los archivos.")
}
```

<p>
  En esta subsecci√≥n se analizan en detalle las <strong>secuencias representativas</strong> obtenidas tras la generaci√≥n de ASVs, que constituyen la unidad b√°sica para caracterizar la diversidad microbiana de cada muestra. Para ello, se parte del archivo <code>rep-seqs.qzv</code> generado por QIIME2, que combina tanto los datos de secuencias finales como las visualizaciones interactivas asociadas. Estas visualizaciones permiten explorar aspectos clave como la longitud de los amplicones, la abundancia de cada variante y su prevalencia entre muestras, lo que facilita detectar posibles secuencias at√≠picas o artefactos antes de proceder a los an√°lisis posteriores.
</p>

<p>
  El primer paso consiste en descomprimir el archivo <code>.qzv</code> para acceder a su contenido interno. QIIME2 genera carpetas con nombres aleatorios que incluyen la informaci√≥n de las secuencias y la visualizaci√≥n. Dentro de estas carpetas se encuentran dos elementos esenciales: 
  <code>sequences.fasta</code>, que contiene todas las secuencias representativas detectadas, y 
  <code>index.html</code>, que ofrece una visualizaci√≥n interactiva de los resultados. Esta organizaci√≥n permite un acceso reproducible a los datos y facilita la integraci√≥n de los mismos en informes automatizados.
</p>

<p>
  Cabe mencionar que el archivo <code>sequences.fasta</code> contiene los mismos datos que la matriz que obtendr√≠amos leyendo el propio artefacto <code>rep-seqs.qza</code> mediante el paquete <strong>qiime2R</strong>, carg√°ndolo con la funci√≥n <code>read_qza()</code> y luego accediento a los datos crudos mediante el elemento <code>$data</code>.
</p>

<p>
  Dicho esto, las rutas de los archivos <code>rep-seqs.qzv</code> y <code>rep-seqs.qza</code> se pueden encontrar en los siguientes directorios:
</p>

```{r, results="asis"}
if (file.exists(ruta_rep_seqs_qzv)) {
  cat(glue::glue('
<code>{ruta_rep_seqs_qzv}</code>
\n\n'))
} else {
  cat(glue::glue('
‚ö†Ô∏è El archivo <code>rep-seqs.qzv</code> no existe en la ruta especificada: 
<code>{ruta_rep_seqs_qzv}</code>
\n\n'))
}
```

```{r, results="asis"}
if (file.exists(ruta_rep_seqs_qza)) {
  cat(glue::glue('
<code>{ruta_rep_seqs_qza}</code>
\n\n'))
} else {
  cat(glue::glue('
‚ö†Ô∏è El archivo <code>rep-seqs.qza</code> no existe en la ruta especificada: 
<code>{ruta_rep_seqs_qza}</code>
\n\n'))
}
```

<p>
  Una vez extra√≠do el contenido, se construye una <strong>tabla interactiva</strong> en R a partir del archivo <code>sequences.fasta</code>. Esta tabla resume para cada ASV su identificador (<em>Feature ID</em>), la longitud de la secuencia y la propia secuencia nucleot√≠dica. La longitud de la secuencia permite evaluar si los amplicones cumplen con el tama√±o esperado del marcador (por ejemplo, V3-V4 del 16S), y detectar secuencias truncadas o extendidas que podr√≠an indicar errores de secuenciaci√≥n o quimeras no eliminadas.
</p>

<p>
  Adem√°s, para facilitar la interpretaci√≥n y visualizaci√≥n r√°pida de patrones, cada nucle√≥tido se colorea seg√∫n su tipo (<span style='color: #2ECC71'>A</span>, <span style='color: #E74C3C'>T</span>, <span style='color: #F1C40F'>G</span>, <span style='color: #3498DB'>C</span> y <span style='color: #7F8C8D'>N</span>). Esta codificaci√≥n crom√°tica permite identificar motivos conservados, regiones variables y posibles errores, y ofrece una manera intuitiva de explorar las secuencias sin necesidad de inspeccionarlas manualmente una a una. La tabla presenta un subconjunto representativo de secuencias para ilustrar la diversidad y extensi√≥n de los ASVs obtenidos, pero incluye todas las variantes en el archivo completo, accesible a trav√©s del enlace proporcionado.
</p>

<p>
  Para quienes deseen revisar todas las secuencias generadas, se proporciona un enlace justo debajo de esta tabla que permite abrir el archivo <code>sequences.fasta</code> completo en una nueva pesta√±a del navegador. Esto garantiza que cualquier usuario pueda verificar la totalidad de los datos y facilita la validaci√≥n externa de los resultados, un paso crucial en la generaci√≥n de informes reproducibles y auditables.
</p>

```{r}
# Leer el archivo y mostrar tabla interactiva
if (file.exists(ruta_sequences_fasta)) {
  # Leer el archivo generado al descomprimir
  library(Biostrings)
  library(DT)
  library(htmltools)

  # Leer el archivo fasta
  seqs <- readDNAStringSet(ruta_sequences_fasta)

  # Crear data.frame con ID, longitud y secuencia
  seqs_df <- data.frame(
    Feature_ID = names(seqs),
    Sequence_Length = width(seqs),
    Sequence = as.character(seqs),
    stringsAsFactors = FALSE,
    row.names = NULL
  )

  # Tomar solo las primeras 20 filas
  seqs_subset_df <- head(seqs_df, 100)

  # Definir colores
  nuc_colors <- list(
    A = "#2ECC71",  # verde
    T = "#E74C3C",  # rojo
    G = "#F1C40F",  # amarillo
    C = "#3498DB",  # azul
    N = "#7F8C8D"   # gris
  )

  # Funci√≥n para colorear secuencia
  color_seq <- function(seq) {
    paste0(
      sapply(strsplit(seq, "")[[1]], function(nt) {
        color <- nuc_colors[[nt]]
        if (is.null(color)) color <- "black"
        sprintf("<span style='color:%s'>%s</span>", color, nt)
      }),
      collapse = ""
    )
  }

  # Aplicar colores a la columna Sequence
  seqs_subset_df$Sequence <- sapply(seqs_subset_df$Sequence, color_seq)

  # Tabla interactiva de metadatos
  library(DT)
  htmltools::div(
    class = "scroll-y-max-500",
    DT::datatable(
      seqs_subset_df,
      escape = FALSE,
      options = list(
        scrollX = TRUE,
        paging = FALSE,
        lengthChange = FALSE,
        language = list(
          url = '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
        )
      ),
      class = 'stripe hover compact'
    )
  )
  
} else {
  cat(glue::glue('
  cat("Archivo "sequences.fasta" no encontrado. Verifica la ruta.")
  \n\n'))
}
```

```{r, results='asis'}
if (file.exists(ruta_sequences_fasta)) {

  cat(glue::glue('
  <p style="text-align:center;">
    <a href="{ruta_sequences_fasta}" target="_blank" class="boton-file">
      üîç¬†Visualizar archivo "sequences.fasta" completo en una pesta√±a nueva
    </a>
  </p>
  \n\n'))
}
```

<p>
  Paralelamente, se incrusta el <code>index.html</code> en un <code>iframe</code> dentro del informe Quarto. Esta visualizaci√≥n interactiva ofrece varias ventajas: permite inspeccionar din√°micamente la distribuci√≥n de longitudes de las ASVs, explorar la abundancia de cada secuencia en las muestras, identificar posibles secuencias raras o at√≠picas y navegar por los gr√°ficos generados autom√°ticamente por QIIME2. El <code>iframe</code> proporciona un entorno visual completo sin necesidad de abrir software adicional, mientras que un enlace adicional permite abrir el informe en una nueva pesta√±a para explorar todas las funcionalidades interactivas.
</p>

```{r, results='asis'}
# Generar iframe para Quarto si existe index.html
if (file.exists(ruta_index_html)) {

  cat(glue::glue('
  <iframe src="{ruta_index_html}" width="100%" height="700px" style="border: 1px solid #ccc; border-radius: 6px;"></iframe>

  <p style="text-align:center;">
    <a href="{ruta_index_html}" target="_blank" class="boton-iframe">
      üìä Abrir informe en nueva pesta√±a
    </a>
  </p>
  \n\n'))
}
```

<p>
  En conjunto, esta subsecci√≥n ofrece una visi√≥n exhaustiva y detallada de las secuencias representativas obtenidas. La combinaci√≥n de tablas resumidas, secuencias coloreadas y visualizaciones interactivas no solo facilita la inspecci√≥n de los resultados, sino que tambi√©n garantiza la trazabilidad y la reproducibilidad del an√°lisis. Esta base de secuencias representativas es fundamental para los pasos siguientes, incluyendo la construcci√≥n de la tabla de abundancia y la asignaci√≥n taxon√≥mica, que se desarrollar√°n en el siguiente apartado.
</p>










<div style="height: 20px; background-color: transparent;"></div>

<div class="titulo2" id="tab3-seccion3.3">
  3.3. Tabla de abundancia de ASVs
</div>

<p>
  Una vez generadas las secuencias representativas (<code>rep-seqs.qza</code>), el siguiente paso clave consiste en construir la <strong>matriz de abundancia de ASVs</strong>. Esta matriz constituye el n√∫cleo del an√°lisis de microbiomas, ya que resume cu√°ntas veces aparece cada variante de secuencia (<em>Amplicon Sequence Variant</em>, ASV) en cada muestra del estudio. 
</p>

<p>
  La estructura de esta matriz es muy sencilla en su forma pero de enorme importancia anal√≠tica:
</p>

<ul>
  <li>
    <strong>Filas</strong>: cada fila corresponde a una ASV √∫nica, identificada mediante un hash alfanum√©rico (por ejemplo, <code>5d6d41bab35d14a56fad08d8a468f6f9</code>). Este identificador est√° asociado a la secuencia representativa almacenada en el archivo <code>rep-seqs.qza</code>.
  </li>
  <li>
    <strong>Columnas</strong>: cada columna representa una muestra individual incluida en el estudio (por ejemplo, <code>NGS001-23_16S_41</code>, <code>NGS001-23_16S_42</code>, etc.).
  </li>
  <li>
    <strong>Valores</strong>: las celdas contienen los recuentos absolutos de secuencias, es decir, el n√∫mero de veces que una determinada ASV fue detectada en una muestra concreta.
  </li>
</ul>

<p>
  Gracias a esta estructura, la matriz de abundancia se convierte en el punto de partida para la mayor√≠a de los an√°lisis posteriores de microbioma. Entre sus aplicaciones principales destacan:
</p>

<ul>
  <li>
    El c√°lculo de m√©tricas de <strong>diversidad alfa</strong>, que permiten evaluar la riqueza (n√∫mero de ASVs) y la equidad (distribuci√≥n de abundancias) dentro de cada muestra.
  </li>
  <li>
    El an√°lisis de <strong>diversidad beta</strong>, destinado a comparar la composici√≥n de comunidades entre diferentes muestras o condiciones experimentales.
  </li>
  <li>
    La <strong>asignaci√≥n taxon√≥mica</strong> de las ASVs y la posterior elaboraci√≥n de perfiles taxon√≥micos que muestran la composici√≥n relativa de cada comunidad microbiana.
  </li>
  <li>
    La aplicaci√≥n de <strong>m√©todos estad√≠sticos</strong> que permiten detectar diferencias significativas en la abundancia de ASVs o taxones entre grupos de estudio.
  </li>
</ul>

<p>
  En QIIME2, esta informaci√≥n se gestiona a trav√©s de dos tipos de archivos complementarios:
</p>

<ul>
  <li>
    <code>table.qza</code>: contiene la <strong>matriz real de abundancia</strong> en formato <code>.biom</code> (Biological Observation Matrix). Este archivo almacena los datos crudos que se utilizar√°n en c√°lculos estad√≠sticos y an√°lisis de diversidad.
  </li>
  <li>
    <code>table.qzv</code>: constituye un archivo de <strong>visualizaci√≥n interactiva</strong>, que incluye representaciones gr√°ficas, tablas derivadas y una interfaz web (<code>index.html</code>) para explorar f√°cilmente la distribuci√≥n de abundancias en las diferentes muestras.
  </li>
</ul>

<p>
  En resumen, la matriz de abundancia de ASVs es la pieza central del an√°lisis metagen√≥mico: ofrece una visi√≥n cuantitativa de las comunidades microbianas y alimenta tanto la exploraci√≥n visual como los an√°lisis estad√≠sticos m√°s avanzados que se desarrollar√°n en las secciones posteriores.
</p>








<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo3" id="tab3-seccion3.3.1">
  3.3.1. Extracci√≥n de la matriz de abundancia desde `table.qza`
</div>

```{r}
# Cargar paquete qiime2R
library(qiime2R)

# Definir ruta al archivo table.qza
ruta_table_qza <- file.path(ruta_Def, "table.qza")
```

<p>
  La <strong>matriz de abundancia de ASVs</strong> contiene los datos crudos sobre cu√°ntas veces se detecta cada ASV en cada muestra. Esta matriz constituye la base de todos los an√°lisis de diversidad, rarefacci√≥n, asignaci√≥n taxon√≥mica y comparaciones estad√≠sticas. En QIIME2, se almacena en <code>table.qza</code>, un artefacto que mantiene toda la informaci√≥n completa sin resumir. El archivo <code>table.qzv</code> asociado solo proporciona representaciones resumidas y visualizaciones de esta misma matriz (tablas resumen, gr√°ficos y HTML), y se abordar√° en la siguiente subsecci√≥n.
</p>

<p>
  El artefacto <code>table.qza</code> se encuentra en el directorio de trabajo definido para los resultados de QIIME2, normalmente bajo la ruta especificada en:
</p>

```{r, results="asis"}
if (file.exists(ruta_table_qza)) {
  cat(glue::glue('
<code>{ruta_table_qza}</code>
\n\n'))
} else {
  cat(glue::glue('
‚ö†Ô∏è El archivo <code>table.qzv</code> no existe en la ruta especificada: 
<code>{ruta_table_qza}</code>
\n\n'))
}
```

<p>
  Para importar la matriz de abundancia en R se utiliza el paquete <strong>qiime2R</strong>. La funci√≥n <code>read_qza()</code> carga el artefacto y permite acceder a los datos crudos mediante el elemento <code>$data</code>, donde cada fila corresponde a un ASV y cada columna a una muestra.
</p>

<p>
  La matriz extra√≠da representa la informaci√≥n completa de abundancia, mientras que los archivos dentro de <code>table.qzv</code> solo muestran res√∫menes o gr√°ficos derivados:
</p>

<ul>
  <li><code>feature-frequency-detail.csv</code>: resumen de la frecuencia total de cada ASV en todas las muestras.</li>
  <li><code>sample-frequency-detail.csv</code>: resumen del n√∫mero total de lecturas por muestra.</li>
  <li><code>index.html</code> y gr√°ficos PDF/PNG: visualizaciones interactivas de la matriz y sus distribuciones.</li>
</ul>

<p>
  A continuaci√≥n mostramos dicha matriz de abundancia obtenida a partir de <code>table.qza</code>, la cu√°l, puede relacionarse con las secuencias representativas de <code>rep-seqs.qza</code>, permitiendo an√°lisis integrados de abundancia, diversidad y asignaci√≥n taxon√≥mica.:
</p>

```{r}
# Leer el archivo y mostrar tabla interactiva
if (file.exists(ruta_table_qza)) {
  library(qiime2R)

  # Leer el artefacto
  feature_table <- read_qza(ruta_table_qza)

  # Extraer la matriz de abundancia real
  matriz_abundancia <- feature_table$data

  # Tabla interactiva
  library(DT)
  library(htmltools)
  htmltools::div(
    class = "scroll-y-max-500",
    DT::datatable(
      matriz_abundancia,
      options = list(
        scrollX = TRUE,
        paging = FALSE,
        lengthChange = FALSE,
        language = list(
          url = '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
        )
      ),
      class = 'stripe hover compact'
    )
  )
  
} else {
  cat(glue::glue('
  cat("Archivo "{ruta_table_qza}" no encontrado. Verifica la ruta.")
  \n\n'))
}
```

<p>
  Con esta matriz es posible realizar filtrados, rarefacci√≥n, c√°lculos de diversidad alfa/beta y visualizaciones personalizadas, asegurando trazabilidad y reproducibilidad. Esto se tratar√° en las pr√≥ximas secciones.
</p>

<p>
  Una vez detallado esto, en la siguiente subsecci√≥n se abordar√° c√≥mo explorar los archivos de <code>table.qzv</code> como res√∫menes y visualizaciones de la matriz de abundancia.
</p>








<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo3" id="tab3-seccion3.3.2">
  3.3.2. Exploraci√≥n de los resultados en `table.qzv`
</div>

```{r}
# Definir ruta del archivo .qzv
ruta_table_qzv_relativa <- file.path(ruta_Def_relativa, "table.qzv")
ruta_table_qzv <- file.path(ruta_Def, "table.qzv")

# Definir ruta de salida para el unzip
ruta_Def_unzip <- file.path(ruta_Def_relativa, "unzip")
ruta_unzip_table <- file.path(ruta_Def_unzip, "table")

# Crear carpeta de salida si no existe
if (!dir.exists(ruta_Def_unzip)) dir.create(ruta_Def_unzip, recursive = TRUE)

# Solo hacer unzip si el archivo existe
if (file.exists(ruta_table_qzv_relativa)) {
  # Usando system2 para llamar a unzip desde R
  system2("unzip", args = c("-o", shQuote(ruta_table_qzv_relativa),
                            "-d", shQuote(ruta_unzip_table)))
} else {
  message("‚ö†Ô∏è El archivo table.qzv no existe. Se omite el unzip.")
}
```

```{r}
# Comprobar que el unzip se ha realizado
if (dir.exists(ruta_unzip_table)) {
  
  # Listar subcarpetas dentro de la carpeta unzip (solo 1er nivel)
  subcarpetas <- list.dirs(ruta_unzip_table, recursive = FALSE, full.names = TRUE)
  
  if (length(subcarpetas) == 0) {
    stop("No se encontr√≥ ninguna subcarpeta dentro de ", ruta_unzip_table)
  }
  
  # Tomamos la primera subcarpeta (la aleatoria generada por QIIME2)
  carpeta_random <- subcarpetas[1]
  
  # Ruta a 'data'
  ruta_data <- file.path(carpeta_random, "data")
  
  # Archivos dentro de 'data'
  ruta_feature_freq_csv <- file.path(ruta_data, "feature-frequency-detail.csv")
  ruta_sample_freq_csv <- file.path(ruta_data, "sample-frequency-detail.csv")
  ruta_index_html <- file.path(ruta_data, "index.html")
  
  # Comprobar que existen
  if (!file.exists(ruta_feature_freq_csv)) message("‚ö†Ô∏è feature-frequency-detail.csv no encontrado")
  if (!file.exists(ruta_sample_freq_csv)) message("‚ö†Ô∏è sample-frequency-detail.csv no encontrado")
  if (!file.exists(ruta_index_html)) message("‚ö†Ô∏è index.html no encontrado")
  
} else {
  message("‚ö†Ô∏è Carpeta de unzip no encontrada. No se puede acceder a los archivos.")
}
```

<p>
  Tras haber extra√≠do y visualizado la matriz de abundancia en la secci√≥n anterior, esta subsecci√≥n se centra en la exploraci√≥n de los recursos contenidos en <code>table.qzv</code>, que proporcionan res√∫menes y visualizaciones complementarias de la informaci√≥n de abundancia sin necesidad de manipular directamente la matriz cruda.
</p>

<p>
  El archivo <code>table.qzv</code> es un artefacto comprimido que contiene datos cuantitativos de abundancia, as√≠ como recursos adicionales que facilitan la inspecci√≥n y validaci√≥n de los resultados. Dicho archivo se encuentra en el siguiente directorio:
</p>

```{r, results="asis"}
if (file.exists(ruta_table_qzv)) {
  cat(glue::glue('
<code>{ruta_table_qzv}</code>
\n\n'))
} else {
  cat(glue::glue('
‚ö†Ô∏è El archivo <code>table.qzv</code> no existe en la ruta especificada: 
<code>{ruta_table_qzv}</code>
\n\n'))
}
```

<p>
  A continuaci√≥n, se procede a descomprimir <code>table.qzv</code> para as√≠ poder acceder a sus archivos internos, entre los que destacan:
</p>

<ul>
  <li>
    <code>feature-frequency-detail.csv</code>: tabla que indica cu√°ntas veces aparece cada ASV en el conjunto de todas las muestras. Cada fila corresponde a un identificador √∫nico (hash) de ASV y su frecuencia asociada refleja la abundancia global de esa variante.
  </li>
  <li>
    <code>sample-frequency-detail.csv</code>: tabla que resume el n√∫mero total de lecturas asignadas a cada muestra, permitiendo evaluar la profundidad de secuenciaci√≥n y detectar posibles muestras con baja cobertura.
  </li>
  <li>
    <code>index.html</code>: visualizaci√≥n interactiva de la matriz de abundancia, equivalente a lo que se observa al cargar el archivo en <a href="https://view.qiime2.org" target="_blank">QIIME2 View</a>. Esta interfaz facilita la exploraci√≥n gr√°fica de los datos mediante tablas din√°micas, gr√°ficos de barras y paneles de b√∫squeda y filtrado.
  </li>
</ul>

<p>
  Una vez descomprimido, se procede a explorar dichos archivos internos. El primer recurso a explorar es <code>sample-frequency-detail.csv</code>. Este archivo resume el n√∫mero total de lecturas por muestra y proporciona una visi√≥n inicial de la cobertura de secuenciaci√≥n. Su an√°lisis es clave para:
</p>

<ul>
  <li>Identificar muestras con un n√∫mero de lecturas muy bajo que podr√≠an requerir exclusi√≥n o revisi√≥n.</li>
  <li>Comparar la profundidad de secuenciaci√≥n entre grupos experimentales.</li>
  <li>Detectar desequilibrios que puedan sesgar los an√°lisis posteriores.</li>
</ul>

<p>
  A continuaci√≥n, se presenta la tabla interactiva que permite inspeccionar estos datos de manera clara y ordenada. Adem√°s, se incluye un enlace de descarga al archivo original para garantizar la reproducibilidad:
</p>

```{r}
# Leer el archivo y mostrar tabla interactiva
if (file.exists(ruta_sample_freq_csv)) {
  # Leer el archivo generado al descomprimir
  library(readr)
  sample_freq <- read_csv(ruta_sample_freq_csv, show_col_types = FALSE)
  colnames(sample_freq) <- c("Sample ID", "Frequency")

  # Tabla interactiva
  library(DT)
  htmltools::div(
    class = "scroll-y-max-500",
    DT::datatable(
      sample_freq,
      options = list(
        scrollX = TRUE,
        paging = FALSE,
        lengthChange = FALSE,
        language = list(
          url = '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
        )
      ),
      class = 'stripe hover compact'
    )
  )
  
} else {
  cat(glue::glue('
  cat("Archivo "{ruta_sample_freq_csv}" no encontrado. Verifica la ruta.")
  \n\n'))
}
```

```{r, results='asis'}
if (file.exists(ruta_sample_freq_csv)) {

  cat(glue::glue('
  <p style="text-align:center;">
    <a href="{ruta_sample_freq_csv}" target="_blank" class="boton-file">
      üíæ¬†Descargar archivo "sample-frequency-detail.csv" original
    </a>
  </p>
  \n\n'))
}
```

<p>
  El siguiente archivo clave es <code>feature-frequency-detail.csv</code>. En √©l, cada fila corresponde a un ASV √∫nico identificado mediante un hash, y la columna de frecuencia refleja el n√∫mero total de lecturas asignadas a esa variante en el conjunto de todas las muestras. Su utilidad principal radica en:
</p>

<ul>
  <li>Explorar la distribuci√≥n relativa de los ASVs, identificando cu√°les son dominantes o minoritarios.</li>
  <li>Evaluar la representatividad de las secuencias detectadas en el estudio.</li>
  <li>Corroborar la consistencia entre la matriz de abundancia y las secuencias representativas generadas previamente.</li>
</ul>

<p>
  A continuaci√≥n, se muestra la tabla interactiva con los datos de <code>feature-frequency-detail.csv</code>, junto con un enlace de descarga del archivo completo:
</p>

```{r}
# Leer el archivo y mostrar tabla interactiva
if (file.exists(ruta_feature_freq_csv)) {
  # Leer el archivo generado al descomprimir
  library(readr)
  feature_freq <- read_csv(ruta_feature_freq_csv, show_col_types = FALSE)
  colnames(feature_freq) <- c("Feature ID", "Frequency")
  
  # Tabla interactiva
  library(DT)
  htmltools::div(
    class = "scroll-y-max-500",
    DT::datatable(
      feature_freq,
      options = list(
        scrollX = TRUE,
        paging = FALSE,
        lengthChange = FALSE,
        language = list(
          url = '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
        )
      ),
      class = 'stripe hover compact'
    )
  )
  
} else {
  cat(glue::glue('
  cat("Archivo "{ruta_feature_freq_csv}" no encontrado. Verifica la ruta.")
  \n\n'))
}
```

```{r, results='asis'}
if (file.exists(ruta_feature_freq_csv)) {

  cat(glue::glue('
  <p style="text-align:center;">
    <a href="{ruta_feature_freq_csv}" target="_blank" class="boton-file">
      üíæ¬†Descargar archivo "feature-frequency-detail.csv" original
    </a>
  </p>
  \n\n'))
}
```

<p>
  Finalmente, el archivo <code>index.html</code> proporciona una visualizaci√≥n din√°mica de la matriz de abundancia. Esta interfaz reproduce lo que se observa al abrir <code>table.qzv</code> en QIIME2 View y permite:
</p>

<ul>
  <li>Examinar de manera interactiva la presencia y abundancia relativa de los ASVs en cada muestra.</li>
  <li>Detectar patrones, outliers o muestras con lecturas at√≠picas.</li>
  <li>Explorar los datos a trav√©s de gr√°ficos y herramientas de filtrado que enriquecen la interpretaci√≥n.</li>
</ul>

<p>
  En el informe, este archivo puede incrustarse directamente como un <code>iframe</code> o abrirse en una nueva pesta√±a del navegador para aprovechar todas sus funcionalidades:
</p>

```{r, results='asis'}
# Generar iframe para Quarto si existe index.html
if (file.exists(ruta_index_html)) {

  cat(glue::glue('
  <iframe src="{ruta_index_html}" width="100%" height="700px" style="border: 1px solid #ccc; border-radius: 6px;"></iframe>

  <p style="text-align:center;">
    <a href="{ruta_index_html}" target="_blank" class="boton-iframe">
      üìä Abrir informe en nueva pesta√±a
    </a>
  </p>

  <div style="height: 15px; background-color: transparent;"></div>
  \n\n'))
}
```

<p>
  En conjunto, estos archivos complementan la matriz de abundancia ya mostrada, ofreciendo res√∫menes y visualizaciones que mejoran la accesibilidad y comprensi√≥n de los datos. Esto asegura la trazabilidad, accesibilidad y reproducibilidad de los datos, y deja preparado el escenario para abordar en las siguientes secciones la asignaci√≥n <strong>taxon√≥mica y filogenia</strong> (<a href="4-taxonimia-filogenia.html#tab3-seccion4" class="normalink">secci√≥n 4</a>), el an√°lisis <strong>diferencial de abundancia</strong> (<a href="5-diversidad-diferencial.html#tab3-seccion5" class="normalink">secci√≥n 5</a>) y el an√°lisis de la <strong>diversidad microbiana</strong> (<a href="6-diversidad-microbiana.html#tab3-seccion6" class="normalink">secci√≥n 6</a>), que incluir√° tanto la diversidad alfa (riqueza y equidad) como la diversidad beta (comparaci√≥n entre comunidades).
</p>
