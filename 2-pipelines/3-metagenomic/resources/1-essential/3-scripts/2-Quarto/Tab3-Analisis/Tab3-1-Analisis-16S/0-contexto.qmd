---
title: "Metagenomic Report"

include-in-header:
  text: |
    <link rel="shortcut icon" href="../../../../1-images/icono/favicon.svg"/>
    <link rel="icon" type="image/x-icon" href="../../../../1-images/icono/favicon.ico">

params:
  ruta_proyecto: ""
  tipo_analisis: ""
---


<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->
<!--  CHATBOT
<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->

<div id="chat-container">
  <button id="chat-toggle"></button>
  <div id="chat-box">
    <div id="chat-log"></div>
    <input id="chat-input" type="text" placeholder="Escribe tu pregunta..."/>
  </div>
</div>










<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->
<!--  TAB 3: ANÁLISIS 16S | 0. CONTEXTO -->
<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->

```{r}
# Cargar librerías
library(glue)
library(fs)
library(stringr)
library(dplyr)
library(tidyverse)
library(magrittr)
library(DT)
library(htmltools)
library(purrr)


# Rutas clave
ruta_qmd <- getwd()
ruta_metagenomic_pipeline <- file.path("..", "..", "..", "..", "..", "..")
nombre_proyecto <- basename(params$ruta_proyecto)


# Rutas de resultados Nextflow
ruta_nextflow_results <- file.path("..", "..", "..", "..", "..", "..", "resources", "2-nextflow-results")
ruta_proyecto_relativa <- file.path("..", "..", "..", "..", "..", "..", "resources", "2-nextflow-results", "1-project-data", nombre_proyecto)


# Ruta resultados fastqc
ruta_Pre_fastqc_results <- file.path(params$ruta_proyecto, "Analisis", "miARma_16S", "Pre_fastqc_results")
ruta_Pre_fastqc_results_relativa <- file.path(ruta_proyecto_relativa, "Analisis", "miARma_16S", "Pre_fastqc_results")


# Obtener archivos .html de FastQC
archivos_html <- dir_ls(ruta_Pre_fastqc_results_relativa, regexp = "\\.html$")

# Extraer IDs de muestra (quitando el sufijo que empieza por _R1 o _R2 hasta el final)
ids_muestras <- archivos_html |>
  path_file() |>
  str_replace("_(R1|R2).*_fastqc\\.html$", "") |>
  unique()


# Rutas de la carpeta Def
ruta_Def <- file.path(params$ruta_proyecto, "Resultados", "Def")
ruta_Def_relativa <- file.path(ruta_proyecto_relativa, "Resultados", "Def")


# Rutas de la carpeta export
ruta_exported <- file.path(ruta_Def, "exported")
ruta_exported_relativa <- file.path(ruta_Def_relativa, "exported")


# Listar carpetas únicas (nivel 1) ignorando "_ingles" y que existan realmente
folders <- list.dirs(ruta_exported_relativa, full.names = TRUE, recursive = FALSE) %>%
  str_subset("_ingles", negate = TRUE) %>%
  keep(dir.exists) %>%  # <-- solo carpetas que existen
  basename()


# Función para obtener lista de archivos y comparaciones únicas de forma segura
get_files_info <- function(folder_name) {
  path <- file.path(ruta_exported_relativa, folder_name)
  
  if (!dir.exists(path)) {
    message(glue("Carpeta '{folder_name}' no existe. Se omite."))
    return(NULL)
  }
  
  # Listar archivos .xls y .png
  files <- list.files(path, pattern = "\\.(xls|png)$", full.names = TRUE)
  
  if (length(files) == 0) {
    message(glue("No se encontraron archivos en '{folder_name}'."))
    return(NULL)
  }
  
  # Extraer solo el nombre base
  file_names <- basename(files)
  
  # Extraer comparación limpia (quitamos número inicial, extensión y cambiamos _ -> " ", - -> " vs ")
  comparison <- file_names %>%
    str_remove("^\\d+\\.") %>%        # quitar número inicial
    str_remove("\\.(xls|png)$") %>%   # quitar extensión
    str_replace_all("_", " ") %>%     # _ -> espacio
    str_replace_all("-", " vs ")      # - -> " vs "
  
  tibble(
    file = files,
    comparison = comparison,
    type = if_else(str_detect(files, "\\.xls$"), "xls", "png")
  )
}


# Crear lista de dataframes solo para carpetas existentes
folder_dfs <- map(folders, ~ get_files_info(.x)) %>%
  set_names(folders)


# Filtrar NULLs (carpetas vacías o inexistentes)
folder_dfs <- folder_dfs[!sapply(folder_dfs, is.null)]


# Lista de carpetas con comparaciones únicas
folder_files <- map(names(folder_dfs), ~ {
  df <- folder_dfs[[.x]]
  df %>%
    group_by(comparison) %>%
    summarise(
      xls = file[type == "xls"],
      png = file[type == "png"],
      .groups = "drop"
    )
}) %>%
  set_names(names(folder_dfs))
```


<div class="informe-titulo-tab">
  <h1>Pestaña</h1>
  <h2>Análisis 16S bioinformático completo</h2>
</div>

<div class="informe-titulo-seccion">
  <h1>Sección</h1>
  <h2>Introducción Contextual</h2>
</div>

<div class="flecha-abajo">
  ▼
</div>


<div class="informe-resumen">
  <p>
    Esta pestaña tiene como propósito ofrecer una <strong>visión contextual y estructurada</strong> del análisis de metagenómica 16S realizado mediante <code>QIIME2</code> y herramientas complementarias, actuando como una <strong>guía introductoria</strong> al informe. En ella se describe el enfoque general seguido, la lógica de su estructura y los contenidos que el lector encontrará en cada una de las secciones posteriores.
  </p>

  <p>
    En este sentido, se presenta un resumen del proceso analítico llevado a cabo, desde la revisión inicial de las muestras y sus metadatos, pasando por las etapas de control de calidad, generación de unidades taxonómicas (ASVs), análisis de diversidad microbiana y composición taxonómica, hasta los estudios diferenciales y de predicción funcional. Cada etapa clave del pipeline se desarrolla en su propia subsección dentro del informe, lo que permite acceder fácilmente a los contenidos relevantes según el interés del lector. Esta estructura modular favorece una lectura progresiva y ordenada, adaptada tanto a perfiles técnicos como a lectores con formación biológica.
  </p>

  <p>
    A continuación, se describe brevemente el contenido de cada bloque principal:
  </p>

  <ul>
    <li>
      <strong>1. Revisión inicial del conjunto de muestras y metadatos:</strong> Se ofrece una visión general de las muestras analizadas y de su distribución según condiciones experimentales. Esta revisión permite contextualizar el diseño del experimento y verificar la consistencia de los datos antes de iniciar el análisis bioinformático.
    </li>

    <li>
      <strong>2. Control de calidad y preprocesamiento de las lecturas:</strong> Se presentan los informes obtenidos con <code>FastQC</code> y <code>MultiQC</code>, permitiendo detectar problemas globales y por muestra. Además, se incluyen las estadísticas de filtrado y depuración de secuencias realizadas mediante <code>DADA2</code> o <code>Deblur</code>, con el fin de garantizar la calidad de las secuencias que pasarán a los análisis posteriores.
    </li>

    <li>
      <strong>3. Generación de ASVs y tabla de abundancia:</strong> Esta sección documenta el proceso de obtención de secuencias representativas (ASVs) y la construcción de la tabla de abundancia de cada muestra. Se muestran métricas como el número final de ASVs retenidas y la distribución de lecturas entre ellas, que constituyen la base de todo análisis posterior.
    </li>

    <li>
      <strong>4. Diversidad microbiana:</strong> Se analizan los índices de diversidad alfa (riqueza y equidad) y beta (distancias entre comunidades microbianas), incluyendo representaciones gráficas como boxplots y análisis de ordenación multivariante (PCoA). Estas métricas permiten evaluar la complejidad y variabilidad de las comunidades en cada condición experimental.
    </li>

    <li>
      <strong>5. Composición taxonómica global:</strong> Aquí se presenta la caracterización descriptiva de los perfiles microbianos, mostrando la distribución de taxones en diferentes niveles (familia y género) mediante tablas interactivas y gráficos de barras apiladas. Se identifican los taxones predominantes en cada grupo experimental.
    </li>

    <li>
      <strong>6. Análisis diferencial de abundancia:</strong> Este bloque constituye el núcleo comparativo del análisis. A través de pruebas estadísticas y representaciones gráficas (tablas y volcanos), se identifican los taxones con diferencias significativas de abundancia entre condiciones experimentales, destacando aquellos que podrían estar asociados a los factores estudiados.
    </li>

    <li>
      <strong>7. Predicción funcional:</strong> Mediante <code>PICRUSt2</code> u otras herramientas equivalentes, se infieren potenciales funciones metabólicas a partir de la composición taxonómica observada. Los resultados se presentan en forma de gráficos de rutas metabólicas y análisis comparativos, aportando una visión funcional complementaria al análisis taxonómico.
    </li>

    <li>
      <strong>8. Resumen de hallazgos:</strong> Finalmente, se integran los resultados obtenidos en todas las secciones anteriores, destacando las principales observaciones en términos de calidad, diversidad, taxones predominantes, diferencias entre condiciones y posibles implicaciones funcionales. Esta síntesis prepara el terreno para la discusión comparativa con otros análisis (18S, ITS) presentados en pestañas paralelas del informe.
    </li>
  </ul>

  <p>
    En definitiva, esta pestaña cumple un rol fundamental como <strong>punto de entrada al informe</strong>, contextualizando el análisis de metagenómica 16S, explicando su organización lógica y facilitando la navegación a lo largo de las diferentes etapas del pipeline. La inclusión de secciones independientes para cada proceso, desde el control de calidad hasta la predicción funcional, permite al lector abordar el informe de manera flexible, pudiendo centrarse tanto en la visión global como en aspectos técnicos o biológicos concretos según su interés.
  </p>
</div>










<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo-toc">
  Tabla de contenidos general
</div>

<p>
  Se presenta a continuación el índice interactivo de la pestaña de <strong>Análisis</strong>, el cual organiza de forma estructurada cada etapa del proceso seguido. Desde aquí, es posible navegar fácilmente entre las distintas secciones del informe.
</p>

```{=html}
```{r, echo=FALSE, results="asis"}
cat('
<div class="toc">
  <ul>


    <!-- Sección 1 -->
    <li>
      <a href="1-revision-inicial.html#tab3-seccion1">
        1<span>.</span> Revisión inicial del conjunto de muestras y metadatos
      </a>
      <ul>
        <li>
          <a href="1-revision-inicial.html#tab3-seccion1.1">
            1.1. Organización y estructura del proyecto
          </a>
        </li>
        <li>
          <a href="1-revision-inicial.html#tab3-seccion1.2">
            1.2. Revisión del archivo de metadatos
          </a>
        </li>
        <li>
          <a href="1-revision-inicial.html#tab3-seccion1.3">
            1.3. Exploración inicial de las muestras de entrada
          </a>
        </li>
      </ul>
    </li>


    <!-- Sección 2 -->
    <li>
      <a href="2-control-calidad.html#tab3-seccion2">
        2<span>.</span> Control de calidad y preprocesamiento
      </a>
      <ul>
        <li>
          <a href="2-control-calidad.html#tab3-seccion2.1">
            2.1. Informes de calidad externos (FastQC / MultiQC)
          </a>
          <ul>
            <li>
              <a href="2-control-calidad.html#tab3-seccion2.1.1">
                2.1.1. Resumen global (MultiQC)
              </a>
            </li>
            <li>
              <a href="2-control-calidad.html#tab3-seccion2.1.2">
                2.1.2. Calidad individual (FastQC)
              </a>
              <ul>
                <li>
                  <a href="2-control-calidad.html#tab3-seccion2.1.2.1">
                    2.1.2.1. Evaluación de calidad de lecturas Forward
                  </a>
                  <ul>
')

i <- 1
for (id in ids_muestras) {
  cat(glue::glue('<li><a href="2-control-calidad.html#tab3-seccion2.1.2.1.{i}">2.1.2.1.{i}. Muestra: {id}</a></li>\n'))
  i <- i + 1
}

cat('
                  </ul>
                </li>
                <li>
                  <a href="2-control-calidad.html#tab3-seccion2.1.2.2">
                    2.1.2.2. Evaluación de calidad de lecturas Reverse
                  </a>
                  <ul>
')

i <- 1
for (id in ids_muestras) {
  cat(glue::glue('<li><a href="2-control-calidad.html#tab3-seccion2.1.2.2.{i}">2.1.2.2.{i}. Muestra: {id}</a></li>\n'))
  i <- i + 1
}

cat('
                  </ul>
                </li>
              </ul>
            </li>
            <li>
              <a href="2-control-calidad.html#tab3-seccion2.2">
                2.2. Informe de demultiplexación en QIIME2
              </a>
            </li>
            <li>
              <a href="2-control-calidad.html#tab3-seccion2.3">
                2.3. Reflexiones sobre la calidad observada
              </a>
            </li>
            <li>
              <a href="2-control-calidad.html#tab3-seccion2.4">
                2.4. Trimming y filtrado inicial
              </a>
            </li>
            <li>
            <li>
              <a href="2-control-calidad.html#tab3-seccion2.5">
                2.5. Denoising y depuración con DADA2 / Deblur
              </a>
            </li>
          </ul>
        </li>
      </ul>
    </li>
')


cat('
    <!-- Sección 3 -->
    <li>
      <a href="3-asvs-tabla.html#tab3-seccion3">
        3<span>.</span> Generación de ASVs y tabla de abundancia
      </a>
      <ul>
        <li>
          <a href="3-asvs-tabla.html#tab3-seccion3.1">
            3.1. Obtención de secuencias representativas (ASVs)
          </a>
        </li>
        <li>
          <a href="3-asvs-tabla.html#tab3-seccion3.2">
            3.2. Construcción de la tabla de abundancias
          </a>
        </li>
      </ul>
    </li>


    <!-- Sección 4 -->
    <li>
      <a href="#tab3-seccion4">
        4<span>.</span> Asignación taxonómica y filogenia
      </a>
      <ul>
        <li>
          <a href="#tab3-seccion4.1">
            4.1. Asignación taxonómica
          </a>
          <ul>
            <li>
              <a href="#tab3-seccion4.1.1">
                4.1.1. Archivos principales
              </a>
            </li>
            <li>
              <a href="#tab3-seccion4.1.2">
                4.1.2. Visualización de composición taxonómica
              </a>
              <ul>
                <li>
                  <a href="#tab3-seccion4.1.2.1">
                    4.1.2.1. Visualización interactiva de la composición taxonómica
                  </a>
                </li>
')

# Generar los enlaces para las tablas por nivel taxonómico
for (nivel in 1:7) {
  numero_sub <- nivel + 1 # para no colisionar con la visualización interactiva
  cat(glue('
                <li>
                  <a href="#tab3-seccion4.1.2.{numero_sub}">
                    4.1.2.{numero_sub}. Tabla interactiva de abundancia de ASVs por nivel taxonómico {nivel}
                  </a>
                </li>
  '))
}

cat('
              </ul>
            </li>
            <li>
              <a href="#tab3-seccion4.1.3">
                4.1.3. Archivos exportados por niveles taxonómicos
              </a>
              <ul>
                <li>
                  <a href="#tab3-seccion4.1.3.1">
                    4.1.3.1. Tabla de abundancia relativa a nivel taxonómico: <strong>Familia (L5)</strong>
                  </a>
                </li>
                <li>
                  <a href="#tab3-seccion4.1.3.2">
                    4.1.3.2. Tabla de abundancia relativa a nivel taxonómico: <strong>Género (L6)</strong>
                  </a>
                </li>
                <li>
                  <a href="#tab3-seccion4.1.3.2">
                    4.1.3.2. Tabla de abundancia relativa a nivel taxonómico: <strong>Especie (L7)</strong>
                  </a>
                </li>
              </ul>
            </li>
          </ul>
        </li>
        <li>
          <a href="#tab3-seccion4.2">
            4.2. Construcción del árbol filogenético
          </a>
          <ul>
            <li>
              <a href="#tab3-seccion4.2.1">
                4.2.1. Archivos principales
              </a>
            </li>
            <li>
              <a href="#tab3-seccion4.2.2">
                4.2.2. Diferencias entre árboles
              </a>
              <ul>
                <li>
                  <a href="#tab3-seccion4.2.2.1">
                    4.2.2.1. Árbol sin raíz
                  </a>
                </li>
                <li>
                  <a href="#tab3-seccion4.2.2.2">
                    4.2.2.2. Árbol enraizado
                  </a>
                </li>
              </ul>
            </li>
            <li>
              <a href="#tab3-seccion4.2.3">
                4.2.3. Relación con análisis posteriores
              </a>
            </li>
          </ul>
        </li>
      </ul>
    </li>


    <!-- Sección 5 -->
    <li>
      <a href="#tab3-seccion5">
        5<span>.</span> Análisis diferencial de abundancia
      </a>
      <ul>
')

# Iterar sobre las carpetas/folders
for (i in seq_along(folders)) {
  cat(glue('
        <li>
          <a href="#tab3-seccion5.{i}">
            5.{i}. Resultados a nivel de {folders[i]}
          </a>
        </li>
  '))
}

cat('      </ul>
    </li>


    <!-- Sección 6 -->
    <li>
      <a href="6-diferencial.html#tab3-seccion6">
        6<span>.</span> Análisis diferencial de abundancia
      </a>
      <ul>
        <li>
          <a href="6-diferencial.html#tab3-seccion6.1">
            6.1. Resultados a nivel de familia
          </a>
        </li>
        <li>
          <a href="6-diferencial.html#tab3-seccion6.2">
            6.2. Resultados a nivel de género
          </a>
        </li>
      </ul>
    </li>


    <!-- Sección 7 -->
    <li>
      <a href="7-funcional.html#tab3-seccion7">
        7<span>.</span> Predicción funcional
      </a>
      <ul>
        <li>
          <a href="7-funcional.html#tab3-seccion7.1">
            7.1. Inferencia de funciones con PICRUSt2
          </a>
        </li>
        <li>
          <a href="7-funcional.html#tab3-seccion7.2">
            7.2. Representación e interpretación de rutas metabólicas
          </a>
        </li>
      </ul>
    </li>


    <!-- Sección 8 -->
    <li>
      <a href="8-conclusiones.html#tab3-seccion8">
        8<span>.</span> Conclusiones y perspectivas
      </a>
    </li>
  </ul>
</div>
')
```
```

```{=html}
```
