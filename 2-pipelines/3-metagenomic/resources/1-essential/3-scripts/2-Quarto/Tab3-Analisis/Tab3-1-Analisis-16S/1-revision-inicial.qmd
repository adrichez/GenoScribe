---
title: "Metagenomic Report"

include-in-header:
  text: |
    <link rel="shortcut icon" href="../../../../1-images/icono/favicon.svg"/>
    <link rel="icon" type="image/x-icon" href="../../../../1-images/icono/favicon.ico">

params:
  ruta_proyecto: ""
  tipo_analisis: ""
---


<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->
<!--  CHATBOT
<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->

<div id="chat-container">
  <button id="chat-toggle"></button>
  <div id="chat-box">
    <div id="chat-log"></div>
    <input id="chat-input" type="text" placeholder="Escribe tu pregunta..."/>
  </div>
</div>










<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->
<!--  TAB 3: AN√ÅLISIS 16S | 1. REVISI√ìN INICIAL DEL CONJUNTO DE MUESTRAS Y METADATOS -->
<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->

```{r}
# Cargar librer√≠as
library(glue)
library(fs)
library(stringr)
library(dplyr)


# Rutas clave
ruta_qmd <- getwd()
ruta_metagenomic_pipeline <- file.path("..", "..", "..", "..", "..", "..")
nombre_proyecto <- basename(params$ruta_proyecto)


# Rutas de resultados Nextflow
ruta_nextflow_results <- file.path("..", "..", "..", "..", "..", "..", "resources", "2-nextflow-results")
ruta_proyecto_relativa <- file.path("..", "..", "..", "..", "..", "..", "resources", "2-nextflow-results", "1-project-data", nombre_proyecto)


# Rutas de la carpeta Def
ruta_Def <- file.path(params$ruta_proyecto, "Resultados", "Def")
ruta_Def_relativa <- file.path(ruta_proyecto_relativa, "Resultados", "Def")

ruta_Def_sample_metadata <- file.path(ruta_Def, "sample-metadata.tsv")
ruta_Def_sample_metadata_relativa <- file.path(ruta_Def_relativa, "sample-metadata.tsv")


# Leer el archivo TSV de metadatos
Def_sample_metadata_relativa <- read.delim(
  ruta_Def_sample_metadata_relativa,
  header = TRUE,
  stringsAsFactors = FALSE,
  fill = TRUE
)

# Calcular en n√∫mero de muestras √∫nicas
n_samples <- dim(Def_sample_metadata_relativa)[1]


# Calcular m√©tricas
metricas_metadata <- Def_sample_metadata_relativa %>%
  summarise(
    n_Type = n_distinct(Type),
    lista_Type = paste(unique(Type), collapse = ", "),
    n_TypeII = n_distinct(TypeII),
    lista_TypeII = paste(unique(TypeII), collapse = ", "),
    n_tandas = n_distinct(tanda),
    lista_tandas = paste(unique(tanda), collapse = ", ")
  )


# Rutas de la carpeta archivos para guardar los resultados
ruta_archives_16S <- file.path(ruta_metagenomic_pipeline, "resources", "1-essential", "2-archives", "Tab3-Analisis", "Tab3-1-Analisis-16S")
ruta_archives_16S_revision_inicial <- file.path(ruta_archives_16S, "1-revision-inicial")

# Crear la carpeta si no existe
if (!dir.exists(ruta_archives_16S_revision_inicial)) {
  dir.create(ruta_archives_16S_revision_inicial, recursive = TRUE, showWarnings = FALSE)
}

# Ruta del archivo TXT de metadatos creado
ruta_archives_16S_revision_inicial_sample_metadata <- file.path(ruta_archives_16S_revision_inicial, "sample_metadata.txt")

# Creaci√≥n del archivo en formato TXT
write.table(
  Def_sample_metadata_relativa,
  file = ruta_archives_16S_revision_inicial_sample_metadata,
  sep = "\t",          # tabulador como separador
  quote = FALSE,       # sin comillas
  row.names = FALSE
)


# Ruta de la carpeta reads
ruta_reads_16S <- file.path(params$ruta_proyecto, "Analisis", "reads", "16S")
```


<div class="informe-titulo-tab">
  <h1>Pesta√±a</h1>
  <h2>An√°lisis 16S bioinform√°tico completo</h2>
</div>

<div class="informe-titulo-seccion">
  <h1>Secci√≥n 1</h1>
  <h2>Revisi√≥n inicial del conjunto de muestras y metadatos</h2>
</div>

<div class="flecha-abajo">
  ‚ñº
</div>


<div class="informe-resumen">
  <h2>Resumen</h2>

  <p>
    En esta primera secci√≥n se realiza una exploraci√≥n preliminar de los datos disponibles con el objetivo de entender la estructura del proyecto y garantizar la coherencia de las muestras antes de abordar los an√°lisis posteriores. Para ello, se incorpora un visor interactivo que permite navegar por la organizaci√≥n de carpetas del proyecto, ofreciendo una visi√≥n estructurada del entorno de trabajo y de los archivos generados en las etapas iniciales.
  </p>

  <p>
    Uno de los elementos clave analizados es el archivo de metadatos, el cual proporciona informaci√≥n esencial sobre cada muestra. En concreto, se examinan tres variables principales:
  </p>

  <ul>
    <li><strong>Filename:</strong> indica el nombre del archivo original (.fastq.gz) que contiene las lecturas crudas.</li>
    <li><strong>Name:</strong> representa el identificador interno asignado a cada muestra, utilizado de forma coherente a lo largo del pipeline.</li>
    <li><strong>Type:</strong> define el grupo experimental al que pertenece la muestra (por ejemplo, caso, control, replicado, etc.).</li>
  </ul>

  <p>
    Esta revisi√≥n no solo permite validar la correcta anotaci√≥n de las muestras y su clasificaci√≥n experimental, sino tambi√©n anticipar posibles problemas o inconsistencias. Finalmente, se ofrece una visualizaci√≥n adicional que muestra todos los archivos <code>fastq.gz</code> disponibles, lo que permite confirmar la integridad del conjunto de datos iniciales desde los cuales se iniciar√° el an√°lisis de calidad y procesamiento t√©cnico.
  </p>
</div>










<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo-toc">
  Tabla de contenidos de esta secci√≥n
</div>

<div class="toc">
  <ul>
    <li>
      <a href="#tab3-seccion1">1<span>.</span> Revisi√≥n inicial del conjunto de muestras y metadatos</a>
      <ul>
        <li><a href="#tab3-seccion1.1">1.1. Organizaci√≥n y estructura del proyecto</a></li>
        <li><a href="#tab3-seccion1.2">1.2. Revisi√≥n del archivo de metadatos</a></li>
        <li><a href="#tab3-seccion1.3">1.3. Exploraci√≥n inicial de las muestras de entrada</a></li>
      </ul>
    </li>
  </ul>
</div>











<!-- #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->
<!-- REDACCI√ìN -->
<!-- #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->

<div style="height: 25px; background-color: transparent;"></div>

<div class="titulo1" id="tab3-seccion1">
  1<span>.</span> Revisi√≥n inicial del conjunto de muestras y metadatos
</div>

<p>
  Antes de iniciar el an√°lisis t√©cnico y estad√≠stico de los datos de expresi√≥n g√©nica, es fundamental realizar una revisi√≥n preliminar del entorno de trabajo, los archivos disponibles y la informaci√≥n asociada a cada muestra. Esta secci√≥n tiene como objetivo contextualizar el dise√±o experimental, validar la organizaci√≥n de los datos y asegurar la integridad y consistencia de las muestras. Para ello, se examina tanto la estructura de carpetas del proyecto como el archivo de metadatos, y se identifican los archivos de lectura cruda que servir√°n como punto de partida para los an√°lisis posteriores.
</p>










<div style="height: 20px; background-color: transparent;"></div>

<div class="titulo2" id="tab3-seccion1.1">
  1.1. Organizaci√≥n y estructura del proyecto
</div>

```{r, results="asis"}
cat(glue::glue('
<p>
  El presente an√°lisis de <strong>metagen√≥mica de 16S</strong> tiene como objetivo caracterizar la composici√≥n y diversidad de las comunidades microbianas presentes en las muestras seleccionadas, cuyo entorno de trabajo se encuentra organizado dentro de la siguiente ruta del proyecto:
</p>

<code>{params$ruta_proyecto}</code>

<p>
  Los archivos y carpetas que componen este entorno de trabajo pueden explorarse mediante el siguiente visor interactivo, el cual permite navegar por la jerarqu√≠a del proyecto y consultar los contenidos de forma estructurada, proporcion√°ndose adem√°s un acceso directo a los recursos relevantes mediante botones espec√≠ficos. Mencionar, eso s√≠, que aqu√≠ podremos visualizar solo los archivos m√°s relevantes y esenciales para la elaboraci√≥n de este informe, mientras que archivos m√°s pesados (como podr√≠an ser archivos <code>.fastq.gz</code>), han sido ignorados en el proceso de copiado de archivos a la ruta de este informe dado el alto volumen de espacio y tiempo requerido para ello. As√≠, en el caso de querer explorar estos archivos espec√≠ficos ser√° necesario consultar la carpeta original con los resultados proporcionados tanto por la herramienta <strong>miARma-Seq</strong> como por <strong>QIIME2</strong>.
</p>
\n\n'))
```

<div class="box-files">

```{r, echo=FALSE, results="asis"}
if (!dir.exists(ruta_proyecto_relativa)) {
  cat(sprintf('<p><em>La ruta "%s" no existe o no es accesible.</em></p>\n', ruta_proyecto_relativa))
} else {
  # Listar todos los archivos, sin filtros
  files <- list.files(ruta_proyecto_relativa, full.names = FALSE)
  
  if (length(files) == 0) {
    cat('<p><em>No se encontraron archivos en la carpeta especificada.</em></p>\n')
  } else {
    enlace <- ruta_proyecto_relativa
    
    cat("<ul>\n")
    for (f in files) {
      # Asignar clase seg√∫n la extensi√≥n
      clase <- if (!grepl("\\.", f)) {
        "file-folder"
      } else if (grepl("\\.html$", f)) {
        "file-html"
      } else if (grepl("\\.zip$", f)) {
        "file-zip"
      } else if (grepl("\\.fastq\\.gz$", f)) {
        "file-fastqgz"
      } else {
        "file-default"
      }
      
      cat(sprintf('<li class="%s"><a href="%s/%s" target="_blank">%s</a></li>\n',
                  clase, enlace, f, f))
    }
    cat("</ul>\n")
  }
}
```

</div>

```{r, results="asis"}
# Para que funcione con rutas absolutas
enlace <- ruta_proyecto_relativa

# Imprimir el enlace
cat(glue::glue('
<p style="text-align:center;">
  <a href="{enlace}" target="_blank" class="boton-files">
    üìÇ Explora los archivos de la carpeta "{nombre_proyecto}" aqu√≠
  </a>
</p>
\n\n'))
```

```{r, results="asis"}
cat(glue::glue('
<p>
  A continuaci√≥n, se presenta en detalle la estructura de carpetas y archivos empleada en el an√°lisis de metagen√≥mica 16S, organizada para facilitar tanto el desarrollo reproducible del an√°lisis como la posterior consulta e interpretaci√≥n de los resultados:
</p>

<ul>
  <li>
    <code>{nombre_proyecto}/Analisis/reads/16S/</code>: Directorio que contiene los archivos de lectura crudos de las muestras, preparados para su procesamiento con QIIME2.
  </li>

  <li>
    <code>{nombre_proyecto}/Resultados/Def/</code>: Carpeta que agrupa los resultados generados por QIIME2 y la predicci√≥n funcional de las comunidades microbianas:
    <ul>
      <li>
        <code>core-metrics-results/</code>: Contiene ficheros <code>.qzv</code> con m√©tricas principales de diversidad y composici√≥n microbiana. Dichos ficheros pueden visualizarse interactivamente usando <a href="https://view.qiime2.org/" target="_blank" class="normalink">QIIME2 View</a>, adem√°s de visualizarlas m√°s adelante en este informe.
      </li>
      <li>
        <code>sample-metadata.tsv</code>: Archivo de metadatos con informaci√≥n de las muestras (tipo, condici√≥n, replicados, etc.), necesario para los an√°lisis estad√≠sticos y comparativos.
      </li>
      <li>
        <code>exported/</code>: Carpeta con resultados de abundancia diferencial. Incluye subcarpetas por nivel taxon√≥mico (<code>genero/</code>, <code>familia/</code>), cada una con:
        <ul>
          <li>Archivos <code>.xlsx</code> con los resultados estad√≠sticos de abundancia diferencial entre grupos de comparaci√≥n.</li>
          <li>Gr√°ficos tipo <em>volcano</em> con los organismos m√°s y menos abundantes, cuando est√°n disponibles.</li>
        </ul>
      </li>
      <li>
        Archivos de predicci√≥n funcional de Pycrust: se encuentran directamente dentro de <code>Resultados/Def/</code> y se identifican porque sus nombres contienen <code>MetagenomeSeq</code>, <code>glm_test_p_values</code> o <code>pca_p_0,05_all</code>. Estos gr√°ficos permiten evaluar la funcionalidad potencial de las comunidades microbianas seg√∫n los organismos m√°s abundantes.
      </li>
    </ul>
  </li>
</ul>

<p>
  Esta organizaci√≥n modular permite automatizar los an√°lisis clave de metagen√≥mica 16S, garantiza trazabilidad y reproducibilidad, y facilita la interpretaci√≥n de los resultados. Adem√°s, contribuye a una documentaci√≥n clara del flujo de trabajo, √∫til en entornos colaborativos o proyectos de largo recorrido.
</p>
\n\n'))
```










<div style="height: 20px; background-color: transparent;"></div>

<div class="titulo2" id="tab3-seccion1.2">
  1.2. Revisi√≥n del archivo de metadatos
</div>

<p>
  Como ya se ha comentado anteriormente, la definici√≥n del conjunto de muestras analizadas, en este estudio de metagen√≥mica 16S, se encuentra detallado en un archivo de metadatos, accesible en la siguiente ubicaci√≥n:
</p>

```{r, results="asis"}
cat(glue::glue('
<code>{ruta_Def_sample_metadata}</code>
\n\n'))
```

<p>
  Este archivo es fundamental para organizar el an√°lisis, ya que permite identificar, clasificar y vincular cada muestra con su contexto experimental. Contiene columnas clave como:
</p>

<ul>
  <li><strong>SampleID</strong>: identificador √∫nico de la muestra, que coincide con los nombres de los archivos de datos crudos (por ejemplo, <code>.fastq.gz</code>).</li>
  <li><strong>Type</strong>: grupo principal de la muestra (por ejemplo, <code>Equine</code>, <code>Ovine</code>, <code>Livestock_exc</code>).</li>
  <li><strong>TypeII</strong>: subtipo o denominaci√≥n m√°s espec√≠fica de la muestra dentro de su grupo (por ejemplo, <code>Burro_1</code>, <code>Oveja_1</code>, <code>Control_1</code>).</li>
  <li><strong>tanda</strong>: n√∫mero de tanda o lote experimental al que pertenece la muestra.</li>
</ul>

<p>
  A continuaci√≥n se muestra una tabla interactiva que resume esta informaci√≥n, permitiendo una revisi√≥n visual y filtrada de las muestras incluidas en el experimento. Esto facilita comprobar su identificador, su grupo y subtipo, y su asignaci√≥n a las tandas experimentales:
</p>

```{r, echo=FALSE}
# Tabla interactiva de metadatos
library(DT)

htmltools::div(
  class = "scroll-y-max-500",
  DT::datatable(
    Def_sample_metadata_relativa,
    options = list(
      scrollX = TRUE,
      paging = FALSE,
      lengthChange = FALSE,
      language = list(
        url = '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
      )
    ),
    class = 'stripe hover compact',
    rownames = FALSE
  )
)
```

<div style="height: 15px; background-color: transparent;"></div>

<p>
  Para consultar el archivo completo, puede utilizar el visor incrustado que se presenta a continuaci√≥n o, si lo prefiere, abrir el documento en una pesta√±a independiente para una exploraci√≥n m√°s c√≥moda:
</p>

```{r, results='asis'}
cat(glue::glue('
<iframe src="{ruta_archives_16S_revision_inicial_sample_metadata}" width="100%" height="500px" style="border: 1px solid #ccc; border-radius: 6px;"></iframe>

<p style="text-align:center;">
  <a href="{ruta_archives_16S_revision_inicial_sample_metadata}" target="_blank" class="boton-iframe">
    üîç Ver metadatos completos en una nueva p√°gina
  </a>
</p>
\n\n'))
```

```{r, results="asis"}
cat(glue::glue('
<p>
  As√≠, observando dicha tabla, concretamente la columna <code>SampleID</code>, podemos ver que el experimento comprende <strong>{n_samples}</strong> muestras √∫nicas, organizadas seg√∫n los <strong>Tipos principales</strong>, <strong>Subtipos</strong> y <strong>tandas</strong>. A continuaci√≥n se listan los distintos valores detectados en el archivo de metadatos:
</p>

<ul>
  <li><strong>Tipos principales (Type)</strong>: {metricas_metadata$lista_Type}</li>
  <li><strong>Subtipos (TypeII)</strong>: {metricas_metadata$lista_TypeII}</li>
  <li><strong>Tandas</strong>: {metricas_metadata$lista_tandas}</li>
</ul>
'))
```

<p>
  El archivo de metadatos es una pieza esencial para asegurar la trazabilidad del an√°lisis, ya que documenta de forma estructurada la correspondencia entre las muestras, sus nombres internos y los grupos experimentales. Esta trazabilidad garantiza tanto la reproducibilidad como una interpretaci√≥n correcta de los resultados obtenidos.
</p>










<div style="height: 20px; background-color: transparent;"></div>

<div class="titulo2" id="tab3-seccion1.3">
  1.3. Exploraci√≥n inicial de las muestras de entrada
</div>

<p>
  Este apartado tiene como objetivo ofrecer una primera visi√≥n estructurada de los archivos de lectura que constituyen la base del an√°lisis metagen√≥mico 16S. Estos archivos, en formato <code>.fastq.gz</code>, representan las secuencias crudas obtenidas tras la secuenciaci√≥n del ADN ribosomal 16S y han sido previamente organizados para su uso en el pipeline de an√°lisis.
</p>

<p>
  Las muestras empleadas en este estudio han sido definidas en el archivo de metadatos, y cada identificador se ha vinculado de manera coherente con los archivos de lectura correspondientes. Esta asociaci√≥n garantiza la trazabilidad completa desde los datos crudos hasta los resultados taxon√≥micos y funcionales, minimizando posibles inconsistencias en las fases posteriores.
</p>

<p>
  A continuaci√≥n, se indica el directorio donde se encontraban almacenados los archivos de lectura seleccionados para el an√°lisis en el momento de generaci√≥n del informe:
</p>

```{r, results='asis'}
cat(glue::glue('
<code>{ruta_reads_16S}</code>
\n\n'))
```

<p>
  Este directorio contiene una copia estructurada de los archivos de lectura para cada muestra incluida en el an√°lisis. Cada archivo <code>.fastq.gz</code> ha sido nombrado de forma coherente con la tabla de metadatos, lo que facilita la automatizaci√≥n y reproducibilidad del flujo de trabajo.
</p>

<p>
  En la siguiente tabla interactiva se muestra el listado completo de archivos que ser√°n empleados en las etapas de control de calidad y posterior inferencia taxon√≥mica. Esta vista permite verificar r√°pidamente la integridad del conjunto de muestras y su correspondencia con la informaci√≥n previamente definida:
</p>

<div class="box-files">

```{r, results="asis"}
if (!dir.exists(ruta_reads_16S)) {
  cat(sprintf('<p><em>La ruta "%s" no existe o no es accesible.</em></p>\n', ruta_reads_16S))
} else {
  # Listar solo archivos con extensi√≥n .ht2
  files <- list.files(ruta_reads_16S, pattern = "\\.fastq.gz$", full.names = FALSE)
  
  if (length(files) == 0) {
    cat('<p><em>No se encontraron archivos con extensi√≥n <code>.fastq.gz</code> en la carpeta especificada.</em></p>\n')
  } else {
    enlace <- paste0("file://", ruta_reads_16S)
    
    cat("<ul>\n")
    for (f in files) {
      # Asignar clase seg√∫n la extensi√≥n
      clase <- if (!grepl("\\.", f)) {
        "file-folder"
      } else if (grepl("\\.html$", f)) {
        "file-html"
      } else if (grepl("\\.zip$", f)) {
        "file-zip"
      } else if (grepl("\\.fastq\\.gz$", f)) {
        "file-fastqgz"
      } else {
        "file-default"
      }
      
      cat(sprintf('<li class="%s"><a href="%s/%s" target="_blank">%s</a></li>\n',
                  clase, enlace, f, f))
    }
    cat("</ul>\n")
  }
}
```

</div>

<div style="height: 15px; background-color: transparent;"></div>

<p>
  Tras esta exploraci√≥n preliminar, el informe contin√∫a con la secci√≥n dedicada al control de calidad de los datos crudos. En ella se presenta un resumen global generado mediante <code>MultiQC</code>, que integra las m√©tricas de calidad de todas las muestras procesadas.
</p>

<p>
  Adem√°s del resumen agregado, tambi√©n se incluyen los informes individuales generados por <code>FastQC</code>. Estos informes detallan aspectos espec√≠ficos de cada muestra, como la calidad base a base, la longitud de las secuencias, la proporci√≥n de contenido GC, y la presencia de secuencias adaptadoras o contaminantes, m√©tricas clave para asegurar la fiabilidad del an√°lisis metagen√≥mico.
</p>
