---
title: "Metagenomic Report"

include-in-header:
  text: |
    <link rel="shortcut icon" href="../../../../1-images/icono/favicon.svg"/>
    <link rel="icon" type="image/x-icon" href="../../../../1-images/icono/favicon.ico">

params:
  ruta_proyecto: ""
  tipo_analisis: ""
---


<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->
<!--  TAB 3: AN√ÅLISIS | 4. ASIGNACI√ìN TAXON√ìMICA Y FILOGENIA -->
<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->

```{r}
# Cargar librer√≠as
library(glue)
library(fs)
library(stringr)
library(dplyr)


# Rutas clave
ruta_qmd <- getwd()
ruta_metagenomic_pipeline <- file.path("..", "..", "..", "..", "..", "..")
nombre_proyecto <- basename(params$ruta_proyecto)


# Rutas de resultados Nextflow
ruta_nextflow_results <- file.path("..", "..", "..", "..", "..", "..", "resources", "2-nextflow-results")
ruta_proyecto_relativa <- file.path("..", "..", "..", "..", "..", "..", "resources", "2-nextflow-results", "1-project-data", nombre_proyecto)


# Rutas de la carpeta Def
ruta_Def <- file.path(params$ruta_proyecto, "Resultados", "Def")
ruta_Def_relativa <- file.path(ruta_proyecto_relativa, "Resultados", "Def")


# Rutas de la carpeta exported
ruta_exported <- file.path(ruta_Def, "exported")
ruta_exported_relativa <- file.path(ruta_Def_relativa, "exported")
```


<div class="informe-titulo-tab">
  <h1>Pesta√±a</h1>
  <h2>An√°lisis 16S bioinform√°tico completo</h2>
</div>

<div class="informe-titulo-seccion">
  <h1>Secci√≥n 3</h1>
  <h2>Asignaci√≥n taxon√≥mica y filogenia</h2>
</div>

<div class="informe-resumen">
  <h2>Resumen</h2>

  <p>
    En la secci√≥n <strong>4. Asignaci√≥n taxon√≥mica y filogenia</strong> nos enfocamos en caracterizar de manera profunda las secuencias representativas obtenidas en la <a href="3-generacion-asvs.html#tab3-seccion3" class="normalink">secci√≥n 3. Generaci√≥n de ASVs y tabla de abundancia</a> y en situarlas en un contexto biol√≥gico y evolutivo. Tras haber generado la tabla de abundancia de ASVs (`table.qzv`) y las secuencias representativas (`my_taxonomy.qzv`), tenemos identificadas las unidades de secuencia consistentes y de alta calidad en nuestras muestras. Sin embargo, conocer √∫nicamente las secuencias no nos permite determinar qu√© microorganismos est√°n presentes ni c√≥mo se relacionan filogen√©ticamente. Por ello, esta secci√≥n se centra en dos aspectos complementarios y esenciales: la asignaci√≥n taxon√≥mica y la construcci√≥n de un √°rbol filogen√©tico.
  </p>

  <p>
    En la subsecci√≥n <strong>4.1. Asignaci√≥n taxon√≥mica</strong> buscamos determinar a qu√© organismos corresponden nuestras ASVs. Para ello utilizamos bases de datos de referencia como SILVA o Greengenes y aplicamos un clasificador de Naive Bayes entrenado previamente. Cada ASV se compara con las secuencias de referencia, asign√°ndose al tax√≥n m√°s probable en distintos niveles jer√°rquicos, desde dominio hasta especie. Este proceso permite transformar nuestras secuencias crudas en informaci√≥n biol√≥gica interpretable, mostrando ‚Äúqui√©n est√° presente‚Äù en cada muestra y en cada grupo experimental.
  </p>

  <p>
    Los resultados incluyen tanto archivos de datos como visualizaciones gr√°ficas. Entre ellos se encuentran: el archivo de taxonom√≠a (`taxonomy.qza`) y su versi√≥n interactiva (`taxonomy.qzv`), gr√°ficas de barras que muestran la composici√≥n relativa de cada muestra (`taxa-bar-plots.qzv`), y tablas exportadas por niveles taxon√≥micos, como familia (`feature-table_l5_export.tsv`) y g√©nero (`feature-table_l6_export.tsv`). Adem√°s, se generan gr√°ficos SVG (`level-5-bars.svg` y `level-6-bars.svg`) que permiten una r√°pida interpretaci√≥n visual de la abundancia de los taxones. Esta informaci√≥n es fundamental para interpretar posteriormente los an√°lisis de abundancia diferencial, ya que nos permite identificar qu√© familias o g√©neros var√≠an entre los grupos experimentales.
  </p>

  <p>
    En la subsecci√≥n <strong>4.2. Construcci√≥n del √°rbol filogen√©tico</strong> nos centramos en la relaci√≥n evolutiva entre las ASVs. Utilizando herramientas de alineamiento m√∫ltiple como MAFFT y construcci√≥n de √°rboles con FastTree, generamos tanto un √°rbol sin ra√≠z (`unrooted-tree.qza`) como un √°rbol enraizado (`rooted-tree.qza`). El √°rbol sin ra√≠z muestra las relaciones generales entre ASVs sin asumir un ancestro com√∫n, mientras que el √°rbol enraizado es necesario para calcular m√©tricas de diversidad filogen√©tica, como Faith‚Äôs Phylogenetic Diversity y UniFrac. Adem√°s, se generan archivos de alineamiento (`aligned-my_taxonomy.qza`) y versiones enmascaradas (`masked-aligned-my_taxonomy.qza`) para minimizar el ruido en regiones altamente variables.
  </p>

  <p>
    Aunque los √°rboles filogen√©ticos no se interpretan directamente para describir la biolog√≠a de las muestras, son esenciales para realizar an√°lisis de diversidad alfa y beta y para contextualizar las comparaciones filogen√©ticamente informadas entre grupos. Esto asegura que las conclusiones sobre composici√≥n microbiana y diferencias entre muestras est√©n respaldadas por evidencia evolutiva s√≥lida.
  </p>

  <p>
    En conjunto, la secci√≥n 4 establece un puente cr√≠tico entre la generaci√≥n de ASVs (<a href="3-generacion-asvs.html#tab3-seccion3" class="normalink">secci√≥n 3</a>) y los an√°lisis de abundancia diferencial y diversidad microbiana (<a href="5-analisis-diferencial.html#tab3-seccion5" class="normalink">secci√≥n 5</a> y <a href="6-diversidad-funcional.html#tab3-seccion6" class="normalink">secci√≥n 6</a>). Primero identificamos ‚Äúqui√©n est√° presente‚Äù mediante la asignaci√≥n taxon√≥mica, y luego proporcionamos la estructura filogen√©tica necesaria para contextualizar la diversidad y abundancia microbiana. Este enfoque integrado asegura que los resultados posteriores est√©n fundamentados tanto en evidencia taxon√≥mica como filogen√©tica, facilitando un an√°lisis riguroso y coherente de la microbiota.
  </p>
</div>










<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo-toc">
  Tabla de contenidos de esta secci√≥n
</div>

```{=html}
```{r, results="asis"}
cat('<div class="toc">
  <ul>
    <li>
      <a href="#tab3-seccion4">
        4<span>.</span> Asignaci√≥n taxon√≥mica y filogenia
      </a>
      <ul>
        <li>
          <a href="#tab3-seccion4.1">
            4.1. Asignaci√≥n taxon√≥mica
          </a>
          <ul>
            <li>
              <a href="#tab3-seccion4.1.1">
                4.1.1. Archivos principales
              </a>
            </li>
            <li>
              <a href="#tab3-seccion4.1.2">
                4.1.2. Visualizaci√≥n de composici√≥n taxon√≥mica
              </a>
              <ul>
                <li>
                  <a href="#tab3-seccion4.1.2.1">
                    4.1.2.1. Visualizaci√≥n interactiva de la composici√≥n taxon√≥mica
                  </a>
                </li>
')

# Generar los enlaces para las tablas por nivel taxon√≥mico
for (nivel in 1:7) {
  numero_sub <- nivel + 1 # para no colisionar con la visualizaci√≥n interactiva
  cat(glue('
                <li>
                  <a href="#tab3-seccion4.1.2.{numero_sub}">
                    4.1.2.{numero_sub}. Tabla interactiva de abundancia de ASVs por nivel taxon√≥mico {nivel}
                  </a>
                </li>
  '))
}

cat('
              </ul>
            </li>
            <li>
              <a href="#tab3-seccion4.1.3">
                4.1.3. Archivos exportados por niveles taxon√≥micos
              </a>
              <ul>
                <li>
                  <a href="#tab3-seccion4.1.3.1">
                    4.1.3.1. Tabla de abundancia relativa a nivel taxon√≥mico: <strong>Familia (L5)</strong>
                  </a>
                </li>
                <li>
                  <a href="#tab3-seccion4.1.3.2">
                    4.1.3.2. Tabla de abundancia relativa a nivel taxon√≥mico: <strong>G√©nero (L6)</strong>
                  </a>
                </li>
                <li>
                  <a href="#tab3-seccion4.1.3.2">
                    4.1.3.2. Tabla de abundancia relativa a nivel taxon√≥mico: <strong>Especie (L7)</strong>
                  </a>
                </li>
              </ul>
            </li>
          </ul>
        </li>
        <li>
          <a href="#tab3-seccion4.2">
            4.2. Construcci√≥n del √°rbol filogen√©tico
          </a>
          <ul>
            <li>
              <a href="#tab3-seccion4.2.1">
                4.2.1. Archivos principales
              </a>
            </li>
            <li>
              <a href="#tab3-seccion4.2.2">
                4.2.2. Diferencias entre √°rboles
              </a>
              <ul>
                <li>
                  <a href="#tab3-seccion4.2.2.1">
                    4.2.2.1. √Årbol sin ra√≠z
                  </a>
                </li>
                <li>
                  <a href="#tab3-seccion4.2.2.2">
                    4.2.2.2. √Årbol enraizado
                  </a>
                </li>
              </ul>
            </li>
            <li>
              <a href="#tab3-seccion4.2.3">
                4.2.3. Relaci√≥n con an√°lisis posteriores
              </a>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</div>
')
```
```

```{=html}
```










<!-- #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->
<!-- REDACCI√ìN -->
<!-- #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->

<div style="height: 25px; background-color: transparent;"></div>

<div class="titulo1" id="tab3-seccion4">
  4<span>.</span> Asignaci√≥n taxon√≥mica y filogenia
</div>

<p>
  Tras haber generado nuestras unidades representativas de secuencia (ASVs) en la <a href="3-generacion-asvs.html#tab3-seccion3" class="normalink">secci√≥n 3</a>, contamos con un conjunto de secuencias de alta calidad que reflejan las variaciones microbianas presentes en cada muestra. Sin embargo, estas secuencias por s√≠ solas no nos dicen qu√© organismos est√°n presentes ni c√≥mo se relacionan evolutivamente. La <strong>asignaci√≥n taxon√≥mica</strong> y la <strong>construcci√≥n filogen√©tica</strong> son pasos esenciales para contextualizar biol√≥gicamente nuestras ASVs, permiti√©ndonos pasar de simples fragmentos de ADN a informaci√≥n ecol√≥gica y evolutiva significativa.
</p>

<p>
  La asignaci√≥n taxon√≥mica consiste en comparar cada ASV con bases de datos de referencia curadas, como SILVA o Greengenes, mediante clasificadores como el Naive Bayes entrenado previamente. Esto nos permite asignar a cada secuencia un tax√≥n en niveles jer√°rquicos que van desde el dominio hasta la especie, generando un perfil detallado de la composici√≥n microbiana de nuestras muestras. Este paso es crucial, ya que proporciona la base sobre la que se interpretar√°n los resultados de abundancia diferencial y otros an√°lisis posteriores.
</p>

<p>
  Por otro lado, la construcci√≥n del <strong>√°rbol filogen√©tico</strong> organiza todas las ASVs en una estructura evolutiva que refleja sus relaciones ancestrales y divergencias. Utilizando herramientas de alineamiento m√∫ltiple como MAFFT y algoritmos de construcci√≥n de √°rboles como FastTree, se generan √°rboles enraizados y sin ra√≠z que sirven para calcular m√©tricas de diversidad filogen√©tica (por ejemplo, Faith‚Äôs Phylogenetic Diversity o UniFrac). Aunque estos √°rboles no se interpretan directamente para describir la biolog√≠a de cada muestra, son esenciales para contextualizar las comparaciones de diversidad entre grupos de manera filogen√©ticamente informada.
</p>

<p>
  En esta secci√≥n, comenzaremos por la <strong>asignaci√≥n taxon√≥mica</strong> (<a href="#tab3-seccion4.1" class="normalink">subsecci√≥n 4.1</a>), identificando ‚Äúqui√©n est√° presente‚Äù en cada muestra y visualizando la composici√≥n microbiana a distintos niveles jer√°rquicos mediante tablas y gr√°ficos. Posteriormente, en la <a href="#tab3-seccion4.2" class="normalink">subsecci√≥n 4.2</a>, construiremos y analizaremos el √°rbol filogen√©tico, proporcionando la estructura necesaria para los an√°lisis de diversidad alfa, beta y otras m√©tricas filogen√©ticamente informadas. En conjunto, esta secci√≥n establece el puente entre la obtenci√≥n de ASVs y los an√°lisis de abundancia diferencial y diversidad que se abordar√°n en las siguientes secciones del informe.
</p>










<div style="height: 20px; background-color: transparent;"></div>

<div class="titulo2" id="tab3-seccion4.1">
  4.1. Asignaci√≥n taxon√≥mica
</div>

<p>
  La asignaci√≥n taxon√≥mica constituye un paso clave en el an√°lisis de datos de metagen√≥mica 16S, ya que nos permite identificar a qu√© organismos corresponden las secuencias representativas obtenidas previamente en la <a href="3-generacion-asvs.html#tab3-seccion3" class="normalink">secci√≥n 3</a>. Cada ASV, que representa una unidad biol√≥gica consistente dentro de nuestras muestras, se compara con una base de datos de referencia curada, como <strong>SILVA</strong> o <strong>Greengenes</strong>, para determinar su taxonom√≠a. Esta clasificaci√≥n se realiza utilizando un clasificador probabil√≠stico, com√∫nmente un modelo de <strong>Naive Bayes</strong>, previamente entrenado sobre la regi√≥n amplificada del 16S (por ejemplo, V3-V4) para que el mapeo sea preciso y espec√≠fico para nuestra regi√≥n de inter√©s.
</p>

<p>
  El resultado de este proceso es una asignaci√≥n taxon√≥mica jer√°rquica para cada ASV, que puede ir desde el nivel m√°s general (dominio) hasta niveles m√°s espec√≠ficos como familia, g√©nero e incluso especie, dependiendo de la resoluci√≥n de la base de datos y la regi√≥n amplificada. Esta informaci√≥n es fundamental no solo para describir la composici√≥n microbiana de las muestras, sino tambi√©n para realizar comparaciones entre grupos experimentales, estudios de abundancia diferencial y an√°lisis de diversidad.
</p>

<p>
  En esta subsecci√≥n comenzaremos por generar la tabla de asignaciones taxon√≥micas en formato QIIME2 (`my_taxonomy.qza`) y su visualizaci√≥n interactiva (`my_taxonomy.qzv`) y m√°s adelante, en la siguiente, mostraremos c√≥mo representar gr√°ficamente la composici√≥n microbiana por muestra o por grupo experimental mediante gr√°ficas de barras (`taxa-bar-plots.qzv`) y c√≥mo exportar estas tablas a archivos TSV desglosados por niveles taxon√≥micos (familia, g√©nero y especie) para un an√°lisis m√°s detallado. 
</p>

<p>
  En conjunto, esta introducci√≥n establece el marco conceptual para interpretar qu√© microorganismos est√°n presentes en nuestras muestras y proporciona la base necesaria para la subsecci√≥n siguiente, donde se explorar√° la visualizaci√≥n y exportaci√≥n de la composici√≥n taxon√≥mica a distintos niveles jer√°rquicos.
</p>








<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo3" id="tab3-seccion4.1.1">
  4.1.1. Archivos principales generados
</div>

```{r}
# Definir ruta del archivo .qzv
ruta_my_taxonomy_qzv_relativa <- file.path(ruta_Def_relativa, "my_taxonomy.qzv")
ruta_my_taxonomy_qzv <- file.path(ruta_Def, "my_taxonomy.qzv")

# Definir ruta del archivo .qza
ruta_my_taxonomy_qza_relativa <- file.path(ruta_Def_relativa, "my_taxonomy.qza")
ruta_my_taxonomy_qza <- file.path(ruta_Def, "my_taxonomy.qza")

# Definir ruta de salida para el unzip
ruta_Def_unzip <- file.path(ruta_Def_relativa, "unzip")
ruta_unzip_my_taxonomy <- file.path(ruta_Def_unzip, "my_taxonomy")

# Crear carpeta de salida si no existe
if (!dir.exists(ruta_Def_unzip)) dir.create(ruta_Def_unzip, recursive = TRUE)

# Solo hacer unzip si el archivo existe
if (file.exists(ruta_my_taxonomy_qzv_relativa)) {
  # Usando system2 para llamar a unzip desde R
  system2("unzip", args = c("-o", shQuote(ruta_my_taxonomy_qzv_relativa),
                            "-d", shQuote(ruta_unzip_my_taxonomy)))
} else {
  message("‚ö†Ô∏è El archivo my_taxonomy.qzv no existe. Se omite el unzip.")
}
```

```{r}
# Comprobar que el unzip se ha realizado
if (dir.exists(ruta_unzip_my_taxonomy)) {
  
  # Listar subcarpetas dentro de la carpeta unzip (solo 1er nivel)
  subcarpetas <- list.dirs(ruta_unzip_my_taxonomy, recursive = FALSE, full.names = TRUE)
  
  if (length(subcarpetas) == 0) {
    stop("No se encontr√≥ ninguna subcarpeta dentro de ", ruta_unzip_my_taxonomy)
  }
  
  # Tomamos la primera subcarpeta (la aleatoria generada por QIIME2)
  carpeta_random <- subcarpetas[1]
  
  # Ruta a 'data'
  ruta_data <- file.path(carpeta_random, "data")
  
  # Archivos dentro de 'data'
  ruta_metadata_tsv <- file.path(ruta_data, "metadata.tsv")
  ruta_index_html <- file.path(ruta_data, "index.html")
  
  # Comprobar que existen
  if (!file.exists(ruta_metadata_tsv)) message("‚ö†Ô∏è metadata.tsv no encontrado")
  if (!file.exists(ruta_index_html)) message("‚ö†Ô∏è index.html no encontrado")
  
} else {
  message("‚ö†Ô∏è Carpeta de unzip no encontrada. No se puede acceder a los archivos.")
}
```

<p>
  Se detallan los principales archivos generados durante la asignaci√≥n taxon√≥mica de las ASVs. Estos archivos son fundamentales para interpretar qu√© microorganismos est√°n presentes en las muestras, as√≠ como para realizar an√°lisis posteriores de abundancia diferencial y diversidad. Los dos archivos clave son:
</p>

<ul>
  <li>
    <strong>my_taxonomy.qza</strong>: un <em>artefacto QIIME2</em> que contiene la tabla de asignaciones taxon√≥micas para cada ASV, incluyendo el <strong>Feature.ID</strong>, el tax√≥n asignado y el valor de confianza de la clasificaci√≥n. Este archivo puede ser le√≠do directamente en R o Python usando <code>read_qza()</code>, lo que permite acceder a los datos en un formato estructurado mediante el objeto <code>$data</code>.
  </li>
  <li>
    <strong>my_taxonomy.qzv</strong>: un archivo de visualizaci√≥n interactiva que incluye los mismos datos que <code>my_taxonomy.qza</code>, empaquetados junto con la interfaz web para exploraci√≥n visual. Al descomprimir este archivo (ya que es un ZIP), se obtiene el archivo <code>metadata.tsv</code> con la tabla de taxonom√≠a y los elementos necesarios para la visualizaci√≥n (<code>index.html</code>, <code>css</code>, <code>js</code> y <code>q2templateassets</code>).
  </li>
</ul>

<p>
  La combinaci√≥n de estos archivos permite tanto la exploraci√≥n interactiva de la taxonom√≠a como el an√°lisis program√°tico en R o Python. A continuaci√≥n se indican las rutas de los archivos dentro del proyecto:
</p>

```{r, results="asis"}
if (file.exists(ruta_my_taxonomy_qzv)) {
  cat(glue::glue('
<code>{ruta_my_taxonomy_qzv}</code>
\n\n'))
} else {
  cat(glue::glue('
‚ö†Ô∏è El archivo <code>my_taxonomy.qzv</code> no existe en la ruta especificada: 
<code>{ruta_my_taxonomy_qzv}</code>
\n\n'))
}
```

```{r, results="asis"}
if (file.exists(ruta_my_taxonomy_qza)) {
  cat(glue::glue('
<code>{ruta_my_taxonomy_qza}</code>
\n\n'))
} else {
  cat(glue::glue('
‚ö†Ô∏è El archivo <code>my_taxonomy.qza</code> no existe en la ruta especificada: 
<code>{ruta_my_taxonomy_qza}</code>
\n\n'))
}
```

<p>
  La tabla de asignaci√≥n taxon√≥mica puede obtenerse mediante dos m√©todos equivalentes:
</p>

<ol>
  <li>Leyendo directamente el artefacto <code>my_taxonomy.qza</code> en R o Python mediante <code>read_qza()</code>, lo que permite acceder a los datos completos de las ASVs.</li>
  <li>Descomprimiendo el archivo <code>my_taxonomy.qzv</code> y leyendo el archivo <code>metadata.tsv</code>, que contiene la misma informaci√≥n en formato tabular y listo para explorar en cualquier software de hojas de c√°lculo o an√°lisis de datos.</li>
</ol>

<p>
  Dicho esto, a continuaci√≥n se muestra dicha tabla de taxonom√≠a. Esta visualizaci√≥n interactiva facilita la inspecci√≥n de cada ASV, su tax√≥n asignado y el nivel de confianza de la clasificaci√≥n. Adem√°s, se proporciona un enlace para descargar el archivo <code>metadata.tsv</code> original, permitiendo que el usuario pueda guardar y reutilizar los datos de taxonom√≠a de manera independiente.
</p>

```{r}
# Leer el archivo y mostrar tabla interactiva
if (file.exists(ruta_my_taxonomy_qzv)) {
  library(readr)
  metadata <- read_tsv(ruta_metadata_tsv, comment = "#", show_col_types = FALSE)

  # Tabla interactiva
  library(DT)
  library(htmltools)
  htmltools::div(
    class = "scroll-y-max-500",
    DT::datatable(
      metadata,
      options = list(
        scrollX = TRUE,
        paging = FALSE,
        lengthChange = FALSE,
        language = list(
          url = '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
        )
      ),
      class = 'stripe hover compact'
    )
  )
  
} else {
  cat(glue::glue('
  cat("Archivo "{ruta_my_taxonomy_qza}" no encontrado. Verifica la ruta.")
  \n\n'))
}
```

```{r, results='asis'}
if (file.exists(ruta_metadata_tsv)) {

  cat(glue::glue('
  <p style="text-align:center;">
    <a href="{ruta_metadata_tsv}" target="_blank" class="boton-file">
      üíæ¬†Descargar archivo "metadata.tsv" original
    </a>
  </p>
  \n\n'))
}
```

<p>
  Para una exploraci√≥n m√°s completa, se puede mostrar la visualizaci√≥n interactiva generada por QIIME2 directamente en el informe mediante un <code>iframe</code>. Esto permite inspeccionar la tabla y navegar por los datos con todas las funcionalidades de la interfaz de QIIME2 sin salir del documento.
</p>

```{r, results='asis'}
# Generar iframe para Quarto si existe index.html
if (file.exists(ruta_index_html)) {

  cat(glue::glue('
  <iframe src="{ruta_index_html}" width="100%" height="700px" style="border: 1px solid #ccc; border-radius: 6px;"></iframe>

  <p style="text-align:center;">
    <a href="{ruta_index_html}" target="_blank" class="boton-iframe">
      üîç Ver matriz normalizada en una nueva p√°gina
    </a>
  </p>

  <div style="height: 15px; background-color: transparent;"></div>
  \n\n'))
}
```

<p>
  En resumen, esta subsecci√≥n proporciona un marco completo para entender qu√© contienen los archivos de asignaci√≥n taxon√≥mica, c√≥mo se pueden visualizar y manipular, y c√≥mo estos resultados servir√°n de base para los an√°lisis posteriores de composici√≥n microbiana y comparaci√≥n entre grupos experimentales.
</p>








<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo2" id="tab3-seccion3.2">
  4.1.2. Visualizaci√≥n de composici√≥n taxon√≥mica
</div>

```{r}
# Definir ruta del archivo .qzv
ruta_taxa_bar_plots_qzv_relativa <- file.path(ruta_Def_relativa, "taxa-bar-plots.qzv")
ruta_taxa_bar_plots_qzv <- file.path(ruta_Def, "taxa-bar-plots.qzv")

# Definir ruta de salida para el unzip
ruta_Def_unzip <- file.path(ruta_Def_relativa, "unzip")
ruta_unzip_taxa_bar_plots <- file.path(ruta_Def_unzip, "taxa-bar-plots")

# Crear carpeta de salida si no existe
if (!dir.exists(ruta_Def_unzip)) dir.create(ruta_Def_unzip, recursive = TRUE)

# Solo hacer unzip si el archivo existe
if (file.exists(ruta_taxa_bar_plots_qzv_relativa)) {
  # Usando system2 para llamar a unzip desde R
  system2("unzip", args = c("-o", shQuote(ruta_taxa_bar_plots_qzv_relativa),
                            "-d", shQuote(ruta_unzip_taxa_bar_plots)))
} else {
  message("‚ö†Ô∏è El archivo taxa-bar-plots.qzv no existe. Se omite el unzip.")
}
```

```{r}
# Comprobar que el unzip se ha realizado
if (dir.exists(ruta_unzip_taxa_bar_plots)) {
  
  # Listar subcarpetas dentro de la carpeta unzip (solo 1er nivel)
  subcarpetas <- list.dirs(ruta_unzip_taxa_bar_plots, recursive = FALSE, full.names = TRUE)
  
  if (length(subcarpetas) == 0) {
    stop("No se encontr√≥ ninguna subcarpeta dentro de ", ruta_unzip_taxa_bar_plots)
  }
  
  # Tomamos la primera subcarpeta (la aleatoria generada por QIIME2)
  carpeta_random <- subcarpetas[1]
  
  # Ruta a 'data'
  ruta_data <- file.path(carpeta_random, "data")
  
  # Archivos dentro de 'data'
  ruta_index_html <- file.path(ruta_data, "index.html")
  
  # Comprobar que existen
  if (!file.exists(ruta_index_html)) message("‚ö†Ô∏è index.html no encontrado")
  
} else {
  message("‚ö†Ô∏è Carpeta de unzip no encontrada. No se puede acceder a los archivos.")
}
```

<p>
  Una vez realizada la asignaci√≥n taxon√≥mica de las ASVs, el siguiente paso consiste en explorar c√≥mo se distribuyen los distintos taxones en nuestras muestras. Para ello, QIIME2 genera los gr√°ficos interactivos de barras contenidos en <code>taxa-bar-plots.qzv</code>. Cada barra representa una muestra individual o un grupo de muestras, y los segmentos de la barra reflejan la proporci√≥n relativa de cada tax√≥n dentro de esa muestra. Esta representaci√≥n permite identificar patrones de abundancia y variabilidad entre grupos experimentales, as√≠ como detectar taxones dominantes o minoritarios en cada nivel jer√°rquico.
</p>

<p>
  Los niveles taxon√≥micos mostrados pueden abarcar desde el nivel m√°s general, como <em>filo</em> o <em>clase</em>, hasta niveles m√°s espec√≠ficos como <em>familia</em>, <em>g√©nero</em> o <em>especie</em>, seg√∫n la resoluci√≥n de la base de datos y la regi√≥n amplificada. La visualizaci√≥n interactiva permite filtrar, ordenar y seleccionar taxones para analizar la composici√≥n microbiana de forma din√°mica.
</p>

<p>
  Antes de incrustar los gr√°ficos, conviene conocer la ruta donde se encuentra el archivo <code>taxa-bar-plots.qzv</code> dentro de nuestro proyecto:
</p>

```{r, results="asis"}
if (file.exists(ruta_taxa_bar_plots_qzv)) {
  cat(glue::glue('
<code>{ruta_taxa_bar_plots_qzv}</code>
\n\n'))
} else {
  cat(glue::glue('
‚ö†Ô∏è El archivo <code>taxa-bar-plots.qzv</code> no existe en la ruta especificada: 
<code>{ruta_taxa_bar_plots_qzv}</code>
\n\n'))
}
```






<div style="height: 13px; background-color: transparent;"></div>

<div class="titulo4" id="tab3-seccion4.1.2.1">
  4.1.2.1. Visualizaci√≥n interactiva de la composici√≥n taxon√≥mica
</div>

<p>
  La visualizaci√≥n interactiva generada por QIIME2 se encuentra en el archivo <code>index.html</code> dentro de la carpeta descomprimida del artefacto <code>taxa-bar-plots.qzv</code>. Este gr√°fico permite:
</p>

<ul>
  <li>Explorar la abundancia relativa de cada tax√≥n por muestra o grupo experimental de forma din√°mica.</li>
  <li>Filtrar o agrupar taxones seg√∫n niveles jer√°rquicos (por ejemplo, familia o g√©nero).</li>
  <li>Detectar taxones dominantes, minoritarios o patrones de variabilidad entre muestras.</li>
  <li>Facilitar la interpretaci√≥n visual previa a la exportaci√≥n de datos para an√°lisis estad√≠sticos o comparaciones entre grupos.</li>
</ul>

<p>
  Para integrarlo directamente en el informe, podemos incrustar el <code>index.html</code> dentro de un <code>iframe</code> que nos permitir√° interactuar con la composici√≥n taxon√≥mica sin salir del documento:
</p>

```{r, results='asis'}
# Generar iframe para Quarto si existe index.html
if (file.exists(ruta_index_html)) {

  cat(glue::glue('
  <iframe src="{ruta_index_html}" width="100%" height="700px" style="border: 1px solid #ccc; border-radius: 6px;"></iframe>

  <p style="text-align:center;">
    <a href="{ruta_index_html}" target="_blank" class="boton-iframe">
      üìä Abrir informe en nueva pesta√±a
    </a>
  </p>
  \n\n'))
}
```

<p>
  Esta secci√≥n proporciona una exploraci√≥n visual inmediata de la composici√≥n microbiana, facilitando la interpretaci√≥n de los datos y sirviendo como base para la subsecci√≥n siguiente, donde se mostrar√°n las tablas exportadas por niveles taxon√≥micos para un an√°lisis m√°s detallado.
</p>

<p>
  Adem√°s de la visualizaci√≥n interactiva de los gr√°ficos de barras, QIIME2 permite exportar los datos subyacentes de la composici√≥n taxon√≥mica en archivos CSV por nivel jer√°rquico (<code>level-1.csv</code> hasta <code>level-7.csv</code>). Cada archivo contiene una tabla de abundancia relativa en la que las filas corresponden a los distintos taxones detectados y las columnas a las muestras analizadas.
</p>

<p>
  Estos archivos son particularmente √∫tiles cuando se requiere:
</p>

<ul>
  <li>Explorar los datos de manera m√°s detallada y tabular, m√°s all√° de lo que se visualiza en los gr√°ficos interactivos.</li>
  <li>Exportar informaci√≥n para an√°lisis estad√≠sticos adicionales, comparaciones entre grupos o c√°lculos de diversidad.</li>
  <li>Filtrar o agrupar taxones seg√∫n el nivel taxon√≥mico, permitiendo estudiar patrones de abundancia a distintos niveles (por ejemplo, filo, familia, g√©nero o especie).</li>
  <li>Automatizar la generaci√≥n de reportes reproducibles, integrando estas tablas directamente en documentos Quarto o R Markdown.</li>
</ul>

<p>
  A continuaci√≥n se muestran las tablas de abundancia correspondientes a cada nivel taxon√≥mico. Cada tabla es interactiva, lo que permite ordenar, buscar y desplazarse horizontalmente para explorar la composici√≥n de las ASVs en las distintas muestras. Los niveles m√°s bajos (p.ej., 5, 6 y 7) suelen corresponder a familia, g√©nero y especie, mientras que los niveles superiores muestran categor√≠as m√°s generales como dominio, filo o clase.
</p

```{r, results='asis'}
# Listar los archivos CSV por nivel taxon√≥mico
archivos_csv <- list.files(ruta_data, pattern="level-[0-9]+\\.csv$", full.names=TRUE)

for (f in archivos_csv) {
  
  # Extraer el n√∫mero de nivel del nombre del archivo
  nivel <- as.numeric(sub(".*level-([0-9]+)\\.csv$", "\\1", f))
  
  # Subt√≠tulo para la tabla: sumamos 1 para que no choque con el index.html anterior
  cat(glue::glue('
  <div style="height: 13px; background-color: transparent;"></div>

  <div class="titulo4" id="tab3-seccion4.1.2.{nivel+1}" style="margin-top: 67px; margin-bottom: 13px;">
    4.1.2.{nivel+1}. Tabla interactiva de abundancia de ASVs por nivel taxon√≥mico {nivel}
  </div>
  '))
  
  # P√°rrafo explicativo previo a la tabla
  cat(glue::glue('
  <p>
    La siguiente tabla corresponde al nivel taxon√≥mico {nivel} de las ASVs, mostrando la abundancia relativa de cada tax√≥n en cada muestra. 
    Esta representaci√≥n tabular permite un an√°lisis m√°s fino de la composici√≥n microbiana y es complementaria a la visualizaci√≥n interactiva de QIIME2.
  </p>
  '))
  
  # Leer y mostrar tabla si existe
  if (file.exists(f)) {
    datos <- read.csv(f, check.names = FALSE)
    
    # Chunk para tabla interactiva con DT
    library(DT)
    library(htmltools)
    print(
      htmltools::div(
        class = "scroll-y-max-500",
        DT::datatable(
          datos,
          options = list(
            scrollX = TRUE,
            paging = FALSE,
            lengthChange = FALSE,
            language = list(
              url = "//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json"
            )
          ),
          class = "stripe hover compact"
        )
      )
    )
    
    # Enlace para descargar el CSV original
    cat(glue::glue('
    <div style="height: 15px; background-color: transparent;"></div>

    <p style="text-align:center">
      <a href="{f}" target="_blank" class="boton-file">
        üíæ¬†Descargar archivo "level-{nivel}.csv" original
      </a>
    </p>
    \n\n'))
    
  } else {
    # Mensaje de advertencia si no existe el archivo
    cat(glue::glue('
    <p style="color:red;">
      ‚ö†Ô∏è El archivo "level-{nivel}.csv" no se encontr√≥ en la ruta especificada: {f}
    </p>
    '))
  }
  
}
```

<p>
  Con esto, se proporciona tanto la exploraci√≥n visual interactiva de la composici√≥n taxon√≥mica como la posibilidad de inspeccionar los datos de forma tabular para an√°lisis posteriores en R o Python. Este enfoque permite combinar la claridad de la visualizaci√≥n de QIIME2 con la flexibilidad de trabajar con los datos en el informe.
</p>








<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo3" id="tab3-seccion4.1.3" style="font-size: 28px; margin-top: 67px; margin-bottom: 13px;">
  4.1.3. Archivos exportados por niveles taxon√≥micos
</div>

```{r}
# Rutas de los archivos a leer
ruta_feature_table_l5_export_tsv <- file.path(ruta_exported, "feature-table_l5_export.tsv")
ruta_feature_table_l5_export_tsv_relativa <- file.path(ruta_exported_relativa, "feature-table_l5_export.tsv")

ruta_feature_table_l6_export_tsv <- file.path(ruta_exported, "feature-table_l6_export.tsv")
ruta_feature_table_l5_export_tsv_relativa <- file.path(ruta_exported_relativa, "feature-table_l5_export.tsv")

ruta_feature_table_l7_export_tsv <- file.path(ruta_exported, "feature-table_l7_export.tsv")
ruta_feature_table_l7_export_tsv_relativa <- file.path(ruta_exported_relativa, "feature-table_l7_export.tsv")
```

<p>
  Tras generar los gr√°ficos de barras interactivos con <code>taxa-bar-plots.qzv</code>, QIIME2 permite <strong>exportar las tablas subyacentes de abundancia relativa</strong> en formato de texto. 
  Estos archivos contienen la distribuci√≥n de cada tax√≥n en todas las muestras y est√°n organizados por niveles taxon√≥micos jer√°rquicos, desde <strong>nivel 1</strong> hasta <strong>nivel 7</strong>. 
  Los niveles m√°s informativos y utilizados para interpretaci√≥n biol√≥gica suelen ser: <em>familia (L5)</em>, <em>g√©nero (L6)</em> y <em>especie (L7)</em>.
</p>

<p>
  En este informe nos centramos en los tres niveles principales de detalle:
</p>

<ul>
  <li>
    <code>feature-table_l5_export.tsv</code> ‚Üí abundancia relativa a nivel de <strong>familia</strong>, ofreciendo una visi√≥n intermedia de la comunidad microbiana.
  </li>
  <li>
    <code>feature-table_l6_export.tsv</code> ‚Üí abundancia relativa a nivel de <strong>g√©nero</strong>, proporcionando una resoluci√≥n m√°s fina √∫til para interpretaciones biol√≥gicas y an√°lisis de diversidad diferencial.
  </li>
  <li>
    <code>feature-table_l7_export.tsv</code> ‚Üí abundancia relativa a nivel de <strong>especie</strong>, permitiendo un an√°lisis detallado y preciso de la composici√≥n microbiana, ideal para estudios que requieren la m√°xima resoluci√≥n taxon√≥mica.
  </li>
</ul>

<p>
  Estos archivos resultan especialmente √∫tiles para an√°lisis posteriores, como la detecci√≥n de <em>diferencias de abundancia</em> entre condiciones experimentales o la creaci√≥n de visualizaciones personalizadas en <code>R</code> o <code>Python</code>. 
  A continuaci√≥n se mostrar√°n su ubicaci√≥n en el proyecto, su previsualizaci√≥n mediante tablas interactivas y la opci√≥n de descarga directa, facilitando as√≠ la exploraci√≥n y el an√°lisis detallado de los datos.
</p>

```{r, results="asis"}
if (file.exists(ruta_feature_table_l5_export_tsv)) {
  cat(glue::glue('
<code>{ruta_feature_table_l5_export_tsv}</code>
\n\n'))
} else {
  cat(glue::glue('
  <div class="alert-box">
    ‚ö†Ô∏è El archivo <code>feature-table_l5_export.tsv</code> no existe en la ruta especificada: 
    <code>{ruta_feature_table_l5_export_tsv}</code>
  </div>
\n\n'))
}
```

```{r, results="asis"}
if (file.exists(ruta_feature_table_l6_export_tsv)) {
  cat(glue::glue('
<code>{ruta_feature_table_l6_export_tsv}</code>
\n\n'))
} else {
  cat(glue::glue('
  <div class="alert-box">
    ‚ö†Ô∏è El archivo <code>feature-table_l6_export.tsv</code> no existe en la ruta especificada: 
    <code>{ruta_feature_table_l6_export_tsv}</code>
  </div>
\n\n'))
}
```

```{r, results="asis"}
if (file.exists(ruta_feature_table_l7_export_tsv)) {
  cat(glue::glue('
<code>{ruta_feature_table_l7_export_tsv}</code>
\n\n'))
} else {
  cat(glue::glue('
  <div class="alert-box">
    ‚ö†Ô∏è El archivo <code>feature-table_l7_export.tsv</code> no existe en la ruta especificada: 
    <code>{ruta_feature_table_l7_export_tsv}</code>
  </div>
\n\n'))
}
```






<div style="height: 13px; background-color: transparent;"></div>

<div class="titulo4" id="tab3-seccion4.1.3.1" style="margin-bottom: 10px;">
  4.1.3.1. Tabla de abundancia relativa a nivel taxon√≥mico: <strong>Familia (L5)</strong>
</div>

<p>
  En este nivel taxon√≥mico, los resultados se agrupan por <strong>familia</strong>, lo que representa un punto intermedio en la jerarqu√≠a taxon√≥mica entre √≥rdenes y g√©neros. 
  La tabla de abundancia relativa muestra la proporci√≥n de cada familia en las distintas muestras analizadas. 
  Este nivel resulta especialmente √∫til para obtener una visi√≥n global de la diversidad microbiana sin descender todav√≠a a un nivel de detalle excesivo.
</p>

<p>
  Gracias a esta resoluci√≥n intermedia, se pueden identificar las familias dominantes en la comunidad microbiana y establecer comparaciones entre muestras o condiciones experimentales. 
  Asimismo, permite detectar patrones de variaci√≥n relevantes que podr√≠an pasar desapercibidos a un nivel taxon√≥mico m√°s alto (como el filo) o que ser√≠an demasiado espec√≠ficos a nivel de g√©nero o especie.
</p>

```{r}
# Leer el archivo y mostrar tabla interactiva
if (file.exists(ruta_feature_table_l5_export_tsv)) {
  library(readr)
  table <- read_tsv(ruta_feature_table_l5_export_tsv, comment = "#", show_col_types = FALSE)

  # Tabla interactiva
  library(DT)
  library(htmltools)
  htmltools::div(
    class = "scroll-y-max-500",
    DT::datatable(
      table,
      options = list(
        scrollX = TRUE,
        paging = FALSE,
        lengthChange = FALSE,
        language = list(
          url = '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
        )
      ),
      class = 'stripe hover compact'
    )
  )
  
} else {
  cat(glue::glue('
  cat("Archivo "{ruta_feature_table_l5_export_tsv}" no encontrado. Verifica la ruta.")
  \n\n'))
}
```

```{r, results='asis'}
if (file.exists(ruta_feature_table_l5_export_tsv)) {

  cat(glue::glue('
  <div style="height: 13px; background-color: transparent;"></div>

  <p style="text-align:center;">
    <a href="{ruta_feature_table_l5_export_tsv}" target="_blank" class="boton-file">
      üíæ¬†Descargar archivo "feature-table_l5_export.tsv" original
    </a>
  </p>
  \n\n'))
}
```






<div style="height: 13px; background-color: transparent;"></div>

<div class="titulo4" id="tab3-seccion4.1.3.2" style="margin-bottom: 10px;">
  4.1.3.2. Tabla de abundancia relativa a nivel taxon√≥mico: <strong>G√©nero (L6)</strong>
</div>

<p>
  En este nivel taxon√≥mico, los resultados alcanzan una resoluci√≥n m√°s <strong>precisa</strong>, ya que se agrupan las secuencias en funci√≥n de su asignaci√≥n a un <strong>g√©nero microbiano</strong>. 
  Este nivel de detalle es de gran relevancia biol√≥gica, pues facilita la interpretaci√≥n de los resultados en t√©rminos de posibles funciones ecol√≥gicas, asociaciones con condiciones ambientales o incluso con estados de salud/enfermedad en estudios cl√≠nicos.
</p>

<p>
  Es habitual que los an√°lisis de <strong>diversidad diferencial</strong> se enfoquen en este nivel, ya que permite identificar con claridad qu√© g√©neros aumentan o disminuyen significativamente entre grupos de estudio. 
  Por tanto, las tablas de abundancia a nivel de g√©nero constituyen una herramienta clave para la interpretaci√≥n biol√≥gica de los resultados.
</p>

```{r}
# Leer el archivo y mostrar tabla interactiva
if (file.exists(ruta_feature_table_l6_export_tsv)) {
  library(readr)
  table <- read_tsv(ruta_feature_table_l6_export_tsv, comment = "#", show_col_types = FALSE)

  # Tabla interactiva
  library(DT)
  library(htmltools)
  htmltools::div(
    class = "scroll-y-max-500",
    DT::datatable(
      table,
      options = list(
        scrollX = TRUE,
        paging = FALSE,
        lengthChange = FALSE,
        language = list(
          url = '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
        )
      ),
      class = 'stripe hover compact'
    )
  )
  
} else {
  cat(glue::glue('
  cat("Archivo "{ruta_feature_table_l6_export_tsv}" no encontrado. Verifica la ruta.")
  \n\n'))
}
```

```{r, results='asis'}
if (file.exists(ruta_feature_table_l6_export_tsv)) {

  cat(glue::glue('
  <div style="height: 13px; background-color: transparent;"></div>

  <p style="text-align:center;">
    <a href="{ruta_feature_table_l6_export_tsv}" target="_blank" class="boton-file">
      üíæ¬†Descargar archivo "feature-table_l6_export.tsv" original
    </a>
  </p>
  \n\n'))
}
```

<p>
  Una vez exploradas las abundancias relativas por niveles taxon√≥micos, el siguiente paso consiste en la <strong>construcci√≥n del √°rbol filogen√©tico</strong>. 
  Este permitir√° representar las relaciones evolutivas entre las secuencias y servir√° de base para los an√°lisis de diversidad filogen√©tica.
</p>






<div style="height: 13px; background-color: transparent;"></div>

<div class="titulo4" id="tab3-seccion4.1.3.3" style="margin-bottom: 10px;">
  4.1.3.3. Tabla de abundancia relativa a nivel taxon√≥mico: <strong>Especie (L7)</strong>
</div>

<p>
  En este nivel taxon√≥mico, los resultados alcanzan la m√°xima resoluci√≥n disponible, agrupando las secuencias seg√∫n su asignaci√≥n a una <strong>especie microbiana</strong>. 
  La tabla de abundancia relativa muestra la proporci√≥n de cada especie en las diferentes muestras analizadas, proporcionando informaci√≥n detallada sobre la composici√≥n espec√≠fica de la comunidad.
</p>

<p>
  Este nivel es especialmente √∫til para estudios que requieren un an√°lisis fino de la microbiota, como la identificaci√≥n de especies dominantes o de aquellas que podr√≠an estar asociadas a condiciones ambientales, cl√≠nicas o ecol√≥gicas concretas. 
  Tambi√©n permite detectar variaciones sutiles entre muestras que podr√≠an pasar desapercibidas en niveles taxon√≥micos superiores como familia o g√©nero.
</p>

```{r}
# Leer el archivo y mostrar tabla interactiva
if (file.exists(ruta_feature_table_l7_export_tsv)) {
  library(readr)
  table <- read_tsv(ruta_feature_table_l7_export_tsv, comment = "#", show_col_types = FALSE)

  # Tabla interactiva
  library(DT)
  library(htmltools)
  htmltools::div(
    class = "scroll-y-max-500",
    DT::datatable(
      table,
      options = list(
        scrollX = TRUE,
        paging = FALSE,
        lengthChange = FALSE,
        language = list(
          url = '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
        )
      ),
      class = 'stripe hover compact'
    )
  )
  
} else {
  cat(glue::glue('
  cat("Archivo "{ruta_feature_table_l7_export_tsv}" no encontrado. Verifica la ruta.")
  \n\n'))
}
```

```{r, results='asis'}
if (file.exists(ruta_feature_table_l7_export_tsv)) {

  cat(glue::glue('
  <div style="height: 13px; background-color: transparent;"></div>

  <p style="text-align:center;">
    <a href="{ruta_feature_table_l7_export_tsv}" target="_blank" class="boton-file">
      üíæ¬†Descargar archivo "feature-table_l7_export.tsv" original
    </a>
  </p>
  \n\n'))
}
```

<p>
  Con la exploraci√≥n de las abundancias relativas completada hasta el nivel de especie (L7), el siguiente paso en el an√°lisis ser√° la <strong>construcci√≥n del √°rbol filogen√©tico</strong>. 
  Este √°rbol permitir√° representar las relaciones evolutivas entre las ASVs y servir√° de base para los c√°lculos de diversidad filogen√©tica en las secciones siguientes.
</p>










<div style="height: 20px; background-color: transparent;"></div>

<div class="titulo2" id="tab3-seccion4.2" style="font-size: 30px; margin-top: 80px; margin-bottom: 13px;">
  4.2. Construcci√≥n del √°rbol filogen√©tico
</div>

<p>
  Tras completar la <strong>asignaci√≥n taxon√≥mica</strong> (Secci√≥n 4.1), donde se caracteriz√≥ la composici√≥n microbiana a distintos niveles jer√°rquicos (<em>familia</em>, <em>g√©nero</em>, etc.), el siguiente paso consiste en la <strong>construcci√≥n de un √°rbol filogen√©tico</strong> a partir de las <em>ASVs representativas</em>. 
</p>

<p>
  La finalidad de este √°rbol no es realizar una interpretaci√≥n exhaustiva de las relaciones evolutivas entre los taxones detectados, sino establecer una <strong>estructura filogen√©tica de referencia</strong> que conecte a las secuencias obtenidas. 
  Este insumo es crucial porque permite aplicar <strong>m√©tricas de diversidad</strong> que no se limitan a contar taxones, sino que incorporan la informaci√≥n filogen√©tica contenida en la longitud y disposici√≥n de las ramas.
</p>

<p>
  Entre las m√©tricas m√°s empleadas que dependen directamente de este √°rbol se encuentran:
</p>

<ul>
  <li>
    <strong>Faith‚Äôs Phylogenetic Diversity (PD):</strong> cuantifica la diversidad de una comunidad como la suma de las longitudes de las ramas necesarias para conectar todas las ASVs presentes. 
    De este modo, integra tanto la riqueza (n√∫mero de taxones) como su <em>profundidad evolutiva</em>.
  </li>
  <li>
    <strong>UniFrac (ponderado y no ponderado):</strong> mide la distancia entre comunidades comparando sus ASVs en el contexto del √°rbol. 
    La versi√≥n <em>no ponderada</em> se basa √∫nicamente en la presencia o ausencia de taxones compartidos, mientras que la <em>ponderada</em> tambi√©n incorpora sus abundancias relativas, ofreciendo una visi√≥n m√°s completa de las diferencias entre comunidades.
  </li>
</ul>

<p>
  En definitiva, la construcci√≥n del √°rbol filogen√©tico constituye un <strong>paso metodol√≥gico esencial</strong> y preparatorio, cuya utilidad principal es habilitar m√©tricas de diversidad filogen√©tica robustas que se desarrollar√°n en las siguientes secciones. 
  Gracias a ello, el an√°lisis de la microbiota no solo contempla la abundancia y presencia de taxones, sino que tambi√©n integra informaci√≥n sobre su proximidad evolutiva.
</p>

<p>
  Para facilitar la comprensi√≥n, a continuaci√≥n se detallan los <strong>archivos principales</strong> generados en este proceso (Subsecci√≥n 4.2.2), as√≠ como una breve comparaci√≥n entre los <strong>√°rboles sin ra√≠z y enraizados</strong> (Subsecci√≥n 4.2.3), que permitir√° entender su papel en los an√°lisis posteriores.
</p>








<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo3" id="tab3-seccion4.2.1" style="font-size: 28px; margin-top: 67px; margin-bottom: 13px;">
  4.2.1. Archivos principales
</div>

```{r}
# Rutas de los archivos
ruta_aligned_rep_seqs_qza <- file.path(ruta_Def, "aligned-rep-seqs.qza")
ruta_aligned_rep_seqs_qza_relativa <- file.path(ruta_Def, "aligned-rep-seqs.qza")

ruta_unrooted_tree_qza <- file.path(ruta_Def, "unrooted-tree.qza")
ruta_unrooted_tree_qza_relativa <- file.path(ruta_Def, "unrooted-tree.qza")

ruta_rooted_tree_qza <- file.path(ruta_Def, "rooted-tree.qza")
ruta_rooted_tree_qza_relativa <- file.path(ruta_Def, "rooted-tree.qza")
```

```{r}
# Definir ruta del archivo .qzv
ruta_unrooted_tree_qzv_relativa <- file.path(ruta_Def_relativa, "unrooted-tree.qzv")
ruta_unrooted_tree_qzv <- file.path(ruta_Def, "unrooted-tree.qzv")

# Definir ruta de salida para el unzip
ruta_Def_unzip <- file.path(ruta_Def_relativa, "unzip")
ruta_unzip_unrooted_tree <- file.path(ruta_Def_unzip, "unrooted-tree")

# Crear carpeta de salida si no existe
if (!dir.exists(ruta_Def_unzip)) dir.create(ruta_Def_unzip, recursive = TRUE)

# Solo hacer unzip si el archivo existe
if (file.exists(ruta_unrooted_tree_qzv_relativa)) {
  # Usando system2 para llamar a unzip desde R
  system2("unzip", args = c("-o", shQuote(ruta_unrooted_tree_qzv_relativa),
                            "-d", shQuote(ruta_unzip_unrooted_tree)))
} else {
  message("‚ö†Ô∏è El archivo taxa-bar-plots.qzv no existe. Se omite el unzip.")
}
```

```{r}
# Comprobar que el unzip se ha realizado
if (dir.exists(ruta_unzip_unrooted_tree)) {
  
  # Listar subcarpetas dentro de la carpeta unzip (solo 1er nivel)
  subcarpetas <- list.dirs(ruta_unzip_unrooted_tree, recursive = FALSE, full.names = TRUE)
  
  if (length(subcarpetas) == 0) {
    stop("No se encontr√≥ ninguna subcarpeta dentro de ", ruta_unzip_unrooted_tree)
  }
  
  # Tomamos la primera subcarpeta (la aleatoria generada por QIIME2)
  carpeta_random <- subcarpetas[1]
  
  # Archivos dentro de 'data'
  ruta_unrooted_index_html <- file.path(ruta_data, "index.html")
  
  # Comprobar que existen
  if (!file.exists(ruta_unrooted_index_html)) message("‚ö†Ô∏è index.html no encontrado")
  
} else {
  message("‚ö†Ô∏è Carpeta de unzip no encontrada. No se puede acceder a los archivos.")
}
```

```{r}
# Definir ruta del archivo .qzv
ruta_rooted_tree_qzv_relativa <- file.path(ruta_Def_relativa, "rooted-tree.qzv")
ruta_rooted_tree_qzv <- file.path(ruta_Def, "rooted-tree.qzv")

# Definir ruta de salida para el unzip
ruta_Def_unzip <- file.path(ruta_Def_relativa, "unzip")
ruta_unzip_rooted_tree <- file.path(ruta_Def_unzip, "rooted-tree")

# Crear carpeta de salida si no existe
if (!dir.exists(ruta_Def_unzip)) dir.create(ruta_Def_unzip, recursive = TRUE)

# Solo hacer unzip si el archivo existe
if (file.exists(ruta_rooted_tree_qzv_relativa)) {
  # Usando system2 para llamar a unzip desde R
  system2("unzip", args = c("-o", shQuote(ruta_rooted_tree_qzv_relativa),
                            "-d", shQuote(ruta_unzip_rooted_tree)))
} else {
  message("‚ö†Ô∏è El archivo taxa-bar-plots.qzv no existe. Se omite el unzip.")
}
```

```{r}
# Comprobar que el unzip se ha realizado
if (dir.exists(ruta_unzip_rooted_tree)) {
  
  # Listar subcarpetas dentro de la carpeta unzip (solo 1er nivel)
  subcarpetas <- list.dirs(ruta_unzip_rooted_tree, recursive = FALSE, full.names = TRUE)
  
  if (length(subcarpetas) == 0) {
    stop("No se encontr√≥ ninguna subcarpeta dentro de ", ruta_unzip_rooted_tree)
  }
  
  # Tomamos la primera subcarpeta (la aleatoria generada por QIIME2)
  carpeta_random <- subcarpetas[1]
  
  # Archivos dentro de 'data'
  ruta_rooted_index_html <- file.path(ruta_data, "index.html")
  
  # Comprobar que existen
  if (!file.exists(ruta_rooted_index_html)) message("‚ö†Ô∏è index.html no encontrado")
  
} else {
  message("‚ö†Ô∏è Carpeta de unzip no encontrada. No se puede acceder a los archivos.")
}
```

<p>
  En esta etapa del an√°lisis se generan una serie de archivos fundamentales que permiten disponer de la informaci√≥n necesaria para la construcci√≥n del √°rbol filogen√©tico. 
  Cada uno de ellos aporta un insumo clave dentro del flujo de trabajo:
</p>

<ul>
  <li>
    <code>aligned-rep-seqs.qza</code>: archivo que contiene el <strong>alineamiento m√∫ltiple</strong> de las ASVs representativas, en el que las secuencias se comparan posici√≥n por posici√≥n.
  </li>
  <li>
    <code>unrooted-tree.qza</code>: almacena el <strong>√°rbol filogen√©tico sin ra√≠z</strong>, representaci√≥n inicial de las relaciones entre ASVs sin asumir un ancestro com√∫n.
  </li>
  <li>
    <code>rooted-tree.qza</code>: versi√≥n <strong>enraizada del √°rbol filogen√©tico</strong>, necesaria para el c√°lculo de m√©tricas filogen√©ticas ya que establece un punto de origen definido.
  </li>
  <li>
    <code>unrooted-tree.qzv</code> y <code>rooted-tree.qzv</code>: archivos de <strong>visualizaci√≥n interactiva</strong> que permiten explorar los √°rboles de forma gr√°fica a trav√©s del visor de QIIME2 o directamente integrados en este informe.
  </li>
</ul>

<p>
  Dichos archivos se encuentran en los siguientes directorios:
</p>

```{r, results="asis"}
if (file.exists(ruta_aligned_rep_seqs_qza)) {
  cat(glue::glue('
<code>{ruta_aligned_rep_seqs_qza}</code>
\n\n'))

} else {
  cat(glue::glue('
  <div class="alert-box">
    ‚ö†Ô∏è <b>Advertencia:</b> El archivo <code>aligned-rep-seqs.qza</code> no existe en la ruta especificada. <br><br>
    <code>{ruta_aligned_rep_seqs_qza}</code>
  </div>
  \n\n'))
}
```

```{r, results="asis"}
if (file.exists(ruta_unrooted_tree_qza)) {
  cat(glue::glue('
<code>{ruta_unrooted_tree_qza}</code>
\n\n'))

} else {
  cat(glue::glue('
  <div class="alert-box">
    ‚ö†Ô∏è <b>Advertencia:</b> El archivo <code>unrooted-tree.qza</code> no existe en la ruta especificada. <br><br>
    <code>{ruta_unrooted_tree_qza}</code>
  </div>
  \n\n'))
}
```

```{r, results="asis"}
if (file.exists(ruta_unrooted_tree_qzv)) {
  cat(glue::glue('
<code>{ruta_unrooted_tree_qzv}</code>
\n\n'))

} else {
  cat(glue::glue('
  <div class="alert-box">
    ‚ö†Ô∏è <b>Advertencia:</b> El archivo <code>unrooted-tree.qzv</code> no existe en la ruta especificada. <br><br>
    <code>{ruta_unrooted_tree_qzv}</code>
  </div>
  \n\n'))
}
```

```{r, results="asis"}
if (file.exists(ruta_rooted_tree_qza)) {
  cat(glue::glue('
<code>{ruta_rooted_tree_qza}</code>
\n\n'))

} else {
  cat(glue::glue('
  <div class="alert-box">
    ‚ö†Ô∏è <b>Advertencia:</b> El archivo <code>rooted-tree.qza</code> no existe en la ruta especificada. <br><br>
    <code>{ruta_rooted_tree_qza}</code>
  </div>
  \n\n'))
}
```

```{r, results="asis"}
if (file.exists(ruta_rooted_tree_qzv)) {
  cat(glue::glue('
<code>{ruta_rooted_tree_qzv}</code>
\n\n'))

} else {
  cat(glue::glue('
  <div class="alert-box">
    ‚ö†Ô∏è <b>Advertencia:</b> El archivo <code>rooted-tree.qzv</code> no existe en la ruta especificada. <br><br>
    <code>{ruta_rooted_tree_qzv}</code>
  </div>
  \n\n'))
}
```

<p>
  Una vez identificados estos archivos, en la siguiente subsecci√≥n (<strong>4.2.3 Diferencias entre √°rboles</strong>) se abordar√° la 
  <em>distinci√≥n conceptual y visual</em> entre el √°rbol sin ra√≠z y el √°rbol enraizado, incorporando adem√°s los <code>index.html</code> obtenidos 
  a partir de los archivos <code>.qzv</code> para su exploraci√≥n interactiva.
</p>








<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo3" id="tab3-seccion4.2.2" style="font-size: 28px; margin-top: 67px; margin-bottom: 13px;">
  4.2.2. Diferencias entre √°rboles
</div>

<p>
  Una vez generados los archivos principales, el siguiente paso consiste en comprender las diferencias entre las dos representaciones del √°rbol filogen√©tico obtenidas en QIIME2. 
  Aunque ambos parten de las <em>ASVs representativas</em>, la forma en que se estructuran tiene implicaciones directas en el uso que se les dar√° en los an√°lisis posteriores.
</p>






<div style="height: 13px; background-color: transparent;"></div>

<div class="titulo4" id="tab3-seccion4.2.2.1" style="margin-bottom: 10px;">
  4.2.2.1. √Årbol sin ra√≠z (<code>unrooted-tree</code>)
</div>

<p>
  El <strong>√°rbol sin ra√≠z</strong> representa las relaciones filogen√©ticas entre las <em>ASVs representativas</em> sin asumir un ancestro com√∫n en un punto espec√≠fico del √°rbol. 
  Este tipo de representaci√≥n es especialmente √∫til en las fases iniciales del an√°lisis filogen√©tico, ya que permite observar c√≥mo se agrupan las secuencias seg√∫n su similitud, sin imponer una direcci√≥n evolutiva concreta.
</p>

<p>
  La principal utilidad de este √°rbol es servir como <strong>base intermedia</strong> antes de generar un √°rbol enraizado. 
  Proporciona una visi√≥n general de la estructura filogen√©tica de las ASVs, lo que resulta esencial para posteriores c√°lculos de m√©tricas de diversidad que requieren un √°rbol con ra√≠z.
</p>

<p>
  A continuaci√≥n se muestra el √°rbol sin ra√≠z de manera interactiva mediante un <strong>iframe</strong>, generado al descomprimir el archivo <code>unrooted-tree.qzv</code> en la carpeta correspondiente. 
  Esto permite explorar la estructura del √°rbol directamente en el informe, con la posibilidad de abrirlo en una nueva pesta√±a para una visualizaci√≥n m√°s detallada.
</p>

```{r, results='asis'}
# Generar iframe para Quarto si existe index.html
if (file.exists(ruta_unzip_unrooted_tree)) {

  cat(glue::glue('
  <iframe src="{ruta_unrooted_index_html}" width="100%" height="700px" style="border: 1px solid #ccc; border-radius: 6px;"></iframe>

  <p style="text-align:center;">
    <a href="{ruta_unrooted_index_html}" target="_blank" class="boton-iframe">
      üîç Ver matriz normalizada en una nueva p√°gina
    </a>
  </p>

  <div style="height: 15px; background-color: transparent;"></div>
  \n\n'))

} else {

  cat(glue::glue('
  <div class="alert-box">
    ‚ùå <span style="font-size:18px;">El √°rbol sin ra√≠z no est√° disponible</span><br>
    <span style="font-size:14px; font-weight:normal;">
      No se encontr√≥ el archivo <code>index.html</code> correspondiente. <br>
      Aseg√∫rese de haber generado y descomprimido el archivo <code>unrooted-tree.qzv</code>.
    </span>
  </div>
  \n\n'))
}
```






<div style="height: 13px; background-color: transparent;"></div>

<div class="titulo4" id="tab3-seccion4.2.2.2" style="margin-bottom: 10px;">
  4.2.2.2. √Årbol enraizado (<code>rooted-tree</code>)
</div>

<p>
  Despu√©s de explorar el <strong>√°rbol sin ra√≠z</strong>, el siguiente paso consiste en analizar el <strong>√°rbol enraizado</strong>, que incorpora un <em>punto de origen (ra√≠z)</em>. 
  La ra√≠z otorga un sentido direccional a las ramas, lo que es crucial para interpretar las distancias filogen√©ticas entre las ASVs y las comunidades microbianas.
</p>

<p>
  Esta estructura es indispensable para el c√°lculo de m√©tricas filogen√©ticas como <strong>Faith‚Äôs Phylogenetic Diversity (PD)</strong> y <strong>UniFrac</strong>, ya que la ra√≠z permite cuantificar de manera coherente la longitud de las ramas y la conexi√≥n evolutiva entre secuencias. 
  En otras palabras, el √°rbol enraizado no solo refleja las relaciones entre ASVs, sino que tambi√©n habilita comparaciones cuantitativas precisas entre muestras.
</p>

<p>
  A continuaci√≥n se muestra el √°rbol enraizado de manera interactiva mediante un <strong>iframe</strong>, generado a partir del archivo <code>rooted-tree.qzv</code> previamente descomprimido. 
  Esto permite explorar la estructura del √°rbol directamente en el informe y abrirlo en una nueva pesta√±a para un an√°lisis m√°s detallado.
</p>

```{r, results='asis'}
# Generar iframe para Quarto si existe index.html
if (file.exists(ruta_unzip_rooted_tree)) {

  cat(glue::glue('
  <iframe src="{ruta_rooted_index_html}" width="100%" height="700px" style="border: 1px solid #ccc; border-radius: 6px;"></iframe>

  <p style="text-align:center;">
    <a href="{ruta_rooted_index_html}" target="_blank" class="boton-iframe">
      üîç Ver matriz normalizada en una nueva p√°gina
    </a>
  </p>

  <div style="height: 15px; background-color: transparent;"></div>
  \n\n'))

} else {

  cat(glue::glue('
  <div class="alert-box">
    ‚ùå <span style="font-size:18px;">El √°rbol enraizado no est√° disponible</span><br>
    <span style="font-size:14px; font-weight:normal;">
      No se encontr√≥ el archivo <code>index.html</code> correspondiente. <br>
      Aseg√∫rese de haber generado y descomprimido el archivo <code>rooted-tree.qzv</code>.
    </span>
  </div>
  \n\n'))
}
```

<p>
  Tras visualizar y comparar ambos √°rboles, la √∫ltima subsecci√≥n (<strong>4.2.4 Relaci√≥n con an√°lisis posteriores</strong>) 
  se centrar√° en explicar c√≥mo estos archivos se integran en los c√°lculos de m√©tricas de diversidad, preparando as√≠ el terreno para los an√°lisis de la Secci√≥n 5.
</p>
