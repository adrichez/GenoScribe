---
title: "RNA-Seq Report"

include-in-header:
  text: |
    <link rel="shortcut icon" href="../../../1-images/0-icono/favicon.svg"/>
    <link rel="icon" type="image/x-icon" href="../../../1-images/0-icono/favicon.ico">

params:
  ruta_proyecto: ""
  nombre_experimento: ""
---


<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->
<!--  TAB 3: AN츼LISIS | 3. ALINEAMIENTO DE LAS LECTURAS AL GENOMA DE REFERENCIA -->
<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->

```{r}
library(glue)
library(fs)
library(stringr)
library(dplyr)

# Definir rutas clave
ruta_qmd <- getwd()

ruta_rnaseq_pipeline <- sub("(.*?/1-bulk-rna-seq).*", "\\1", ruta_qmd)

nombre_proyecto <- basename(params$ruta_proyecto)

ruta_nextflow_results <- file.path("..", "..", "..", "..", "..", "resources", "2-nextflow-results")
ruta_proyecto_relativa <- file.path("..", "..", "..", "..", "..", "resources", "2-nextflow-results", "1-project-data", nombre_proyecto)

ruta_hisat2_index <- file.path(params$ruta_proyecto, "Analisis", params$nombre_experimento, "hisat2_index")
ruta_hisat2_index_relativa <- file.path(ruta_proyecto_relativa, "Analisis", params$nombre_experimento, "hisat2_index")

ruta_hisat2_results <- file.path(params$ruta_proyecto, "Analisis", params$nombre_experimento, "hisat2_results")
ruta_hisat2_results_relativa <- file.path(ruta_proyecto_relativa, "Analisis", params$nombre_experimento, "hisat2_results")
```


<div class="informe-titulo-tab">
  <h1>Pesta침a 2</h1>
  <h2>An치lisis bioinform치tico completo</h2>
</div>

<div class="informe-titulo-seccion">
  <h1>Secci칩n 3</h1>
  <h2>Alineamiento de las lecturas contra el genoma de referencia</h2>
</div>


<div class="informe-resumen">
  <h2>Resumen</h2>

  <p>
    Esta secci칩n describe el proceso de alineamiento de las secuencias de ARN ya preprocesadas al genoma de referencia, un paso crucial para poder cuantificar la expresi칩n g칠nica de forma precisa y contextualizada. El objetivo principal es determinar la ubicaci칩n exacta de cada lectura en el genoma, permitiendo as칤 inferir qu칠 genes est치n activos en cada muestra.
  </p>

  <p>
    En primer lugar, se gener칩 el 칤ndice del genoma de referencia utilizando la herramienta <code>hisat2-build</code>. Este 칤ndice es esencial para optimizar el rendimiento del alineamiento, ya que permite a la herramienta <code>HISAT2</code> buscar de forma eficiente coincidencias entre las lecturas y el genoma.
  </p>

  <p>
    A continuaci칩n, se realiz칩 el alineamiento de las lecturas limpias contra el genoma indexado mediante <code>HISAT2</code>, obteni칠ndose como resultado principal archivos <code>.bam</code> por muestra, los cuales contienen las lecturas mapeadas y ordenadas. Junto a ellos, se generaron los correspondientes archivos de 칤ndice <code>.bai</code> para facilitar su visualizaci칩n y manipulaci칩n, as칤 como archivos <code>.metrics</code> que resumen las estad칤sticas de alineamiento.
  </p>

  <p>
    Adem치s, se conservaron los archivos <code>.fastq.gz</code> que contienen aquellas lecturas que no pudieron ser alineadas al genoma, lo que puede resultar 칰til para estudios posteriores como la b칰squeda de elementos novedosos o el an치lisis de contaminantes.
  </p>

  <p>
    Este conjunto de resultados sienta las bases para la siguiente etapa del an치lisis: la cuantificaci칩n de la expresi칩n g칠nica a partir de los alineamientos obtenidos.
  </p>
</div>










<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo-toc">
  Tabla de contenidos de esta secci칩n
</div>

<div class="toc">
  <ul>
    <li>
      <a href="#tab3-seccion3">
        3<span>.</span> Alineamiento de las lecturas contra el genoma de referencia
      </a>
      <ul>
        <li>
          <a href="#tab3-seccion3.1">
            3.1. Preparaci칩n del 칤ndice del genoma de referencia
          </a>
        </li>
        <li>
          <a href="#tab3-seccion3.2">
            3.2. Alineamiento de lecturas contra el genoma indexado
          </a>
        </li>
      </ul>
    </li>
  </ul>
</div>










<!-- #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->
<!-- REDACCI칍N -->
<!-- #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->

<div style="height: 25px; background-color: transparent;"></div>

<div class="titulo1" id="tab3-seccion3">
  3<span>.</span> Alineamiento de las lecturas contra el genoma de referencia
</div>

<p>
  Tras verificar la calidad de las lecturas mediante los an치lisis anteriores, el siguiente paso esencial en el flujo de trabajo de RNA-Seq es el alineamiento de dichas lecturas contra un genoma de referencia. Este proceso permite asignar cada secuencia a una posici칩n espec칤fica del genoma, lo cual es imprescindible para interpretar correctamente la expresi칩n g칠nica y obtener resultados biol칩gicamente significativos.
</p>

<p>
  El alineamiento es una etapa cr칤tica, ya que errores o ambig칲edades en este paso pueden repercutir directamente en la cuantificaci칩n posterior y en la detecci칩n de genes diferencialmente expresados. Para llevarlo a cabo, se ha empleado el alineador <strong>HISAT2</strong>, una herramienta ampliamente utilizada en estudios transcript칩micos por su alta precisi칩n, eficiencia computacional y capacidad para gestionar grandes vol칰menes de datos.
</p>

<p>
  <strong>HISAT2</strong> est치 especialmente dise침ado para datos de RNA-Seq y permite detectar empalmes (splicing) de manera efectiva, identificando lecturas que abarcan regiones ex칩nicas separadas por intrones. Esta caracter칤stica resulta fundamental para capturar la complejidad de la transcript칩mica en organismos eucariotas.
</p>

<p>
  En las siguientes subsecciones se detallan los pasos previos requeridos para el alineamiento, incluyendo la construcci칩n del 칤ndice del genoma de referencia y la ejecuci칩n del proceso de mapeo con HISAT2.
</p>








<div style="height: 20px; background-color: transparent;"></div>

<div class="titulo2" id="tab3-seccion3.1">
  3.1. Preparaci칩n del 칤ndice del genoma de referencia
</div>

<p>
  Para llevar a cabo el alineamiento de las lecturas, es fundamental contar con un 칤ndice del genoma de referencia previamente construido. 
  Este 칤ndice consiste en una estructura de datos optimizada que facilita la b칰squeda r치pida y eficiente de coincidencias entre las lecturas y el genoma, 
  permitiendo a <strong>HISAT2</strong> realizar alineamientos precisos incluso en regiones complejas del transcriptoma.
</p>

<p>
  En el caso de <strong>HISAT2</strong>, el 칤ndice est치 compuesto por m칰ltiples archivos con extensi칩n <code>.ht2</code>, que contienen fragmentos de esta estructura de datos. 
  Cada uno de estos archivos representa una parte del 칤ndice que juntos permiten la navegaci칩n eficiente del genoma durante el proceso de alineamiento.
</p>

<p>
  En este proyecto, el 칤ndice fue generado a partir de la secuencia gen칩mica de referencia seleccionada, y su construcci칩n representa un paso clave para garantizar un procesamiento 치gil, reproducible y eficiente.
</p>

<p>
  El 칤ndice generado, en el momento de la generaci칩n de este informe, se encuentra ubicado en la siguiente ruta dentro de la estructura del proyecto:
</p>

```{r, echo=FALSE, results="asis"}
cat(glue::glue('
<code>{ruta_hisat2_index}</code>
\n\n'))
```

<p>
  A continuaci칩n, se muestran los archivos que conforman este 칤ndice, indispensables para que <strong>HISAT2</strong> pueda realizar el alineamiento de manera efectiva:
</p>

<div class="box-files">

```{r, echo=FALSE, results="asis"}
if (!dir.exists(ruta_hisat2_index)) {
  cat(sprintf('<p><em>La ruta "%s" no existe o no es accesible.</em></p>\n', ruta_hisat2_index))
} else {
  # Listar solo archivos con extensi칩n .ht2
  files <- list.files(ruta_hisat2_index, pattern = "\\.ht2$", full.names = FALSE)
  
  if (length(files) == 0) {
    cat('<p><em>No se encontraron archivos con extensi칩n <code>.ht2</code> en la carpeta especificada.</em></p>\n')
  } else {
    enlace <- paste0("file://", ruta_hisat2_index)
    
    cat("<ul>\n")
    for (f in files) {
      # Asignar clase seg칰n la extensi칩n
      clase <- if (grepl("\\.html$", f)) {
        "file-html"
      } else if (grepl("\\.zip$", f)) {
        "file-zip"
      } else if (grepl("\\.fastq(\\..+)?\\.gz$", f)) {
        "file-fastqgz"
      } else if (grepl("\\.bam$", f)) {
        "file-bam"
      } else if (grepl("\\.bai$", f)) {
        "file-bai"
      } else if (grepl("\\.sam$", f)) {
        "file-sam"
      } else if (grepl("\\.metrics$", f)) {
        "file-metrics"
      } else if (grepl("\\.ht2$", f)) {
        "file-ht2"
      } else {
        "file-default"
      }

      cat(sprintf('<li class="%s"><a href="%s/%s" target="_blank">%s</a></li>\n', clase, enlace, f, f))
    }
    cat("</ul>\n")
  }
}
```

</div>

```{r, echo=FALSE, results="asis"}
# Para que funcione con rutas absolutas
enlace <- ruta_hisat2_index_relativa

# Imprimir el enlace
cat(glue::glue('
<p style="text-align:center;">
  <a href="{enlace}" target="_blank" class="boton-files">
    游늭 Explora los archivos de la carpeta "ruta_hisat2_index" aqu칤
  </a>
</p>

<div style="height: 15px; background-color: transparent;"></div>
\n\n'))
```








<div style="height: 20px; background-color: transparent;"></div>

<div class="titulo2" id="tab3-seccion3.2">
  3.2. Alineamiento de lecturas contra el genoma indexado
</div>

<p>
  Una vez construido el 칤ndice del genoma de referencia, se procedi칩 a realizar el alineamiento de las lecturas utilizando la herramienta <strong>HISAT2</strong>. 
  Esta etapa es fundamental en el an치lisis de expresi칩n g칠nica, ya que consiste en mapear cada una de las lecturas obtenidas del secuenciador contra el genoma de referencia, 
  determinando su ubicaci칩n exacta en el mismo. 
</p>

<p>
  El resultado de este alineamiento permite identificar con precisi칩n las regiones del genoma que han sido transcritas, 
  lo cual constituye la base para los an치lisis cuantitativos y funcionales posteriores.
</p>

<p>
  Los archivos resultantes de este proceso se encuentran almacenados, en el momento de la generaci칩n de este informe, en el siguiente directorio:
</p>

```{r, echo=FALSE, results="asis"}
cat(glue::glue('
<code>{ruta_hisat2_results}</code>
\n\n'))
```

<p>
  Para cada muestra analizada, se generan varios archivos importantes que se describen a continuaci칩n:
</p>

<ul>
  <li><code>.bam</code>: archivos que contienen las lecturas alineadas, ordenadas y preparadas para su uso en cuantificaci칩n y an치lisis posteriores.</li>
  <li><code>.bai</code>: 칤ndices asociados a los archivos BAM, que facilitan el acceso r치pido a regiones espec칤ficas dentro de estos archivos.</li>
  <li><code>.metrics</code>: archivos que resumen m칠tricas relevantes del proceso de alineamiento, tales como porcentaje de lecturas alineadas, calidad y otros indicadores de desempe침o.</li>
  <li><code>_no_aligned_fasq.1.gz</code> y <code>_no_aligned_fasq.2.gz</code>: archivos comprimidos que contienen las lecturas que no pudieron alinearse al genoma, lo que puede indicar lecturas de baja calidad, contaminaci칩n o secuencias no presentes en la referencia.</li>
</ul>

<p>
  A continuaci칩n, se presenta una lista de estos archivos para las muestras que han sido procesadas correctamente:
</p>

<div class="box-files">

```{r, echo=FALSE, results="asis"}
if (!dir.exists(ruta_hisat2_results)) {
  cat(sprintf('<p><em>La ruta "%s" no existe o no es accesible.</em></p>\n', ruta_hisat2_results))
} else {
  alignment_files <- list.files(
    ruta_hisat2_results,
    pattern = "(\\.bam$|\\.bai$|\\.metrics$|_no_aligned.fastq\\.(1|2)\\.gz$)",
    full.names = FALSE
  )
  
  if (length(alignment_files) > 0) {
    cat("<ul>\n")
    for (f in alignment_files) {
      enlace <- file.path(ruta_hisat2_results, f)
      enlace <- paste0("file://", enlace)

      # Asignar clase seg칰n la extensi칩n
      clase <- if (grepl("\\.html$", f)) {
        "file-html"
      } else if (grepl("\\.zip$", f)) {
        "file-zip"
      } else if (grepl("\\.fastq(\\..+)?\\.gz$", f)) {
        "file-fastqgz"
      } else if (grepl("\\.bam$", f)) {
        "file-bam"
      } else if (grepl("\\.bai$", f)) {
        "file-bai"
      } else if (grepl("\\.sam$", f)) {
        "file-sam"
      } else if (grepl("\\.metrics$", f)) {
        "file-metrics"
      } else if (grepl("\\.ht2$", f)) {
        "file-ht2"
      } else {
        "file-default"
      }

      cat(sprintf('<li class="%s"><a href="%s" target="_blank">%s</a></li>\n', clase, enlace, f))
    }
    cat("</ul>\n")
  } else {
    cat("<p><em>No se encontraron archivos de alineamiento en la carpeta esperada.</em></p>\n")
  }
}
```

</div>

```{r, echo=FALSE, results="asis"}
# Para que funcione con rutas absolutas
enlace <- ruta_hisat2_results_relativa

# Imprimir el enlace
cat(glue::glue('
<p style="text-align:center;">
  <a href="{enlace}" target="_blank" class="boton-files">
    游늭 Explora los archivos de la carpeta "ruta_hisat2_results" aqu칤
  </a>
</p>

<div style="height: 15px; background-color: transparent;"></div>
\n\n'))
```

<div style="height: 5px; background-color: transparent;"></div>

---

<p>
  Finalizado el alineamiento de las lecturas con el genoma de referencia, el siguiente paso del an치lisis consistir치 en la <strong>cuantificaci칩n de la expresi칩n g칠nica</strong>. 
  A lo largo de las pr칩ximas subsecciones se presentar치n los resultados derivados de esta cuantificaci칩n, incluyendo visualizaciones preliminares de los recuentos, 
  procesos de normalizaci칩n y an치lisis estad칤sticos de la expresi칩n diferencial y funcional.
</p>