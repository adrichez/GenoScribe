---
title: "RNA-Seq Report"

include-in-header:
  text: |
    <link rel="shortcut icon" href="../../../1-images/0-icono/favicon.svg"/>
    <link rel="icon" type="image/x-icon" href="../../../1-images/0-icono/favicon.ico">

params:
  ruta_proyecto: ""
  nombre_experimento: ""
---


<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->
<!--  TAB 3: ANLISIS | 4. CUANTIFICACIN DE LA EXPRESIN GENTICA -->
<!-- &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& -->

```{r}
library(glue)
library(fs)
library(stringr)
library(dplyr)

# Definir rutas clave
ruta_qmd <- getwd()

ruta_rnaseq_pipeline <- sub("(.*?/1-bulk-rna-seq).*", "\\1", ruta_qmd)

nombre_proyecto <- basename(params$ruta_proyecto)

ruta_nextflow_results <- file.path("..", "..", "..", "..", "..", "resources", "2-nextflow-results")
ruta_proyecto_relativa <- file.path("..", "..", "..", "..", "..", "resources", "2-nextflow-results", "1-project-data", nombre_proyecto)


# Construir ruta usando file.path y normalizePath
ruta_his_ReadCount <- file.path(params$ruta_proyecto, "Analisis", params$nombre_experimento, "Readcount_results", "his-ReadCount.tab")
ruta_his_ReadCount_relativa <- file.path(ruta_proyecto_relativa, "Analisis", params$nombre_experimento, "Readcount_results", "his-ReadCount.tab")


# Construir ruta usando file.path y normalizePath
ruta_his_Size <- file.path(params$ruta_proyecto, "Analisis", params$nombre_experimento, "Readcount_results", "his-Size.tab")
ruta_his_Size_relativa <- file.path(ruta_proyecto_relativa, "Analisis", params$nombre_experimento, "Readcount_results", "his-Size.tab")
```


<div class="informe-titulo-tab">
  <h1>Pesta帽a</h1>
  <h2>An谩lisis bioinform谩tico completo</h2>
</div>

<div class="informe-titulo-seccion">
  <h1>Secci贸n 4</h1>
  <h2>Cuantificaci贸n de la expresi贸n gen茅tica</h2>
</div>


<div class="informe-resumen">
  <h2>Resumen</h2>

  <p>
    En esta secci贸n se lleva a cabo la <strong>cuantificaci贸n de la expresi贸n g茅nica</strong>, un paso fundamental tras el <em>alineamiento</em> de las lecturas al genoma de referencia. 
    El objetivo principal es <strong>determinar cu谩ntas lecturas se asignan a cada gen</strong>, generando una <em>matriz de conteos</em> que representa la actividad transcripcional 
    en cada muestra analizada. Esta informaci贸n constituye la base sobre la que se desarrollar谩n los posteriores an谩lisis de <strong>expresi贸n diferencial</strong> y 
    <strong>enriquecimiento funcional</strong>.
  </p>

  <p>
    La cuantificaci贸n se ha realizado a partir de los <em>archivos de alineamiento</em> (<code>BAM</code>) generados previamente, utilizando anotaciones gen贸micas para identificar 
    las regiones correspondientes a los genes. El resultado ha sido una matriz de expresi贸n no normalizada, almacenada en el archivo <code><strong>his-ReadCount.tab</strong></code>, 
    en la que cada fila representa un gen y cada columna una muestra del experimento.
  </p>

  <p>
    Paralelamente, se ha generado el archivo <code><strong>his-Size.tab</strong></code>, que recoge la <strong>longitud de cada gen</strong> en pares de bases (bp). 
    Esta informaci贸n es crucial para realizar posteriormente una <strong>normalizaci贸n adecuada</strong> de los datos, ya que permite corregir el sesgo introducido 
    por la longitud variable de los genes.
  </p>

  <p>
    Para evaluar la calidad y estructura del conjunto de datos, se incluyen diversas <strong>visualizaciones exploratorias</strong> de los conteos brutos. 
    Entre ellas se encuentran la <em>visualizaci贸n interactiva de la matriz de conteos</em>, el <strong>an谩lisis de la longitud g茅nica</strong>, 
    y un conjunto de gr谩ficos y m茅tricas que permiten valorar la <em>distribuci贸n</em>, <em>consistencia</em> y <em>homogeneidad</em> entre las muestras.
  </p>

  <p>
    Se examinan tambi茅n indicadores clave como el <strong>total de lecturas asignadas</strong> por muestra, el <strong>n煤mero de genes expresados</strong>, 
    los <em>genes m谩s abundantemente transcritos</em>, y la <strong>distribuci贸n de los niveles de expresi贸n</strong> mediante <em>boxplots logar铆tmicos</em>. 
    Este an谩lisis preliminar permite detectar <strong>desviaciones inusuales</strong> o muestras at铆picas antes de avanzar hacia la normalizaci贸n y los an谩lisis estad铆sticos.
  </p>
</div>











<div style="height: 15px; background-color: transparent;"></div>

<div class="titulo-toc">
  Tabla de contenidos de esta secci贸n
</div>

<div class="toc">
  <ul>
    <li>
      <a href="#tab3-seccion4">
        4<span>.</span> Cuantificaci贸n de la expresi贸n gen茅tica
      </a>
      <ul>
        <li>
          <a href="#tab3-seccion4.1">
            4.1. Visualizaci贸n de la matriz de recuentos crudos
          </a>
        </li>
        <li>
          <a href="#tab3-seccion4.2">
            4.2. Visualizaci贸n de la longitud g茅nica
          </a>
        </li>
        <li>
          <a href="#tab3-seccion4.3">
            4.3. Exploraci贸n preliminar de los recuentos crudos
          </a>
          <ul>
            <li>
              <a href="#tab3-seccion4.3.1">
                4.3.1. Total de lecturas asignadas por muestra
              </a>
            </li>
            <li>
              <a href="#tab3-seccion4.3.2">
                4.3.2. N煤mero de genes expresados por muestra
              </a>
            </li>
            <li>
              <a href="#tab3-seccion4.3.3">
                4.3.3. Genes con mayor nivel de expresi贸n total
              </a>
            </li>
            <li>
              <a href="#tab3-seccion4.3.4">
                4.3.4. Distribuci贸n de recuentos por muestra (boxplot log10)
              </a>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</div>










<!-- #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->
<!-- REDACCIN -->
<!-- #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->

<div style="height: 25px; background-color: transparent;"></div>

<div class="titulo1" id="tab3-seccion4">
  4<span>.</span> Cuantificaci贸n de la expresi贸n gen茅tica
</div>

<p>
  Tras el alineamiento de las lecturas al genoma de referencia, el siguiente paso fundamental en un an谩lisis de RNA-Seq consiste en
  cuantificar la expresi贸n g茅nica. Este proceso permite determinar cu谩ntas lecturas est谩n asociadas a cada gen, proporcionando una estimaci贸n
  del nivel de actividad transcripcional en cada muestra.
</p>

<p>
  En este proyecto, la cuantificaci贸n se ha realizado mediante el recuento de lecturas alineadas a regiones g茅nicas anotadas, generando
  una matriz de expresi贸n en bruto (no normalizada). Este recuento se ha obtenido a partir de los archivos <code>SAM</code>/<code>BAM</code> generados durante el alineamiento.
</p>

<p>
  Para ello, se han producido dos archivos fundamentales:
</p>

<ul>
  <li>
    <strong><code>his-ReadCount.tab</code></strong>: contiene la matriz de conteos crudos, en la que las filas representan genes y las columnas
    corresponden a las distintas muestras del experimento. Los valores indican el n煤mero de lecturas que se alinean a cada gen en cada muestra.
  </li>
  <li>
    <strong><code>his-Size.tab</code></strong>: almacena la longitud (en pares de bases) de cada gen. Esta informaci贸n es esencial para normalizar
    los conteos de expresi贸n y poder comparar niveles de expresi贸n entre genes de distinta longitud o entre muestras con diferente profundidad de secuenciaci贸n.
  </li>
</ul>

<p>
  La combinaci贸n de estos dos archivos permite generar m茅tricas de expresi贸n normalizadas como <code>RPKM</code> o <code>TPM</code>, que ser谩n analizadas en una secci贸n posterior.
</p>








<div style="height: 20px; background-color: transparent;"></div>

<div class="titulo2" id="tab3-seccion4.1">
  4.1. Visualizaci贸n de la matriz de recuentos crudos
</div>

<p>
  A continuaci贸n, se presenta una vista interactiva de la matriz de expresi贸n g茅nica no normalizada, extra铆da del archivo <code>his-ReadCount.tab</code>. 
  Esta matriz refleja el n煤mero de lecturas alineadas a cada gen en cada una de las muestras analizadas, y constituye el punto de partida para los an谩lisis posteriores 
  de normalizaci贸n y detecci贸n de genes diferencialmente expresados.
</p>

<p>
  En la tabla mostrada a continuaci贸n, se puede <strong>buscar directamente por el identificador del gen</strong> mediante la barra de b煤squeda integrada. 
  Adem谩s, al <strong>hacer clic sobre los encabezados de las columnas</strong>, se permite ordenar los valores de forma ascendente o descendente, lo que facilita 
  la exploraci贸n detallada de los niveles de expresi贸n por muestra.
</p>

```{r}
library(DT)

# Leer el archivo y mostrar tabla interactiva
if (file.exists(ruta_his_ReadCount)) {
  his_ReadCount <- read.delim(ruta_his_ReadCount, row.names = 1)
  
  # Mostrar tabla interactiva con DT
  htmltools::div(
    class = "scroll-y-max-500",
    DT::datatable(
      his_ReadCount,
      options = list(
        scrollX = TRUE,
        paging = FALSE,
        lengthChange = FALSE,
        language = list(
          url = '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
        )
      ),
      class = 'stripe hover compact',
    )
  )

} else {
  cat("Archivo 'his-ReadCount.tab' no encontrado. Verifica la ruta.")
}
```

<div style="height: 15px; background-color: transparent;"></div>

<p>
  Si desea visualizar el archivo completo directamente, puede hacerlo desde el siguiente visor incrustado o abrirlo en una nueva pesta帽a:
</p>

```{r, echo=FALSE, results='asis'}
cat(glue::glue('
<iframe src="{ruta_his_ReadCount_relativa}" width="100%" height="500px" style="border: 1px solid #ccc; border-radius: 6px;"></iframe>

<p style="text-align:center;">
  <a href="{ruta_his_ReadCount_relativa}" target="_blank" class="boton-iframe">
     Ver matriz completa de conteos en una nueva p谩gina
  </a>
</p>
\n\n'))
```








<div style="height: 20px; background-color: transparent;"></div>

<div class="titulo2" id="tab3-seccion4.2">
  4.2. Visualizaci贸n de la longitud g茅nica
</div>

<p>
  Adem谩s de los conteos de expresi贸n, es necesario considerar la longitud de cada gen para poder aplicar m茅todos de normalizaci贸n adecuados, como <code>RPKM</code> o <code>TPM</code>. 
  La longitud g茅nica permite corregir el sesgo introducido por el hecho de que genes m谩s largos tienden a acumular m谩s lecturas simplemente por su tama帽o, 
  independientemente de su nivel real de expresi贸n.
</p>

<p>
  La informaci贸n de longitud de los genes se encuentra contenida en el archivo <code>his-Size.tab</code>, el cual proporciona la medida en pares de bases (bp) 
  de cada transcrito o gen incluido en el an谩lisis. Este archivo se ha generado utilizando las anotaciones gen贸micas correspondientes al genoma de referencia empleado 
  en la fase de alineamiento.
</p>

<p>
  A continuaci贸n, se presenta una tabla interactiva con los datos de longitud g茅nica. Esta tabla permite <strong>ordenar las longitudes de forma ascendente o descendente</strong> 
  haciendo clic sobre el encabezado de la columna, y <strong>buscar genes espec铆ficos por su identificador</strong> utilizando la barra de b煤squeda disponible. 
  Esta visualizaci贸n facilita la inspecci贸n de posibles sesgos en la distribuci贸n de longitudes que pudieran influir en los an谩lisis posteriores.
</p>

```{r}
# Leer el archivo y mostrar tabla interactiva
if (file.exists(ruta_his_Size)) {
  his_Size <- read.delim(ruta_his_Size, row.names = 1)

  # Mostrar tabla interactiva con DT
  htmltools::div(
    class = "scroll-y-max-500",
    DT::datatable(
      his_Size,
      options = list(
        scrollX = TRUE,
        paging = FALSE,
        lengthChange = FALSE,
        language = list(
          url = '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
        )
      ),
      class = 'stripe hover compact',
    )
  )

} else {
  cat("Archivo 'his-Size.tab' no encontrado. Verifica la ruta.")
}
```

<div style="height: 15px; background-color: transparent;"></div>

<p>
  Si desea visualizar el archivo completo directamente, puede hacerlo desde el siguiente visor incrustado o abrirlo en una nueva pesta帽a:
</p>

```{r, echo=FALSE, results='asis'}
cat(glue::glue('
<iframe src="{ruta_his_Size_relativa}" width="100%" height="500px" style="border: 1px solid #ccc; border-radius: 6px;"></iframe>

<p style="text-align:center;">
  <a href="{ruta_his_Size_relativa}" target="_blank" class="boton-iframe">
     Ver matriz completa de longitud gen茅tica en una nueva p谩gina
  </a>
</p>
\n\n'))
```








<div style="height: 20px; background-color: transparent;"></div>

<div class="titulo2" id="tab3-seccion4.3">
  4.3. Exploraci贸n preliminar de los recuentos crudos
</div>

<p>
  Antes de aplicar t茅cnicas de normalizaci贸n y an谩lisis estad铆stico, es fundamental realizar una inspecci贸n preliminar de los recuentos de expresi贸n obtenidos.
  Esta exploraci贸n tiene como objetivo identificar posibles anomal铆as, evaluar la distribuci贸n global de los datos y comprobar la consistencia entre las muestras.
</p>

<p>
  A partir del archivo <code>his-ReadCount.tab</code>, que contiene la matriz de expresi贸n no normalizada, se llevan a cabo diversos an谩lisis exploratorios que permiten:
</p>

<ul>
  <li>Calcular el n煤mero total de lecturas asignadas a cada muestra.</li>
  <li>Determinar el n煤mero de genes expresados por muestra.</li>
  <li>Identificar los genes con mayor nivel de expresi贸n.</li>
  <li>Visualizar la distribuci贸n general de los recuentos por gen y por muestra.</li>
</ul>

<p>
  Estas m茅tricas y visualizaciones proporcionan una primera impresi贸n sobre la calidad del conjunto de datos y permiten anticipar posibles fuentes de variabilidad que puedan influir en los resultados del an谩lisis de expresi贸n diferencial.
</p>






<div style="height: 10px; background-color: transparent;"></div>

<div class="titulo3" id="tab3-seccion4.3.1">
  4.3.1. Total de lecturas asignadas por muestra
</div>

<p>
  Para comenzar la exploraci贸n de los recuentos, se calcula el n煤mero total de lecturas asignadas a cada muestra. 
  Este valor corresponde a la suma de todos los recuentos por muestra y proporciona una primera aproximaci贸n sobre la profundidad de secuenciaci贸n obtenida en el experimento.
</p>

<p>
  A continuaci贸n, se muestra una tabla con los totales de lectura por muestra, seguida de una visualizaci贸n interactiva en forma de gr谩fico de barras, que permite comparar la profundidad de secuenciaci贸n entre condiciones y r茅plicas.
</p>

```{r}
library(DT)
library(ggplot2)
library(plotly)
library(dplyr)
library(stringr)
library(scales)
library(tidyverse)
library(tidyr)
library(tibble)

# Calcular n煤mero total de lecturas asignadas por muestra
total_recuentos_por_muestra <- colSums(his_ReadCount)

total_recuentos_por_muestra_df <- data.frame(
  Muestra = names(total_recuentos_por_muestra),
  TotalRecuentos = as.integer(total_recuentos_por_muestra)
)


# Convertir a data frame para ggplot2
df_total <- data.frame(
  muestra = names(total_recuentos_por_muestra),
  total_lecturas = as.integer(total_recuentos_por_muestra)
)

# Asegurarnos que 'targets' est谩 cargado previamente
targets_experimento <- paste0("targets_", params$nombre_experimento, ".txt")
ruta_targets_experimento <- file.path(params$ruta_proyecto, "Resultados", targets_experimento)
ruta_targets_experimento_relativa <- file.path(ruta_proyecto_relativa, "Resultados", targets_experimento)
targets <- read.table(ruta_targets_experimento, header = TRUE, fill = TRUE, stringsAsFactors = FALSE)

# Limpiar y unir condici贸n
df_total$muestra <- str_remove(df_total$muestra, "_nat$")
df_total <- df_total %>%
  left_join(targets %>% select(Filename, Type), by = c("muestra" = "Filename")) %>%
  rename(condicion = Type) %>%
  select(muestra, condicion, total_lecturas) %>%
  arrange(desc(total_lecturas))

# Mostrar tabla interactiva con DT
htmltools::div(
  class = "scroll-y-max-500",
  DT::datatable(
    df_total,
    options = list(
      scrollX = TRUE,
      paging = FALSE,
      lengthChange = FALSE,
      language = list(
        url = '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
      )
    ),
    class = 'stripe hover compact',
  )
)
```

<div style="height: 15px; background-color: transparent;"></div>

<div class="plot-center">

```{r}
# Gr谩fico de n煤mero total de lecturas por muestra con plotly
plot_ly(
  data = df_total,
  x = ~muestra,
  y = ~total_lecturas,
  type = "bar",
  color = ~condicion,
  colors = "Set2",
  text = ~comma(total_lecturas),
  textposition = "outside",
  hoverinfo = "text",
  hovertext = ~paste0("Muestra: ", muestra, "<br>Lecturas: ", comma(total_lecturas))
) %>%
  layout(
    title = "Total de lecturas por muestra",
    xaxis = list(title = "Muestra", tickangle = -45, tickfont = list(size = 10)),
    yaxis = list(
      title = "N煤mero de lecturas",
      range = c(0, max(df_total$total_lecturas) * 1.15)
    ),
    legend = list(
      orientation = "h",
      x = 0.5,
      y = -0.5,
      xanchor = "center"
    ),
    margin = list(t = 100, b = 170),
    autosize = TRUE
  )
```

</div>






<div style="height: 10px; background-color: transparent;"></div>

<div class="titulo3" id="tab3-seccion4.3.2">
  4.3.2. N煤mero de genes expresados por muestra
</div>

<p>
  Tras analizar la profundidad de secuenciaci贸n, el siguiente paso consiste en evaluar cu谩ntos genes se detectaron como expresados en cada muestra.
  Para ello, se considera un gen como expresado si presenta un recuento mayor que cero en una muestra determinada.
</p>

<p>
  Este an谩lisis permite identificar posibles muestras con baja calidad o problemas t茅cnicos, ya que un n煤mero at铆picamente bajo de genes expresados
  podr铆a indicar una eficiencia deficiente en la captura o amplificaci贸n del RNA.
</p>

<p>
  A continuaci贸n se presenta una tabla con el n煤mero de genes expresados por muestra, seguida de una visualizaci贸n gr谩fica que facilita la comparaci贸n entre condiciones experimentales.
</p>

```{r}
# Calcular n煤mero de genes expresados por muestra (genes con recuentos > 0)
genes_expresados_por_muestra <- colSums(his_ReadCount > 0)

genes_expresados_por_muestra_df <- data.frame(
  Muestra = names(genes_expresados_por_muestra),
  GenesExpresados = as.integer(genes_expresados_por_muestra)
)


# Crear data frame
df_genes_exp <- data.frame(
  muestra = names(genes_expresados_por_muestra),
  genes_expresados = as.integer(genes_expresados_por_muestra)
)

# A帽adir la columna 'condicion' uniendo por el nombre de muestra
df_genes_exp$muestra <- str_remove(df_genes_exp$muestra, "_nat$")
df_genes_exp <- df_genes_exp %>%
  left_join(targets %>% select(Filename, Type), by = c("muestra" = "Filename")) %>%
  rename(condicion = Type) %>%
  select(muestra, condicion, genes_expresados) %>%
  arrange(desc(genes_expresados))

# Mostrar tabla interactiva con DT
htmltools::div(
  class = "scroll-y-max-500",
  DT::datatable(
    df_genes_exp,
    options = list(
      scrollX = TRUE,
      paging = FALSE,
      lengthChange = FALSE,
      language = list(
        url = '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
      )
    ),
    class = 'stripe hover compact',
  )
)
```

<div style="height: 15px; background-color: transparent;"></div>

<div class="plot-center">

```{r}
# Gr谩fico: genes expresados por muestra (>0) con plotly
plot_ly(
  data = df_genes_exp,
  x = ~muestra,
  y = ~genes_expresados,
  type = "bar",
  color = ~condicion,
  colors = "Set2",  # mismo estilo que ggplot (Set1)
  text = ~comma(genes_expresados),
  textposition = "outside",
  hoverinfo = "text",
  hovertext = ~paste0("Muestra: ", muestra, "<br>Genes expresados: ", comma(genes_expresados))
) %>%
  layout(
    title = "N煤mero de genes expresados por muestra",
    xaxis = list(
      title = "Muestra",
      tickangle = -45,
      tickfont = list(size = 10)
    ),
    yaxis = list(
      title = "Genes con recuentos > 0",
      range = c(0, max(df_genes_exp$genes_expresados) * 1.15),
      separatethousands = TRUE
    ),
    legend = list(
      orientation = "h",
      x = 0.5,
      y = -0.52,
      xanchor = "center"
    ),
    margin = list(t = 100, b = 170),
    autosize = TRUE
  )
```

</div>






<div style="height: 10px; background-color: transparent;"></div>

<div class="titulo3" id="tab3-seccion4.3.3">
  4.3.3. Genes con mayor nivel de expresi贸n total
</div>

<p>
  Para identificar los genes con mayor actividad transcripcional dentro del conjunto de datos, se calcula la suma total de recuentos por gen a lo largo de todas las muestras.
  Esta m茅trica permite detectar aquellos genes que presentan los niveles de expresi贸n m谩s altos de forma global, y que podr铆an desempe帽ar un papel relevante en el contexto biol贸gico del experimento.
</p>

<p>
  A continuaci贸n se muestran los genes ordenados seg煤n su mayor expresi贸n acumulada, de forma descendente seg煤n su n煤mero total de lecturas.
  Esta tabla est谩 acompa帽ada por una visualizaci贸n interactiva que permite apreciar mejor la magnitud relativa de cada uno de estos genes altamente expresados, centr谩ndonos en este caso en los 20 primeros.
</p>

```{r}
# Obtener los genes con mayor nivel de expresi贸n total (suma por fila)
top_genes<- rowSums(his_ReadCount) |>
  sort(decreasing = TRUE)

top_genes_df <- data.frame(
  Gen = names(top_genes),
  TotalRecuentos = as.integer(top_genes)
)

top_genes_20 <- rowSums(his_ReadCount) |>
  sort(decreasing = TRUE) |>
  head(20)

top_genes_20_df <- data.frame(
  Gen = names(top_genes_20),
  TotalRecuentos = as.integer(top_genes_20)
)


# Crear la tabla interactiva
htmltools::div(
  class = "scroll-y-max-500",
  DT::datatable(
    top_genes_df,
    options = list(
      scrollX = TRUE,
      paging = FALSE,
      lengthChange = FALSE,
      language = list(
        url = '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
      )
    ),
    class = 'stripe hover compact',
  )
)
```

<div style="height: 15px; background-color: transparent;"></div>

<div class="plot-center">

```{r}
# Ordenar los genes de forma descendente para el gr谩fico
top_genes_20_df$Gen <- factor(top_genes_20_df$Gen, levels = rev(top_genes_20_df$Gen))

# Gr谩fico: top 20 genes m谩s expresados con plotly (horizontal)
plot_ly(
  data = top_genes_20_df,
  x = ~TotalRecuentos,
  y = ~Gen,
  type = "bar",
  orientation = "h",
  marker = list(
    color = "#098",
    line = list(color = "black", width = 1)
  ),
  text = ~comma(TotalRecuentos),
  textposition = "outside",
  hoverinfo = "text",
  hovertext = ~paste0("Gen: ", Gen, "<br>Recuentos: ", comma(TotalRecuentos))
) %>%
  layout(
    title = "Top 20 genes m谩s expresados",
    xaxis = list(
      title = "Recuentos totales",
      range = c(0, max(top_genes_20_df$TotalRecuentos) * 1.2),
      separatethousands = TRUE
    ),
    yaxis = list(
      title = "Gen",
      automargin = TRUE,
      tickfont = list(size = 10)
    ),
    margin = list(l = 100, t = 80, r = 40),
    autosize = TRUE
  )
```

</div>






<div style="height: 10px; background-color: transparent;"></div>

<div class="titulo3" id="tab3-seccion4.3.4">
  4.3.4. Distribuci贸n de recuentos por muestra (boxplot log10)
</div>

<p>
  Para evaluar la variabilidad y la distribuci贸n de los recuentos de expresi贸n a nivel gen贸mico en cada muestra, se genera un gr谩fico de cajas (boxplot) usando una transformaci贸n logar铆tmica (log10).
  Esta representaci贸n permite identificar posibles valores at铆picos, diferencias en la dispersi贸n de los datos y comprobar la homogeneidad entre r茅plicas y condiciones experimentales.
</p>

<p>
  Se excluyen los valores cero para evitar problemas con la transformaci贸n logar铆tmica, y se utiliza una visualizaci贸n interactiva que facilita la exploraci贸n detallada de la distribuci贸n en cada muestra.
</p>

<div style="height: 15px; background-color: transparent;"></div>

```{r}
# Convertir a formato largo
his_ReadCount_long <- his_ReadCount |>
  rownames_to_column("gene") |>
  pivot_longer(-gene, names_to = "muestra", values_to = "recuento")

# Filtrar recuentos mayores que cero antes de graficar
his_ReadCount_long_filtrado <- his_ReadCount_long |>
  filter(recuento > 0)

# Hacer el left join con targets para a帽adir la columna 'Type' como 'condicion'
his_ReadCount_long_filtrado <- his_ReadCount_long_filtrado %>%
  mutate(muestra_clean = str_remove(muestra, "_nat$")) %>%
  select(-muestra) %>%
  rename(muestra = muestra_clean) %>%
  left_join(targets %>% select(Filename, Type), by = c("muestra" = "Filename")) %>%
  rename(condicion = Type)
```

<div class="plot-center">

```{r}
# Gr谩fico: distribuci贸n logar铆tmica de recuentos por muestra (boxplot)
plot_ly(
  data = his_ReadCount_long_filtrado,
  x = ~muestra,
  y = ~recuento,
  color = ~condicion,
  colors = "Set2",
  type = "box",
  boxpoints = "outliers",
  marker = list(size = 3, opacity = 0.5, line = list(width = 0)),
  line = list(color = "black"),
  opacity = 0.8
) %>%
  layout(
    title = list(
      text = "Distribuci贸n logar铆tmica de recuentos por muestra<br><sub>Cada boxplot representa los niveles de expresi贸n g茅nica (log10) por muestra</sub>",
      y = 0.95
    ),
    xaxis = list(
      title = "Muestra",
      tickangle = -45,
      tickfont = list(size = 10)
    ),
    yaxis = list(
      title = "Recuento (log10)",
      type = "log",
      separatethousands = TRUE
    ),
    legend = list(
      orientation = "h",
      x = 0.5,
      y = -0.52,
      xanchor = "center"
    ),
    margin = list(t = 100, b = 170),
    autosize = TRUE
  )
```

</div>

<div style="height: 5px; background-color: transparent;"></div>

---

<p>
  Tras esta <strong>exploraci贸n preliminar de los recuentos de expresi贸n g茅nica</strong>, en la que se han examinado aspectos clave como el total de lecturas asignadas, la distribuci贸n de los genes expresados y la expresi贸n global por muestra, el siguiente paso ser谩 aplicar un <em>proceso de normalizaci贸n</em> que permita comparar las muestras de forma justa y reducir los posibles sesgos t茅cnicos. A continuaci贸n, se llevar谩 a cabo un <strong>an谩lisis estad铆stico de la expresi贸n g茅nica</strong>, que incluir谩 la <em>evaluaci贸n de la calidad post-normalizaci贸n</em>, la identificaci贸n de <strong>genes diferencialmente expresados</strong> y la realizaci贸n de un <em>an谩lisis funcional y de enriquecimiento</em> para interpretar los resultados en el contexto biol贸gico correspondiente.
</p>
